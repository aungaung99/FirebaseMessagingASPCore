import{_registerComponent,registerVersion,_getProvider,getApp,_removeServiceInstance,SDK_VERSION}from"https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";const stringToByteArray$1=function(n){const r=[];let s=0;for(let e=0;e<n.length;e++){let t=n.charCodeAt(e);t<128?r[s++]=t:(t<2048?r[s++]=t>>6|192:(55296==(64512&t)&&e+1<n.length&&56320==(64512&n.charCodeAt(e+1))?(t=65536+((1023&t)<<10)+(1023&n.charCodeAt(++e)),r[s++]=t>>18|240,r[s++]=t>>12&63|128):r[s++]=t>>12|224,r[s++]=t>>6&63|128),r[s++]=63&t|128)}return r},byteArrayToString=function(t){const e=[];let n=0,r=0;for(;n<t.length;){var s,i,o=t[n++];o<128?e[r++]=String.fromCharCode(o):191<o&&o<224?(s=t[n++],e[r++]=String.fromCharCode((31&o)<<6|63&s)):239<o&&o<365?(i=((7&o)<<18|(63&t[n++])<<12|(63&t[n++])<<6|63&t[n++])-65536,e[r++]=String.fromCharCode(55296+(i>>10)),e[r++]=String.fromCharCode(56320+(1023&i))):(s=t[n++],i=t[n++],e[r++]=String.fromCharCode((15&o)<<12|(63&s)<<6|63&i))}return e.join("")},base64={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(r,t){if(!Array.isArray(r))throw Error("encodeByteArray takes an array as a parameter");this.init_();var s=t?this.byteToCharMapWebSafe_:this.byteToCharMap_;const i=[];for(let n=0;n<r.length;n+=3){var o=r[n],a=n+1<r.length,c=a?r[n+1]:0,u=n+2<r.length,h=u?r[n+2]:0;let t=(15&c)<<2|h>>6,e=63&h;u||(e=64,a||(t=64)),i.push(s[o>>2],s[(3&o)<<4|c>>4],s[t],s[e])}return i.join("")},encodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(stringToByteArray$1(t),e)},decodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):byteArrayToString(this.decodeStringToByteArray(t,e))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let t=0;t<e.length;){var s=n[e.charAt(t++)],i=t<e.length?n[e.charAt(t)]:0;++t;var o=t<e.length?n[e.charAt(t)]:64;++t;var a=t<e.length?n[e.charAt(t)]:64;if(++t,null==s||null==i||null==o||null==a)throw Error();r.push(s<<2|i>>4),64!==o&&(r.push(i<<4&240|o>>2),64!==a&&r.push(o<<6&192|a))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t,t>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}},base64Encode=function(t){t=stringToByteArray$1(t);return base64.encodeByteArray(t,!0)},base64urlEncodeWithoutPadding=function(t){return base64Encode(t).replace(/\./g,"")};function createMockUserToken(t,e){if(t.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=e||"demo-project",r=t.iat||0,e=t.sub||t.user_id;if(!e)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");t=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:e,user_id:e,firebase:{sign_in_provider:"custom",identities:{}}},t);return[base64urlEncodeWithoutPadding(JSON.stringify({alg:"none",type:"JWT"})),base64urlEncodeWithoutPadding(JSON.stringify(t)),""].join(".")}function getUA(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function isMobileCordova(){return"undefined"!=typeof window&&!!(window.cordova||window.phonegap||window.PhoneGap)&&/ios|iphone|ipod|ipad|android|blackberry|iemobile/i.test(getUA())}function isNode(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(t){return!1}}function isBrowserExtension(){var t="object"==typeof chrome?chrome.runtime:"object"==typeof browser?browser.runtime:void 0;return"object"==typeof t&&void 0!==t.id}function isReactNative(){return"object"==typeof navigator&&"ReactNative"===navigator.product}function isElectron(){return 0<=getUA().indexOf("Electron/")}function isIE(){const t=getUA();return 0<=t.indexOf("MSIE ")||0<=t.indexOf("Trident/")}function isUWP(){return 0<=getUA().indexOf("MSAppHost/")}function isSafari(){return!isNode()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function isIndexedDBAvailable(){return"object"==typeof indexedDB}const ERROR_NAME="FirebaseError";class FirebaseError extends Error{constructor(t,e,n){super(e),this.code=t,this.customData=n,this.name=ERROR_NAME,Object.setPrototypeOf(this,FirebaseError.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,ErrorFactory.prototype.create)}}class ErrorFactory{constructor(t,e,n){this.service=t,this.serviceName=e,this.errors=n}create(t,...e){var n=e[0]||{},e=`${this.service}/${t}`,t=this.errors[t],t=t?replaceTemplate(t,n):"Error",t=`${this.serviceName}: ${t} (${e}).`;return new FirebaseError(e,t,n)}}function replaceTemplate(t,r){return t.replace(PATTERN,(t,e)=>{var n=r[e];return null!=n?String(n):`<${e}?>`})}const PATTERN=/\{\$([^}]+)}/g;function deepEqual(t,e){if(t===e)return!0;const n=Object.keys(t),r=Object.keys(e);for(const o of n){if(!r.includes(o))return!1;var s=t[o],i=e[o];if(isObject(s)&&isObject(i)){if(!deepEqual(s,i))return!1}else if(s!==i)return!1}for(const a of r)if(!n.includes(a))return!1;return!0}function isObject(t){return null!==t&&"object"==typeof t}function getModularInstance(t){return t&&t._delegate?t._delegate:t}class Component{constructor(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}var LogLevel;!function(t){t[t.DEBUG=0]="DEBUG",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.SILENT=5]="SILENT"}(LogLevel=LogLevel||{});const levelStringToEnum={debug:LogLevel.DEBUG,verbose:LogLevel.VERBOSE,info:LogLevel.INFO,warn:LogLevel.WARN,error:LogLevel.ERROR,silent:LogLevel.SILENT},defaultLogLevel=LogLevel.INFO,ConsoleMethod={[LogLevel.DEBUG]:"log",[LogLevel.VERBOSE]:"log",[LogLevel.INFO]:"info",[LogLevel.WARN]:"warn",[LogLevel.ERROR]:"error"},defaultLogHandler=(t,e,...n)=>{if(!(e<t.logLevel)){var r=(new Date).toISOString(),s=ConsoleMethod[e];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`);console[s](`[${r}]  ${t.name}:`,...n)}};class Logger{constructor(t){this.name=t,this._logLevel=defaultLogLevel,this._logHandler=defaultLogHandler,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in LogLevel))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel="string"==typeof t?levelStringToEnum[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,LogLevel.DEBUG,...t),this._logHandler(this,LogLevel.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,LogLevel.VERBOSE,...t),this._logHandler(this,LogLevel.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,LogLevel.INFO,...t),this._logHandler(this,LogLevel.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,LogLevel.WARN,...t),this._logHandler(this,LogLevel.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,LogLevel.ERROR,...t),this._logHandler(this,LogLevel.ERROR,...t)}}var k$1,commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},goog=goog||{},l=commonjsGlobal||self;function aa$1(){}function ba$1(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function p(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}function da$1(t){return Object.prototype.hasOwnProperty.call(t,ea$1)&&t[ea$1]||(t[ea$1]=++fa$1)}var ea$1="closure_uid_"+(1e9*Math.random()>>>0),fa$1=0;function ha$1(t,e,n){return t.call.apply(t.bind,arguments)}function ia$1(e,n,t){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var t=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(t,r),e.apply(n,t)}}return function(){return e.apply(n,arguments)}}function q$1(t,e,n){return(q$1=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?ha$1:ia$1).apply(null,arguments)}function ja$1(e,t){var n=Array.prototype.slice.call(arguments,1);return function(){var t=n.slice();return t.push.apply(t,arguments),e.apply(this,t)}}function t(t,i){function e(){}e.prototype=i.prototype,t.Z=i.prototype,t.prototype=new e,(t.prototype.constructor=t).Vb=function(t,e,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[e].apply(t,r)}}function v(){this.s=this.s,this.o=this.o}var ka$1=0,la$1={};v.prototype.s=!1,v.prototype.na=function(){var t;this.s||(this.s=!0,this.M(),0==ka$1)||(t=da$1(this),delete la$1[t])},v.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const ma$1=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(e,n){if("string"==typeof e)return"string"!=typeof n||1!=n.length?-1:e.indexOf(n,0);for(let t=0;t<e.length;t++)if(t in e&&e[t]===n)return t;return-1},na$1=Array.prototype.forEach?function(t,e,n){Array.prototype.forEach.call(t,e,n)}:function(e,n,r){var s=e.length,i="string"==typeof e?e.split(""):e;for(let t=0;t<s;t++)t in i&&n.call(r,i[t],t,e)};function oa$1(e){t:{var n=pa$1,r=e.length,s="string"==typeof e?e.split(""):e;for(let t=0;t<r;t++)if(t in s&&n.call(void 0,s[t],t,e)){n=t;break t}n=-1}return n<0?null:"string"==typeof e?e.charAt(n):e[n]}function qa$1(t){return Array.prototype.concat.apply([],arguments)}function ra$1(e){var n=e.length;if(0<n){const r=Array(n);for(let t=0;t<n;t++)r[t]=e[t];return r}return[]}function sa$1(t){return/^[\s\xa0]*$/.test(t)}var x$1,ta$1=String.prototype.trim?function(t){return t.trim()}:function(t){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(t)[1]};function w(t,e){return-1!=t.indexOf(e)}function ua$1(t,e){return t<e?-1:e<t?1:0}t:{var va$1=l.navigator;if(va$1){var wa$1=va$1.userAgent;if(wa$1){x$1=wa$1;break t}}x$1=""}function xa$1(t,e,n){for(const r in t)e.call(n,t[r],r,t)}function ya$1(t){const e={};for(const n in t)e[n]=t[n];return e}var za$1="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Aa$1(e,t){let n,r;for(let t=1;t<arguments.length;t++){for(n in r=arguments[t])e[n]=r[n];for(let t=0;t<za$1.length;t++)n=za$1[t],Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}}function Ca$1(t){return Ca$1[" "](t),t}function Fa$1(t){var e=Ga$1;return Object.prototype.hasOwnProperty.call(e,9)?e[9]:e[9]=t(9)}Ca$1[" "]=aa$1;var Na$1,Ha$1=w(x$1,"Opera"),y=w(x$1,"Trident")||w(x$1,"MSIE"),Ia$1=w(x$1,"Edge"),Ja$1=Ia$1||y,Ka$1=w(x$1,"Gecko")&&!(w(x$1.toLowerCase(),"webkit")&&!w(x$1,"Edge"))&&!(w(x$1,"Trident")||w(x$1,"MSIE"))&&!w(x$1,"Edge"),La$1=w(x$1.toLowerCase(),"webkit")&&!w(x$1,"Edge");function Ma$1(){var t=l.document;return t?t.documentMode:void 0}t:{var Oa$1="",Pa$1=function(){var t=x$1;return Ka$1?/rv:([^\);]+)(\)|;)/.exec(t):Ia$1?/Edge\/([\d\.]+)/.exec(t):y?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(t):La$1?/WebKit\/(\S+)/.exec(t):Ha$1?/(?:Version)[ \/]?(\S+)/.exec(t):void 0}();if(Pa$1&&(Oa$1=Pa$1?Pa$1[1]:""),y){var Qa$1=Ma$1();if(null!=Qa$1&&Qa$1>parseFloat(Oa$1)){Na$1=String(Qa$1);break t}}Na$1=Oa$1}var Ta$1,Sa$1,Ga$1={};function Ra$1(){return Fa$1(function(){let e=0;var n=ta$1(String(Na$1)).split("."),r=ta$1("9").split("."),s=Math.max(n.length,r.length);for(let t=0;0==e&&t<s;t++)for(var i=n[t]||"",o=r[t]||"";i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],o=/(\d*)(\D*)(.*)/.exec(o)||["","","",""],(0!=i[0].length||0!=o[0].length)&&(e=ua$1(0==i[1].length?0:parseInt(i[1],10),0==o[1].length?0:parseInt(o[1],10))||ua$1(0==i[2].length,0==o[2].length)||ua$1(i[2],o[2]),i=i[3],o=o[3],0==e););return 0<=e})}var Ua$1=Sa$1=l.document&&y?(Ta$1=Ma$1())||parseInt(Na$1,10)||void 0:void 0,Va$1=function(){if(!l.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{l.addEventListener("test",aa$1,e),l.removeEventListener("test",aa$1,e)}catch(t){}return t}();function z$1(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}function A(t,e){if(z$1.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(Ka$1){t:{try{Ca$1(e.nodeName);var s=!0;break t}catch(t){}s=!1}s||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:Wa$1[t.pointerType]||"",this.state=t.state,(this.i=t).defaultPrevented&&A.Z.h.call(this)}}z$1.prototype.h=function(){this.defaultPrevented=!0},t(A,z$1);var Wa$1={2:"touch",3:"pen",4:"mouse"};A.prototype.h=function(){A.Z.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var B$1="closure_listenable_"+(1e6*Math.random()|0),Xa$1=0;function Ya$1(t,e,n,r,s){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.ia=s,this.key=++Xa$1,this.ca=this.fa=!1}function Za$1(t){t.ca=!0,t.listener=null,t.proxy=null,t.src=null,t.ia=null}function $a$1(t){this.src=t,this.g={},this.h=0}function bb(t,e){var n,r,s,i=e.type;i in t.g&&(n=t.g[i],(s=0<=(r=ma$1(n,e)))&&Array.prototype.splice.call(n,r,1),s&&(Za$1(e),0==t.g[i].length&&(delete t.g[i],t.h--)))}function ab(t,e,n,r){for(var s=0;s<t.length;++s){var i=t[s];if(!i.ca&&i.listener==e&&i.capture==!!n&&i.ia==r)return s}return-1}$a$1.prototype.add=function(t,e,n,r,s){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=ab(t,e,r,s);return-1<o?(e=t[o],n||(e.fa=!1)):((e=new Ya$1(e,this.src,i,!!r,s)).fa=n,t.push(e)),e};var cb="closure_lm_"+(1e6*Math.random()|0),db={};function fb(t,e,n,r,s){if(r&&r.once)return gb(t,e,n,r,s);if(Array.isArray(e)){for(var i=0;i<e.length;i++)fb(t,e[i],n,r,s);return null}return n=hb(n),t&&t[B$1]?t.N(e,n,p(r)?!!r.capture:!!r,s):ib(t,e,n,!1,r,s)}function ib(t,e,n,r,s,i){if(!e)throw Error("Invalid event type");var o=p(s)?!!s.capture:!!s,a=jb(t);if(a||(t[cb]=a=new $a$1(t)),(n=a.add(e,n,r,o,i)).proxy)return n;if(r=kb(),(n.proxy=r).src=t,r.listener=n,t.addEventListener)void 0===(s=!Va$1?o:s)&&(s=!1),t.addEventListener(e.toString(),r,s);else if(t.attachEvent)t.attachEvent(lb(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function kb(){var n=mb;return function t(e){return n.call(t.src,t.listener,e)}}function gb(t,e,n,r,s){if(Array.isArray(e)){for(var i=0;i<e.length;i++)gb(t,e[i],n,r,s);return null}return n=hb(n),t&&t[B$1]?t.O(e,n,p(r)?!!r.capture:!!r,s):ib(t,e,n,!0,r,s)}function nb(t,e,n,r,s){if(Array.isArray(e))for(var i=0;i<e.length;i++)nb(t,e[i],n,r,s);else r=p(r)?!!r.capture:!!r,n=hb(n),t&&t[B$1]?(t=t.i,(e=String(e).toString())in t.g&&(-1<(n=ab(i=t.g[e],n,r,s))&&(Za$1(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--)))):(t=t&&jb(t))&&(e=t.g[e.toString()],(n=(t=-1)<(t=e?ab(e,n,r,s):t)?e[t]:null)&&ob(n))}function ob(t){var e,n,r;"number"!=typeof t&&t&&!t.ca&&((e=t.src)&&e[B$1]?bb(e.i,t):(n=t.type,r=t.proxy,e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(lb(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=jb(e))?(bb(n,t),0==n.h&&(n.src=null,e[cb]=null)):Za$1(t)))}function lb(t){return t in db?db[t]:db[t]="on"+t}function mb(t,e){var n,r;return t=!!t.ca||(e=new A(e,this),n=t.listener,r=t.ia||t.src,t.fa&&ob(t),n.call(r,e))}function jb(t){return(t=t[cb])instanceof $a$1?t:null}var pb="__closure_events_fn_"+(1e9*Math.random()>>>0);function hb(e){return"function"==typeof e?e:(e[pb]||(e[pb]=function(t){return e.handleEvent(t)}),e[pb])}function C$1(){v.call(this),this.i=new $a$1(this),(this.P=this).I=null}function D$1(t,e){var n,r=t.I;if(r)for(n=[];r;r=r.I)n.push(r);if(t=t.P,r=e.type||e,"string"==typeof e?e=new z$1(e,t):e instanceof z$1?e.target=e.target||t:(o=e,Aa$1(e=new z$1(r,t),o)),o=!0,n)for(var s=n.length-1;0<=s;s--)var i=e.g=n[s],o=qb(i,r,!0,e)&&o;if(o=qb(i=e.g=t,r,!0,e)&&o,o=qb(i,r,!1,e)&&o,n)for(s=0;s<n.length;s++)o=qb(i=e.g=n[s],r,!1,e)&&o}function qb(t,e,n,r){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var s=!0,i=0;i<e.length;++i){var o,a,c=e[i];c&&!c.ca&&c.capture==n&&(o=c.listener,a=c.ia||c.src,c.fa&&bb(t.i,c),s=!1!==o.call(a,r)&&s)}return s&&!r.defaultPrevented}t(C$1,v),C$1.prototype[B$1]=!0,C$1.prototype.removeEventListener=function(t,e,n,r){nb(this,t,e,n,r)},C$1.prototype.M=function(){if(C$1.Z.M.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],r=0;r<n.length;r++)Za$1(n[r]);delete e.g[t],e.h--}}this.I=null},C$1.prototype.N=function(t,e,n,r){return this.i.add(String(t),e,!1,n,r)},C$1.prototype.O=function(t,e,n,r){return this.i.add(String(t),e,!0,n,r)};var rb=l.JSON.stringify;function sb(){var t=tb;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}class ub{constructor(){this.h=this.g=null}add(t,e){const n=vb.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}}var Ab,vb=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}(()=>new wb,t=>t.reset());class wb{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function yb(t){l.setTimeout(()=>{throw t},0)}function zb(t,e){Ab||Bb(),Cb||(Ab(),Cb=!0),tb.add(t,e)}function Bb(){var t=l.Promise.resolve(void 0);Ab=function(){t.then(Db)}}var Cb=!1,tb=new ub;function Db(){for(var t;t=sb();){try{t.h.call(t.g)}catch(t){yb(t)}var e=vb;e.j(t),e.h<100&&(e.h++,t.next=e.g,e.g=t)}Cb=!1}function Eb(t,e){C$1.call(this),this.h=t||1,this.g=e||l,this.j=q$1(this.kb,this),this.l=Date.now()}function Fb(t){t.da=!1,t.S&&(t.g.clearTimeout(t.S),t.S=null)}function Gb(t,e,n){if("function"==typeof t)n&&(t=q$1(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=q$1(t.handleEvent,t)}return 2147483647<Number(e)?-1:l.setTimeout(t,e||0)}function Hb(t){t.g=Gb(()=>{t.g=null,t.i&&(t.i=!1,Hb(t))},t.j);var e=t.h;t.h=null,t.m.apply(null,e)}t(Eb,C$1),(k$1=Eb.prototype).da=!1,k$1.S=null,k$1.kb=function(){var t;this.da&&(0<(t=Date.now()-this.l)&&t<.8*this.h?this.S=this.g.setTimeout(this.j,this.h-t):(this.S&&(this.g.clearTimeout(this.S),this.S=null),D$1(this,"tick"),this.da&&(Fb(this),this.start())))},k$1.start=function(){this.da=!0,this.S||(this.S=this.g.setTimeout(this.j,this.h),this.l=Date.now())},k$1.M=function(){Eb.Z.M.call(this),Fb(this),delete this.g};class Ib extends v{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:Hb(this)}M(){super.M(),this.g&&(l.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function E(t){v.call(this),this.h=t,this.g={}}t(E,v);var Jb=[];function Kb(t,e,n,r){Array.isArray(n)||(n&&(Jb[0]=n.toString()),n=Jb);for(var s=0;s<n.length;s++){var i=fb(e,n[s],r||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function Lb(t){xa$1(t.g,function(t,e){this.g.hasOwnProperty(e)&&ob(t)},t),t.g={}}function Mb(){this.g=!0}function Nb(o,a,c,u,h,l){o.info(function(){if(o.g)if(l)for(var t="",e=l.split("&"),n=0;n<e.length;n++){var r,s,i=e[n].split("=");1<i.length&&(r=i[0],i=i[1],t=2<=(s=r.split("_")).length&&"type"==s[1]?t+(r+"=")+i+"&":t+(r+"=redacted&"))}else t=null;else t=l;return"XMLHTTP REQ ("+u+") [attempt "+h+"]: "+a+"\n"+c+"\n"+t})}function Ob(t,e,n,r,s,i,o){t.info(function(){return"XMLHTTP RESP ("+r+") [ attempt "+s+"]: "+e+"\n"+n+"\n"+i+" "+o})}function F$1(t,e,n,r){t.info(function(){return"XMLHTTP TEXT ("+e+"): "+Pb(t,n)+(r?" "+r:"")})}function Qb(t,e){t.info(function(){return"TIMEOUT: "+e})}function Pb(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var r=n[t];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<s.length;o++)s[o]=""}}}return rb(n)}catch(t){return e}}E.prototype.M=function(){E.Z.M.call(this),Lb(this)},E.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Mb.prototype.Aa=function(){this.g=!1},Mb.prototype.info=function(){};var H$1={},Rb=null;function Sb(){return Rb=Rb||new C$1}function Tb(t){z$1.call(this,H$1.Ma,t)}function I(t){var e=Sb();D$1(e,new Tb(e,t))}function Ub(t,e){z$1.call(this,H$1.STAT_EVENT,t),this.stat=e}function J$1(t){var e=Sb();D$1(e,new Ub(e,t))}function Vb(t,e){z$1.call(this,H$1.Na,t),this.size=e}function K$1(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return l.setTimeout(function(){t()},e)}H$1.Ma="serverreachability",t(Tb,z$1),H$1.STAT_EVENT="statevent",t(Ub,z$1),H$1.Na="timingevent",t(Vb,z$1);var Wb={NO_ERROR:0,lb:1,yb:2,xb:3,sb:4,wb:5,zb:6,Ja:7,TIMEOUT:8,Cb:9},Xb={qb:"complete",Mb:"success",Ka:"error",Ja:"abort",Eb:"ready",Fb:"readystatechange",TIMEOUT:"timeout",Ab:"incrementaldata",Db:"progress",tb:"downloadprogress",Ub:"uploadprogress"};function Yb(){}function Zb(t){return t.h||(t.h=t.i())}function $b(){}Yb.prototype.h=null;var L$1={OPEN:"a",pb:"b",Ka:"c",Bb:"d"};function ac$1(){z$1.call(this,"d")}function bc$1(){z$1.call(this,"c")}function dc$1(){}function M$1(t,e,n,r){this.l=t,this.j=e,this.m=n,this.X=r||1,this.V=new E(this),this.P=ec$1,this.W=new Eb(t=Ja$1?125:void 0),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.Y=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.N=-1,this.I=!1,this.O=0,this.L=null,this.aa=this.J=this.$=this.U=!1,this.h=new fc$1}function fc$1(){this.i=null,this.g="",this.h=!1}t(ac$1,z$1),t(bc$1,z$1),t(dc$1,Yb),dc$1.prototype.g=function(){return new XMLHttpRequest},dc$1.prototype.i=function(){return{}};var cc$1=new dc$1,ec$1=45e3,gc$1={},hc$1={};function ic$1(t,e,n){t.K=1,t.v=jc$1(N$1(e)),t.s=n,t.U=!0,kc$1(t,null)}function kc$1(t,e){t.F=Date.now(),lc$1(t),t.A=N$1(t.v);var n=t.A,r=t.X;Array.isArray(r)||(r=[String(r)]),mc$1(n.h,"t",r),t.C=0,n=t.l.H,t.h=new fc$1,t.g=nc$1(t.l,n?e:null,!t.s),0<t.O&&(t.L=new Ib(q$1(t.Ia,t,t.g),t.O)),Kb(t.V,t.g,"readystatechange",t.gb),e=t.H?ya$1(t.H):{},t.s?(t.u||(t.u="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ea(t.A,t.u,t.s,e)):(t.u="GET",t.g.ea(t.A,t.u,null,e)),I(1),Nb(t.j,t.u,t.A,t.m,t.X,t.s)}function qc$1(t){return!!t.g&&("GET"==t.u&&2!=t.K&&t.l.Ba)}function tc$1(t,e,n){let r=!0,s;for(;!t.I&&t.C<n.length;){if(s=vc$1(t,n),s==hc$1){4==e&&(t.o=4,J$1(14),r=!1),F$1(t.j,t.m,null,"[Incomplete Response]");break}if(s==gc$1){t.o=4,J$1(15),F$1(t.j,t.m,n,"[Invalid Chunk]"),r=!1;break}F$1(t.j,t.m,s,null),sc$1(t,s)}qc$1(t)&&s!=hc$1&&s!=gc$1&&(t.h.g="",t.C=0),4!=e||0!=n.length||t.h.h||(t.o=1,J$1(16),r=!1),t.i=t.i&&r,r?0<n.length&&!t.aa&&(t.aa=!0,(e=t.l).g==t&&e.$&&!e.L&&(e.h.info("Great, no buffering proxy detected. Bytes received: "+n.length),wc$1(e),e.L=!0,J$1(11))):(F$1(t.j,t.m,n,"[Invalid Chunked Response]"),P(t),rc$1(t))}function vc$1(t,e){var n=t.C,r=e.indexOf("\n",n);return-1==r?hc$1:(n=Number(e.substring(n,r)),isNaN(n)?gc$1:(r+=1)+n>e.length?hc$1:(e=e.substr(r,n),t.C=r+n,e))}function lc$1(t){t.Y=Date.now()+t.P,xc$1(t,t.P)}function xc$1(t,e){if(null!=t.B)throw Error("WatchDog timer not null");t.B=K$1(q$1(t.eb,t),e)}function pc$1(t){t.B&&(l.clearTimeout(t.B),t.B=null)}function rc$1(t){0==t.l.G||t.I||uc$1(t.l,t)}function P(t){pc$1(t);var e=t.L;e&&"function"==typeof e.na&&e.na(),t.L=null,Fb(t.W),Lb(t.V),t.g&&(e=t.g,t.g=null,e.abort(),e.na())}function sc$1(t,e){try{var n=t.l;if(0!=n.G&&(n.g==t||yc$1(n.i,t)))if(n.I=t.N,!t.J&&yc$1(n.i,t)&&3==n.G){try{var r=n.Ca.g.parse(e)}catch(t){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){t:if(!n.u){if(n.g){if(!(n.g.F+3e3<t.F))break t;zc$1(n),Ac$1(n)}Bc$1(n),J$1(18)}}else n.ta=s[1],0<n.ta-n.U&&s[2]<37500&&n.N&&0==n.A&&!n.v&&(n.v=K$1(q$1(n.ab,n),6e3));if(Cc$1(n.i)<=1&&n.ka){try{n.ka()}catch(t){}n.ka=void 0}}else Q$1(n,11)}else if(!t.J&&n.g!=t||zc$1(n),!sa$1(e))for(s=n.Ca.g.parse(e),e=0;e<s.length;e++){var i=s[e];if(n.U=i[0],i=i[1],2==n.G)if("c"==i[0]){n.J=i[1],n.la=i[2];var o=i[3];null!=o&&(n.ma=o,n.h.info("VER="+n.ma));var a=i[4];null!=a&&(n.za=a,n.h.info("SVER="+n.za));var c,u,h,l=i[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.K=r,n.h.info("backChannelRequestTimeoutMs_="+r)),r=n;const m=t.g;m&&(!(c=m.g?m.g.getResponseHeader("X-Client-Wire-Protocol"):null)||!(u=r.i).g&&(w(c,"spdy")||w(c,"quic")||w(c,"h2"))&&(u.j=u.l,u.g=new Set,u.h&&(Dc$1(u,u.h),u.h=null)),!r.D||(h=m.g?m.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.sa=h,R(r.F,r.D,h))),n.G=3,n.j&&n.j.xa(),n.$&&(n.O=Date.now()-t.F,n.h.info("Handshake RTT: "+n.O+"ms"));var d,f,g=t;(r=n).oa=Ec$1(r,r.H?r.la:null,r.W),g.J?(Fc$1(r.i,g),d=g,(f=r.K)&&d.setTimeout(f),d.B&&(pc$1(d),lc$1(d)),r.g=g):Gc$1(r),0<n.l.length&&Hc$1(n)}else"stop"!=i[0]&&"close"!=i[0]||Q$1(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?Q$1(n,7):Ic$1(n):"noop"!=i[0]&&n.j&&n.j.wa(i),n.A=0)}I(4)}catch(t){}}function Jc$1(t){if(t.R&&"function"==typeof t.R)return t.R();if("string"==typeof t)return t.split("");if(ba$1(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}function Kc$1(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(ba$1(t)||"string"==typeof t)na$1(t,e,void 0);else{if(t.T&&"function"==typeof t.T)var n=t.T();else if(t.R&&"function"==typeof t.R)n=void 0;else if(ba$1(t)||"string"==typeof t)for(var n=[],r=t.length,s=0;s<r;s++)n.push(s);else for(s in n=[],r=0,t)n[r++]=s;for(var s=(r=Jc$1(t)).length,i=0;i<s;i++)e.call(void 0,r[i],n&&n[i],t)}}function S(t,e){this.h={},this.g=[],this.i=0;var n=arguments.length;if(1<n){if(n%2)throw Error("Uneven number of arguments");for(var r=0;r<n;r+=2)this.set(arguments[r],arguments[r+1])}else if(t)if(t instanceof S)for(n=t.T(),r=0;r<n.length;r++)this.set(n[r],t.get(n[r]));else for(r in t)this.set(r,t[r])}function Lc$1(t){if(t.i!=t.g.length){for(var e=0,n=0;e<t.g.length;){var r=t.g[e];T(t.h,r)&&(t.g[n++]=r),e++}t.g.length=n}if(t.i!=t.g.length){for(var s={},n=e=0;e<t.g.length;)T(s,r=t.g[e])||(s[t.g[n++]=r]=1),e++;t.g.length=n}}function T(t,e){return Object.prototype.hasOwnProperty.call(t,e)}(k$1=M$1.prototype).setTimeout=function(t){this.P=t},k$1.gb=function(t){t=t.target;const e=this.L;e&&3==O$1(t)?e.l():this.Ia(t)},k$1.Ia=function(t){try{if(t==this.g)t:{var e=O$1(this.g),n=this.g.Da(),r=this.g.ba();if(!(e<3)&&(3!=e||Ja$1||this.g&&(this.h.h||this.g.ga()||oc$1(this.g)))){this.I||4!=e||7==n||I(8==n||r<=0?3:2),pc$1(this);var s=this.g.ba();this.N=s;e:if(qc$1(this)){var i=oc$1(this.g);t="";var o=i.length,a=4==O$1(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){P(this),rc$1(this);var c="";break e}this.h.i=new l.TextDecoder}for(n=0;n<o;n++)this.h.h=!0,t+=this.h.i.decode(i[n],{stream:a&&n==o-1});i.splice(0,o),this.h.g+=t,this.C=0,c=this.h.g}else c=this.g.ga();if(this.i=200==s,Ob(this.j,this.u,this.A,this.m,this.X,e,s),this.i){if(this.$&&!this.J){e:{if(this.g){var u,h=this.g;if((u=h.g?h.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!sa$1(u)){var d=u;break e}}d=null}if(!(s=d)){this.i=!1,this.o=3,J$1(12),P(this),rc$1(this);break t}F$1(this.j,this.m,s,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,sc$1(this,s)}this.U?(tc$1(this,e,c),Ja$1&&this.i&&3==e&&(Kb(this.V,this.W,"tick",this.fb),this.W.start())):(F$1(this.j,this.m,c,null),sc$1(this,c)),4==e&&P(this),this.i&&!this.I&&(4==e?uc$1(this.l,this):(this.i=!1,lc$1(this)))}else 400==s&&0<c.indexOf("Unknown SID")?(this.o=3,J$1(12)):(this.o=0,J$1(13)),P(this),rc$1(this)}}}catch(t){}},k$1.fb=function(){var t,e;this.g&&(t=O$1(this.g),e=this.g.ga(),this.C<e.length&&(pc$1(this),tc$1(this,t,e),this.i&&4!=t&&lc$1(this)))},k$1.cancel=function(){this.I=!0,P(this)},k$1.eb=function(){this.B=null;var t=Date.now();0<=t-this.Y?(Qb(this.j,this.A),2!=this.K&&(I(3),J$1(17)),P(this),this.o=2,rc$1(this)):xc$1(this,this.Y-t)},(k$1=S.prototype).R=function(){Lc$1(this);for(var t=[],e=0;e<this.g.length;e++)t.push(this.h[this.g[e]]);return t},k$1.T=function(){return Lc$1(this),this.g.concat()},k$1.get=function(t,e){return T(this.h,t)?this.h[t]:e},k$1.set=function(t,e){T(this.h,t)||(this.i++,this.g.push(t)),this.h[t]=e},k$1.forEach=function(t,e){for(var n=this.T(),r=0;r<n.length;r++){var s=n[r],i=this.get(s);t.call(e,i,s,this)}};var Mc$1=/^(?:([^:/?#.]+):)?(?:\/\/(?:([^\\/?#]*)@)?([^\\/?#]*?)(?::([0-9]+))?(?=[\\/?#]|$))?([^?#]+)?(?:\?([^#]*))?(?:#([\s\S]*))?$/;function Nc$1(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r,s=t[n].indexOf("="),i=null;0<=s?(r=t[n].substring(0,s),i=t[n].substring(s+1)):r=t[n],e(r,i?decodeURIComponent(i.replace(/\+/g," ")):"")}}}function U$1(t,e){var n;this.i=this.s=this.j="",this.m=null,this.o=this.l="",this.g=!1,t instanceof U$1?(this.g=void 0!==e?e:t.g,Oc$1(this,t.j),this.s=t.s,Pc$1(this,t.i),Qc$1(this,t.m),this.l=t.l,e=t.h,(n=new Rc$1).i=e.i,e.g&&(n.g=new S(e.g),n.h=e.h),Sc$1(this,n),this.o=t.o):t&&(n=String(t).match(Mc$1))?(this.g=!!e,Oc$1(this,n[1]||"",!0),this.s=Tc$1(n[2]||""),Pc$1(this,n[3]||"",!0),Qc$1(this,n[4]),this.l=Tc$1(n[5]||"",!0),Sc$1(this,n[6]||"",!0),this.o=Tc$1(n[7]||"")):(this.g=!!e,this.h=new Rc$1(null,this.g))}function N$1(t){return new U$1(t)}function Oc$1(t,e,n){t.j=n?Tc$1(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function Pc$1(t,e,n){t.i=n?Tc$1(e,!0):e}function Qc$1(t,e){if(e){if(e=Number(e),isNaN(e)||e<0)throw Error("Bad port number "+e);t.m=e}else t.m=null}function Sc$1(t,e,n){e instanceof Rc$1?(t.h=e,Zc$1(t.h,t.g)):(n||(e=Uc$1(e,$c$1)),t.h=new Rc$1(e,t.g))}function R(t,e,n){t.h.set(e,n)}function jc$1(t){return R(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function ad(t){return t instanceof U$1?N$1(t):new U$1(t,void 0)}function bd(t,e,n,r){var s=new U$1(null,void 0);return t&&Oc$1(s,t),e&&Pc$1(s,e),n&&Qc$1(s,n),r&&(s.l=r),s}function Tc$1(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function Uc$1(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,cd),t=n?t.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):t):null}function cd(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}U$1.prototype.toString=function(){var t=[],e=this.j;e&&t.push(Uc$1(e,Vc$1,!0),":");var n=this.i;return!n&&"file"!=e||(t.push("//"),(e=this.s)&&t.push(Uc$1(e,Vc$1,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.i&&"/"!=n.charAt(0)&&t.push("/"),t.push(Uc$1(n,"/"==n.charAt(0)?Wc$1:Xc$1,!0))),(n=this.h.toString())&&t.push("?",n),(n=this.o)&&t.push("#",Uc$1(n,Yc$1)),t.join("")};var Vc$1=/[#\/\?@]/g,Xc$1=/[#\?:]/g,Wc$1=/[#\?]/g,$c$1=/[#\?@]/g,Yc$1=/#/g;function Rc$1(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function V(n){n.g||(n.g=new S,n.h=0,n.i&&Nc$1(n.i,function(t,e){n.add(decodeURIComponent(t.replace(/\+/g," ")),e)}))}function dd(t,e){V(t),e=W$1(t,e),T(t.g.h,e)&&(t.i=null,t.h-=t.g.get(e).length,T((t=t.g).h,e)&&(delete t.h[e],t.i--,t.g.length>2*t.i&&Lc$1(t)))}function ed(t,e){return V(t),e=W$1(t,e),T(t.g.h,e)}function mc$1(t,e,n){dd(t,e),0<n.length&&(t.i=null,t.g.set(W$1(t,e),ra$1(n)),t.h+=n.length)}function W$1(t,e){return e=String(e),e=t.j?e.toLowerCase():e}function Zc$1(t,e){e&&!t.j&&(V(t),t.i=null,t.g.forEach(function(t,e){var n=e.toLowerCase();e!=n&&(dd(this,e),mc$1(this,n,t))},t)),t.j=e}(k$1=Rc$1.prototype).add=function(t,e){V(this),this.i=null,t=W$1(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},k$1.forEach=function(n,r){V(this),this.g.forEach(function(t,e){na$1(t,function(t){n.call(r,t,e,this)},this)},this)},k$1.T=function(){V(this);for(var t=this.g.R(),e=this.g.T(),n=[],r=0;r<e.length;r++)for(var s=t[r],i=0;i<s.length;i++)n.push(e[r]);return n},k$1.R=function(t){V(this);var e=[];if("string"==typeof t)ed(this,t)&&(e=qa$1(e,this.g.get(W$1(this,t))));else{t=this.g.R();for(var n=0;n<t.length;n++)e=qa$1(e,t[n])}return e},k$1.set=function(t,e){return V(this),this.i=null,ed(this,t=W$1(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},k$1.get=function(t,e){return t&&0<(t=this.R(t)).length?String(t[0]):e},k$1.toString=function(){if(this.i)return this.i;if(!this.g)return"";for(var t=[],e=this.g.T(),n=0;n<e.length;n++)for(var r=e[n],s=encodeURIComponent(String(r)),r=this.R(r),i=0;i<r.length;i++){var o=s;""!==r[i]&&(o+="="+encodeURIComponent(String(r[i]))),t.push(o)}return this.i=t.join("&")};var fd=class{constructor(t,e){this.h=t,this.g=e}};function gd(t){this.l=t||hd,t=l.PerformanceNavigationTiming?0<(t=l.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(l.g&&l.g.Ea&&l.g.Ea()&&l.g.Ea().Zb),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}var hd=10;function id(t){return!!t.h||!!t.g&&t.g.size>=t.j}function Cc$1(t){return t.h?1:t.g?t.g.size:0}function yc$1(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function Dc$1(t,e){t.g?t.g.add(e):t.h=e}function Fc$1(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function jd(e){if(null!=e.h)return e.i.concat(e.h.D);if(null==e.g||0===e.g.size)return ra$1(e.i);{let t=e.i;for(const n of e.g.values())t=t.concat(n.D);return t}}function kd(){}function ld(){this.g=new kd}function md(t,r,e){const s=e||"";try{Kc$1(t,function(t,e){let n=t;p(t)&&(n=rb(t)),r.push(s+e+"="+encodeURIComponent(n))})}catch(t){throw r.push(s+"type="+encodeURIComponent("_badmap")),t}}function nd(t,e){var n=new Mb;if(l.Image){const r=new Image;r.onload=ja$1(od,n,r,"TestLoadImage: loaded",!0,e),r.onerror=ja$1(od,n,r,"TestLoadImage: error",!1,e),r.onabort=ja$1(od,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=ja$1(od,n,r,"TestLoadImage: timeout",!1,e),l.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=t}else e(!1)}function od(t,e,n,r,s){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,s(r)}catch(t){}}function pd(t){this.l=t.$b||null,this.j=t.ib||!1}function qd(t,e){C$1.call(this),this.D=t,this.u=e,this.m=void 0,this.readyState=rd,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}gd.prototype.cancel=function(){if(this.i=jd(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},kd.prototype.stringify=function(t){return l.JSON.stringify(t,void 0)},kd.prototype.parse=function(t){return l.JSON.parse(t,void 0)},t(pd,Yb),pd.prototype.g=function(){return new qd(this.l,this.j)},pd.prototype.i=function(t){return function(){return t}}({}),t(qd,C$1);var rd=0;function ud(t){t.j.read().then(t.Sa.bind(t)).catch(t.ha.bind(t))}function td(t){t.readyState=4,t.l=null,t.j=null,t.A=null,sd(t)}function sd(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(k$1=qd.prototype).open=function(t,e){if(this.readyState!=rd)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,sd(this)},k$1.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.D||l).fetch(new Request(this.B,e)).then(this.Va.bind(this),this.ha.bind(this))},k$1.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted."),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,td(this)),this.readyState=rd},k$1.Va=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,sd(this)),this.g&&(this.readyState=3,sd(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ta.bind(this),this.ha.bind(this));else if(void 0!==l.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;ud(this)}else t.text().then(this.Ua.bind(this),this.ha.bind(this))},k$1.Sa=function(t){var e;this.g&&(this.u&&t.value?this.response.push(t.value):this.u||(e=t.value||new Uint8Array(0),(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)),(t.done?td:sd)(this),3==this.readyState&&ud(this))},k$1.Ua=function(t){this.g&&(this.response=this.responseText=t,td(this))},k$1.Ta=function(t){this.g&&(this.response=t,td(this))},k$1.ha=function(){this.g&&td(this)},k$1.setRequestHeader=function(t,e){this.v.append(t,e)},k$1.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},k$1.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(qd.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var vd=l.JSON.parse;function X$1(t){C$1.call(this),this.headers=new S,this.u=t||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=wd,this.K=this.L=!1}t(X$1,C$1);var wd="",xd=/^https?$/i,yd=["POST","PUT"];function Bd(t){return y&&Ra$1()&&"number"==typeof t.timeout&&void 0!==t.ontimeout}function pa$1(t){return"content-type"==t.toLowerCase()}function zd(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Cd(t),Dd(t)}function Cd(t){t.D||(t.D=!0,D$1(t,"complete"),D$1(t,"error"))}function Ed(t){if(t.h&&void 0!==goog&&(!t.C[1]||4!=O$1(t)||2!=t.ba()))if(t.v&&4==O$1(t))Gb(t.Fa,0,t);else if(D$1(t,"readystatechange"),4==O$1(t)){t.h=!1;try{var e,n,r,s,i=t.ba();t:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var o=!0;break t;default:o=!1}if((e=o)||((n=0===i)&&(!(s=String(t.H).match(Mc$1)[1]||null)&&l.self&&l.self.location&&(s=(r=l.self.location.protocol).substr(0,r.length-1)),n=!xd.test(s?s.toLowerCase():"")),e=n),e)D$1(t,"complete"),D$1(t,"success");else{t.m=6;try{var a=2<O$1(t)?t.g.statusText:""}catch(t){a=""}t.j=a+" ["+t.ba()+"]",Cd(t)}}finally{Dd(t)}}}function Dd(t,e){if(t.g){Ad(t);const n=t.g,r=t.C[0]?aa$1:null;t.g=null,t.C=null,e||D$1(t,"ready");try{n.onreadystatechange=r}catch(t){}}}function Ad(t){t.g&&t.K&&(t.g.ontimeout=null),t.A&&(l.clearTimeout(t.A),t.A=null)}function O$1(t){return t.g?t.g.readyState:0}function oc$1(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.J){case wd:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function Fd(t){let n="";return xa$1(t,function(t,e){n+=e,n+=":",n+=t,n+="\r\n"}),n}function Gd(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}r||(n=Fd(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):R(t,e,n))}function Hd(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Id(t){this.za=0,this.l=[],this.h=new Mb,this.la=this.oa=this.F=this.W=this.g=this.sa=this.D=this.aa=this.o=this.P=this.s=null,this.Za=this.V=0,this.Xa=Hd("failFast",!1,t),this.N=this.v=this.u=this.m=this.j=null,this.X=!0,this.I=this.ta=this.U=-1,this.Y=this.A=this.C=0,this.Pa=Hd("baseRetryDelayMs",5e3,t),this.$a=Hd("retryDelaySeedMs",1e4,t),this.Ya=Hd("forwardChannelMaxRetries",2,t),this.ra=Hd("forwardChannelRequestTimeoutMs",2e4,t),this.qa=t&&t.xmlHttpFactory||void 0,this.Ba=t&&t.Yb||!1,this.K=void 0,this.H=t&&t.supportsCrossDomainXhr||!1,this.J="",this.i=new gd(t&&t.concurrentRequestLimit),this.Ca=new ld,this.ja=t&&t.fastHandshake||!1,this.Ra=t&&t.Wb||!1,t&&t.Aa&&this.h.Aa(),t&&t.forceLongPolling&&(this.X=!1),this.$=!this.ja&&this.X&&t&&t.detectBufferingProxy||!1,this.ka=void 0,this.O=0,this.L=!1,this.B=null,this.Wa=!t||!1!==t.Xb}function Ic$1(t){var e,n;Jd(t),3==t.G&&(e=t.V++,R(n=N$1(t.F),"SID",t.J),R(n,"RID",e),R(n,"TYPE","terminate"),Kd(t,n),(e=new M$1(t,t.h,e,void 0)).K=2,e.v=jc$1(N$1(n)),n=!1,!(n=l.navigator&&l.navigator.sendBeacon?l.navigator.sendBeacon(e.v.toString(),""):n)&&l.Image&&((new Image).src=e.v,n=!0),n||(e.g=nc$1(e.l,null),e.g.ea(e.v)),e.F=Date.now(),lc$1(e)),Ld(t)}function Ac$1(t){t.g&&(wc$1(t),t.g.cancel(),t.g=null)}function Jd(t){Ac$1(t),t.u&&(l.clearTimeout(t.u),t.u=null),zc$1(t),t.i.cancel(),t.m&&("number"==typeof t.m&&l.clearTimeout(t.m),t.m=null)}function Md(t,e){t.l.push(new fd(t.Za++,e)),3==t.G&&Hc$1(t)}function Hc$1(t){id(t.i)||t.m||(t.m=!0,zb(t.Ha,t),t.C=0)}function Nd(t,e){return!(Cc$1(t.i)>=t.i.j-(t.m?1:0))&&(t.m?(t.l=e.D.concat(t.l),!0):!(1==t.G||2==t.G||t.C>=(t.Xa?0:t.Ya))&&(t.m=K$1(q$1(t.Ha,t,e),Od(t,t.C)),t.C++,!0))}function Qd(t,e){var n=e?e.m:t.V++,r=N$1(t.F);R(r,"SID",t.J),R(r,"RID",n),R(r,"AID",t.U),Kd(t,r),t.o&&t.s&&Gd(r,t.o,t.s),n=new M$1(t,t.h,n,t.C+1),null===t.o&&(n.H=t.s),e&&(t.l=e.D.concat(t.l)),e=Pd(t,n,1e3),n.setTimeout(Math.round(.5*t.ra)+Math.round(.5*t.ra*Math.random())),Dc$1(t.i,n),ic$1(n,r,e)}function Kd(t,n){t.j&&Kc$1({},function(t,e){R(n,e,t)})}function Pd(t,e,r){r=Math.min(t.l.length,r);var s=t.j?q$1(t.j.Oa,t.j,t):null;t:{var i=t.l;let n=-1;for(;;){const c=["count="+r];-1==n?0<r?(n=i[0].h,c.push("ofs="+n)):n=0:c.push("ofs="+n);let e=!0;for(let t=0;t<r;t++){var o=i[t].h,a=i[t].g;if((o-=n)<0)n=Math.max(0,i[t].h-100),e=!1;else try{md(a,c,"req"+o+"_")}catch(t){s&&s(a)}}if(e){s=c.join("&");break t}}}return t=t.l.splice(0,r),e.D=t,s}function Gc$1(t){t.g||t.u||(t.Y=1,zb(t.Ga,t),t.A=0)}function Bc$1(t){return!(t.g||t.u||3<=t.A)&&(t.Y++,t.u=K$1(q$1(t.Ga,t),Od(t,t.A)),t.A++,!0)}function wc$1(t){null!=t.B&&(l.clearTimeout(t.B),t.B=null)}function Rd(t){t.g=new M$1(t,t.h,"rpc",t.Y),null===t.o&&(t.g.H=t.s),t.g.O=0;var e=N$1(t.oa);R(e,"RID","rpc"),R(e,"SID",t.J),R(e,"CI",t.N?"0":"1"),R(e,"AID",t.U),Kd(t,e),R(e,"TYPE","xmlhttp"),t.o&&t.s&&Gd(e,t.o,t.s),t.K&&t.g.setTimeout(t.K);var n=t.g;t=t.la,n.K=1,n.v=jc$1(N$1(e)),n.s=null,n.U=!0,kc$1(n,t)}function zc$1(t){null!=t.v&&(l.clearTimeout(t.v),t.v=null)}function uc$1(t,e){var n,r=null;if(t.g==e){zc$1(t),wc$1(t),t.g=null;var s=2}else{if(!yc$1(t.i,e))return;r=e.D,Fc$1(t.i,e),s=1}if(t.I=e.N,0!=t.G)if(e.i)1==s?(r=e.s?e.s.length:0,e=Date.now()-e.F,n=t.C,D$1(s=Sb(),new Vb(s,r,e,n)),Hc$1(t)):Gc$1(t);else if(3==(n=e.o)||0==n&&0<t.I||!(1==s&&Nd(t,e)||2==s&&Bc$1(t)))switch(r&&0<r.length&&(e=t.i,e.i=e.i.concat(r)),n){case 1:Q$1(t,5);break;case 4:Q$1(t,10);break;case 3:Q$1(t,6);break;default:Q$1(t,2)}}function Od(t,e){let n=t.Pa+Math.floor(Math.random()*t.$a);return t.j||(n*=2),n*e}function Q$1(t,e){var n,r;t.h.info("Error code "+e),2==e?(n=null,t.j&&(n=null),r=q$1(t.jb,t),n||(n=new U$1("//www.google.com/images/cleardot.gif"),l.location&&"http"==l.location.protocol||Oc$1(n,"https"),jc$1(n)),nd(n.toString(),r)):J$1(2),t.G=0,t.j&&t.j.va(e),Ld(t),Jd(t)}function Ld(t){t.G=0,t.I=-1,t.j&&(0==jd(t.i).length&&0==t.l.length||(t.i.i.length=0,ra$1(t.l),t.l.length=0),t.j.ua())}function Ec$1(t,e,n){let r=ad(n);var s;return""!=r.i?(e&&Pc$1(r,e+"."+r.i),Qc$1(r,r.m)):(s=l.location,r=bd(s.protocol,e?e+"."+s.hostname:s.hostname,+s.port,n)),t.aa&&xa$1(t.aa,function(t,e){R(r,e,t)}),e=t.D,n=t.sa,e&&n&&R(r,e,n),R(r,"VER",t.ma),Kd(t,r),r}function nc$1(t,e,n){if(e&&!t.H)throw Error("Can't create secondary domain capable XhrIo object.");return(e=n&&t.Ba&&!t.qa?new X$1(new pd({ib:!0})):new X$1(t.qa)).L=t.H,e}function Sd(){}function Td(){if(y&&!(10<=Number(Ua$1)))throw Error("Environmental error: no available transport.")}function Y$1(t,e){C$1.call(this),this.g=new Id(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.ya&&(t?t["X-WebChannel-Client-Profile"]=e.ya:t={"X-WebChannel-Client-Profile":e.ya}),this.g.P=t,(t=e&&e.httpHeadersOverwriteParam)&&!sa$1(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!sa$1(e)&&(this.g.D=e,null!==(t=this.h)&&e in t&&(e in(t=this.h)&&delete t[e])),this.j=new Z$1(this)}function Ud(t){ac$1.call(this);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function Vd(){bc$1.call(this),this.status=1}function Z$1(t){this.g=t}(k$1=X$1.prototype).ea=function(t,e,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+t);e=e?e.toUpperCase():"GET",this.H=t,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=(this.u||cc$1).g(),this.C=this.u?Zb(this.u):Zb(cc$1),this.g.onreadystatechange=q$1(this.Fa,this);try{this.F=!0,this.g.open(e,String(t),!0),this.F=!1}catch(t){return void zd(this,t)}t=n||"";const s=new S(this.headers);r&&Kc$1(r,function(t,e){s.set(e,t)}),r=oa$1(s.T()),n=l.FormData&&t instanceof l.FormData,0<=ma$1(yd,e)&&!r&&!n&&s.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),s.forEach(function(t,e){this.g.setRequestHeader(e,t)},this),this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{Ad(this),0<this.B&&((this.K=Bd(this.g))?(this.g.timeout=this.B,this.g.ontimeout=q$1(this.pa,this)):this.A=Gb(this.pa,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){zd(this,t)}},k$1.pa=function(){void 0!==goog&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,D$1(this,"timeout"),this.abort(8))},k$1.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,D$1(this,"complete"),D$1(this,"abort"),Dd(this))},k$1.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Dd(this,!0)),X$1.Z.M.call(this)},k$1.Fa=function(){this.s||(this.F||this.v||this.l?Ed(this):this.cb())},k$1.cb=function(){Ed(this)},k$1.ba=function(){try{return 2<O$1(this)?this.g.status:-1}catch(t){return-1}},k$1.ga=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},k$1.Qa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),vd(e)}},k$1.Da=function(){return this.m},k$1.La=function(){return"string"==typeof this.j?this.j:String(this.j)},(k$1=Id.prototype).ma=8,k$1.G=1,k$1.hb=function(t){try{this.h.info("Origin Trials invoked: "+t)}catch(t){}},k$1.Ha=function(e){if(this.m)if(this.m=null,1==this.G){if(!e){this.V=Math.floor(1e5*Math.random()),e=this.V++;const i=new M$1(this,this.h,e,void 0);let t=this.s;if(this.P&&(t?(t=ya$1(t),Aa$1(t,this.P)):t=this.P),null===this.o&&(i.H=t),this.ja)t:{for(var n=0,r=0;r<this.l.length;r++){var s=this.l[r];if("__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s=s.length:s=void 0,void 0===s)break;if(4096<(n+=s)){n=r;break t}if(4096===n||r===this.l.length-1){n=r+1;break t}}n=1e3}else n=1e3;n=Pd(this,i,n),R(r=N$1(this.F),"RID",e),R(r,"CVER",22),this.D&&R(r,"X-HTTP-Session-Id",this.D),Kd(this,r),this.o&&t&&Gd(r,this.o,t),Dc$1(this.i,i),this.Ra&&R(r,"TYPE","init"),this.ja?(R(r,"$req",n),R(r,"SID","null"),i.$=!0,ic$1(i,r,null)):ic$1(i,r,n),this.G=2}}else 3==this.G&&(e?Qd(this,e):0==this.l.length||id(this.i)||Qd(this))},k$1.Ga=function(){var t;this.u=null,Rd(this),this.$&&!(this.L||null==this.g||this.O<=0)&&(t=2*this.O,this.h.info("BP detection timer enabled: "+t),this.B=K$1(q$1(this.bb,this),t))},k$1.bb=function(){this.B&&(this.B=null,this.h.info("BP detection timeout reached."),this.h.info("Buffering proxy detected and switch to long-polling!"),this.N=!1,this.L=!0,J$1(10),Ac$1(this),Rd(this))},k$1.ab=function(){null!=this.v&&(this.v=null,Ac$1(this),Bc$1(this),J$1(19))},k$1.jb=function(t){t?(this.h.info("Successfully pinged google.com"),J$1(2)):(this.h.info("Failed to ping google.com"),J$1(1))},(k$1=Sd.prototype).xa=function(){},k$1.wa=function(){},k$1.va=function(){},k$1.ua=function(){},k$1.Oa=function(){},Td.prototype.g=function(t,e){return new Y$1(t,e)},t(Y$1,C$1),Y$1.prototype.m=function(){this.g.j=this.j,this.A&&(this.g.H=!0);var t=this.g,e=this.l,n=this.h||void 0;t.Wa&&(t.h.info("Origin Trials enabled."),zb(q$1(t.hb,t,e))),J$1(0),t.W=e,t.aa=n||{},t.N=t.X,t.F=Ec$1(t,null,t.W),Hc$1(t)},Y$1.prototype.close=function(){Ic$1(this.g)},Y$1.prototype.u=function(t){var e;"string"==typeof t?((e={}).__data__=t,Md(this.g,e)):this.v?((e={}).__data__=rb(t),Md(this.g,e)):Md(this.g,t)},Y$1.prototype.M=function(){this.g.j=null,delete this.j,Ic$1(this.g),delete this.g,Y$1.Z.M.call(this)},t(Ud,ac$1),t(Vd,bc$1),t(Z$1,Sd),Z$1.prototype.xa=function(){D$1(this.g,"a")},Z$1.prototype.wa=function(t){D$1(this.g,new Ud(t))},Z$1.prototype.va=function(t){D$1(this.g,new Vd(t))},Z$1.prototype.ua=function(){D$1(this.g,"b")},Td.prototype.createWebChannel=Td.prototype.g,Y$1.prototype.send=Y$1.prototype.u,Y$1.prototype.open=Y$1.prototype.m,Y$1.prototype.close=Y$1.prototype.close,Wb.NO_ERROR=0,Wb.TIMEOUT=8,Wb.HTTP_ERROR=6,Xb.COMPLETE="complete",($b.EventType=L$1).OPEN="a",L$1.CLOSE="b",L$1.ERROR="c",L$1.MESSAGE="d",C$1.prototype.listen=C$1.prototype.N,X$1.prototype.listenOnce=X$1.prototype.O,X$1.prototype.getLastError=X$1.prototype.La,X$1.prototype.getLastErrorCode=X$1.prototype.Da,X$1.prototype.getStatus=X$1.prototype.ba,X$1.prototype.getResponseJson=X$1.prototype.Qa,X$1.prototype.getResponseText=X$1.prototype.ga,X$1.prototype.send=X$1.prototype.ea;var pn,In,createWebChannelTransport=function(){return new Td},getStatEventTarget=function(){return Sb()},ErrorCode=Wb,EventType=Xb,Event=H$1,Stat={rb:0,ub:1,vb:2,Ob:3,Tb:4,Qb:5,Rb:6,Pb:7,Nb:8,Sb:9,PROXY:10,NOPROXY:11,Lb:12,Hb:13,Ib:14,Gb:15,Jb:16,Kb:17,nb:18,mb:19,ob:20},FetchXmlHttpFactory=pd,WebChannel=$b,XhrIo=X$1;const D="@firebase/firestore";class C{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}C.UNAUTHENTICATED=new C(null),C.GOOGLE_CREDENTIALS=new C("google-credentials-uid"),C.FIRST_PARTY=new C("first-party-uid"),C.MOCK_USER=new C("mock-user");let N="9.6.7";const x=new Logger("@firebase/firestore");function k(){return x.logLevel}function O(t){x.setLogLevel(t)}function M(t,...e){x.logLevel<=LogLevel.DEBUG&&(e=e.map(B),x.debug(`Firestore (${N}): ${t}`,...e))}function $(t,...e){x.logLevel<=LogLevel.ERROR&&(e=e.map(B),x.error(`Firestore (${N}): ${t}`,...e))}function F(t,...e){x.logLevel<=LogLevel.WARN&&(e=e.map(B),x.warn(`Firestore (${N}): ${t}`,...e))}function B(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function L(t="Unexpected state"){t=`FIRESTORE (${N}) INTERNAL ASSERTION FAILED: `+t;throw $(t),new Error(t)}function U(t,e){t||L()}function q(t,e){t||L()}function K(t,e){return t}const G={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class j extends FirebaseError{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Q{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}}class W{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class z{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable(()=>e(C.UNAUTHENTICATED))}shutdown(){}}class H{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable(()=>e(this.token.user))}shutdown(){this.changeListener=null}}class J{constructor(t){this.t=t,this.currentUser=C.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,n){let r=this.i;const s=t=>this.i!==r?(r=this.i,n(t)):Promise.resolve();let i=new Q;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Q,e.enqueueRetryable(()=>s(this.currentUser))};const o=()=>{const t=i;e.enqueueRetryable(async()=>{await t.promise,await s(this.currentUser)})},a=t=>{M("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),o()};this.t.onInit(t=>a(t)),setTimeout(()=>{var t;this.auth||((t=this.t.getImmediate({optional:!0}))?a(t):(M("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Q))},0),o()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(M("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(U("string"==typeof t.accessToken),new W(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var t=this.auth&&this.auth.getUid();return U(null===t||"string"==typeof t),new C(t)}}class Y{constructor(t,e,n){this.type="FirstParty",this.user=C.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",e);t=t.auth.getAuthHeaderValueForFirstParty([]);t&&this.headers.set("Authorization",t),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class X{constructor(t,e,n){this.h=t,this.l=e,this.m=n}getToken(){return Promise.resolve(new Y(this.h,this.l,this.m))}start(t,e){t.enqueueRetryable(()=>e(C.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Z{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&0<t.length&&this.headers.set("x-firebase-appcheck",this.value)}}class tt{constructor(t){this.g=t,this.forceRefresh=!1,this.appCheck=null,this.p=null}start(e,n){const r=t=>{null!=t.error&&M("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);var e=t.token!==this.p;return this.p=t.token,M("FirebaseAppCheckTokenProvider",`Received ${e?"new":"existing"} token.`),e?n(t.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>r(t))};const s=t=>{M("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.g.onInit(t=>s(t)),setTimeout(()=>{var t;this.appCheck||((t=this.g.getImmediate({optional:!0}))?s(t):M("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then(t=>t?(U("string"==typeof t.token),this.p=t.token,new Z(t.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class et{getToken(){return Promise.resolve(new Z(""))}invalidateToken(){}start(t,e){}shutdown(){}}class nt{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.I(t),this.T=t=>e.writeSequenceNumber(t))}I(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){var t=++this.previousValue;return this.T&&this.T(t),t}}function st(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}nt.A=-1;class it{static R(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/e.length)*e.length;let r="";for(;r.length<20;){var s=st(40);for(let t=0;t<s.length;++t)r.length<20&&s[t]<n&&(r+=e.charAt(s[t]%e.length))}return r}}function rt(t,e){return t<e?-1:e<t?1:0}function ot(t,n,r){return t.length===n.length&&t.every((t,e)=>r(t,n[e]))}function ct(t){return t+"\0"}class ut{constructor(t,e){if(this.seconds=t,(this.nanoseconds=e)<0)throw new j(G.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(1e9<=e)throw new j(G.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new j(G.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(253402300800<=t)throw new j(G.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return ut.fromMillis(Date.now())}static fromDate(t){return ut.fromMillis(t.getTime())}static fromMillis(t){var e=Math.floor(t/1e3),t=Math.floor(1e6*(t-1e3*e));return new ut(e,t)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?rt(this.nanoseconds,t.nanoseconds):rt(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class at{constructor(t){this.timestamp=t}static fromTimestamp(t){return new at(t)}static min(){return new at(new ut(0,0))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}function ht(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function lt(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function ft(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class dt{constructor(t,e,n){void 0===e?e=0:e>t.length&&L(),void 0===n?n=t.length-e:n>t.length-e&&L(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===dt.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof dt?t.forEach(t=>{e.push(t)}):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return this.construct(this.segments,this.offset+(t=void 0===t?1:t),this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(n){for(let t=this.offset,e=this.limit();t<e;t++)n(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,n){const r=Math.min(e.length,n.length);for(let t=0;t<r;t++){const r=e.get(t),s=n.get(t);if(r<s)return-1;if(r>s)return 1}return e.length<n.length?-1:e.length>n.length?1:0}}class _t extends dt{construct(t,e,n){return new _t(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...t){const e=[];for(const n of t){if(0<=n.indexOf("//"))throw new j(G.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter(t=>0<t.length))}return new _t(e)}static emptyPath(){return new _t([])}}const wt=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class mt extends dt{construct(t,e,n){return new mt(t,e,n)}static isValidIdentifier(t){return wt.test(t)}canonicalString(){return this.toArray().map(t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),t=!mt.isValidIdentifier(t)?"`"+t+"`":t)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new mt(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;var s=()=>{if(0===n.length)throw new j(G.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new j(G.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new j(G.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?i=!i:"."!==e||i?n+=e:s(),r++}if(s(),i)throw new j(G.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new mt(e)}static emptyPath(){return new mt([])}}class gt{constructor(t){(this.fields=t).sort(mt.comparator)}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return ot(this.fields,t.fields,(t,e)=>t.isEqual(e))}}function yt(){return"undefined"!=typeof atob}class pt{constructor(t){this.binaryString=t}static fromBase64String(t){t=atob(t);return new pt(t)}static fromUint8Array(t){t=function(e){let n="";for(let t=0;t<e.length;++t)n+=String.fromCharCode(e[t]);return n}(t);return new pt(t)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return t=this.binaryString,btoa(t);var t}toUint8Array(){return function(e){const n=new Uint8Array(e.length);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);return n}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return rt(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}pt.EMPTY_BYTE_STRING=new pt("");const It=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Et(e){if(U(!!e),"string"!=typeof e)return{seconds:Tt(e.seconds),nanos:Tt(e.nanos)};{let t=0;var n=It.exec(e);U(!!n),n[1]&&(n=((n=n[1])+"000000000").substr(0,9),t=Number(n));const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}}function Tt(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function At(t){return"string"==typeof t?pt.fromBase64String(t):pt.fromUint8Array(t)}function Rt(t){return"server_timestamp"===(null===(t=((null===(t=null==t?void 0:t.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function Pt(t){t=t.mapValue.fields.__previous_value__;return Rt(t)?Pt(t):t}function bt(t){t=Et(t.mapValue.fields.__local_write_time__.timestampValue);return new ut(t.seconds,t.nanos)}class vt{constructor(t,e,n,r,s,i,o,a){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class Vt{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new Vt("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Vt&&t.projectId===this.projectId&&t.database===this.database}}function St(t){return null==t}function Dt(t){return 0===t&&1/t==-1/0}function Ct(t){return"number"==typeof t&&Number.isInteger(t)&&!Dt(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}class Nt{constructor(t){this.path=t}static fromPath(t){return new Nt(_t.fromString(t))}static fromName(t){return new Nt(_t.fromString(t).popFirst(5))}static empty(){return new Nt(_t.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return 2<=this.path.length&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===_t.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return _t.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new Nt(new _t(t.slice()))}}const xt={mapValue:{fields:{__type__:{stringValue:"__max___"}}}};function kt(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?Rt(t)?4:10:L()}function Ot(n,r){if(n===r)return!0;var t,e,s=kt(n);if(s!==kt(r))return!1;switch(s){case 0:return!0;case 1:return n.booleanValue===r.booleanValue;case 4:return bt(n).isEqual(bt(r));case 3:return function(t){if("string"==typeof n.timestampValue&&"string"==typeof t.timestampValue&&n.timestampValue.length===t.timestampValue.length)return n.timestampValue===t.timestampValue;var e=Et(n.timestampValue),t=Et(t.timestampValue);return e.seconds===t.seconds&&e.nanos===t.nanos}(r);case 5:return n.stringValue===r.stringValue;case 6:return e=r,At(n.bytesValue).isEqual(At(e.bytesValue));case 7:return n.referenceValue===r.referenceValue;case 8:return t=r,Tt((e=n).geoPointValue.latitude)===Tt(t.geoPointValue.latitude)&&Tt(e.geoPointValue.longitude)===Tt(t.geoPointValue.longitude);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return Tt(t.integerValue)===Tt(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){t=Tt(t.doubleValue),e=Tt(e.doubleValue);return t===e?Dt(t)===Dt(e):isNaN(t)&&isNaN(e)}return!1}(n,r);case 9:return ot(n.arrayValue.values||[],r.arrayValue.values||[],Ot);case 10:return function(t){const e=t.mapValue.fields||{},n=r.mapValue.fields||{};if(ht(e)!==ht(n))return!1;for(const t in e)if(e.hasOwnProperty(t)&&(void 0===n[t]||!Ot(e[t],n[t])))return!1;return!0}(n);default:return L()}}function Mt(t,e){return void 0!==(t.values||[]).find(t=>Ot(t,e))}function $t(t,e){if(t===e)return 0;var n,r,s,i=kt(t),o=kt(e);if(i!==o)return rt(i,o);switch(i){case 0:return 0;case 1:return rt(t.booleanValue,e.booleanValue);case 2:return r=e,s=Tt(t.integerValue||t.doubleValue),r=Tt(r.integerValue||r.doubleValue),s<r?-1:r<s?1:s===r?0:isNaN(s)?isNaN(r)?0:-1:1;case 3:return Ft(t.timestampValue,e.timestampValue);case 4:return Ft(bt(t),bt(e));case 5:return rt(t.stringValue,e.stringValue);case 6:return function(t,e){const n=At(t),r=At(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){var n=t.split("/"),r=e.split("/");for(let t=0;t<n.length&&t<r.length;t++){const e=rt(n[t],r[t]);if(0!==e)return e}return rt(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return n=t.geoPointValue,s=e.geoPointValue,0!==(r=rt(Tt(n.latitude),Tt(s.latitude)))?r:rt(Tt(n.longitude),Tt(s.longitude));case 9:return function(t,e){var n=t.values||[],r=e.values||[];for(let t=0;t<n.length&&t<r.length;++t){const e=$t(n[t],r[t]);if(e)return e}return rt(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let t=0;t<r.length&&t<i.length;++t){const e=rt(r[t],i[t]);if(0!==e)return e;var o=$t(n[r[t]],s[i[t]]);if(0!==o)return o}return rt(r.length,i.length)}(t.mapValue,e.mapValue);default:throw L()}}function Ft(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return rt(t,e);var n=Et(t),t=Et(e),e=rt(n.seconds,t.seconds);return 0!==e?e:rt(n.nanos,t.nanos)}function Bt(t){return Lt(t)}function Lt(r){return"nullValue"in r?"null":"booleanValue"in r?""+r.booleanValue:"integerValue"in r?""+r.integerValue:"doubleValue"in r?""+r.doubleValue:"timestampValue"in r?`time(${(t=Et(r.timestampValue)).seconds},${t.nanos})`:"stringValue"in r?r.stringValue:"bytesValue"in r?At(r.bytesValue).toBase64():"referenceValue"in r?(e=r.referenceValue,Nt.fromName(e).toString()):"geoPointValue"in r?`geo(${(e=r.geoPointValue).latitude},${e.longitude})`:"arrayValue"in r?function(){let t="[",e=!0;for(const n of r.arrayValue.values||[])e?e=!1:t+=",",t+=Lt(n);return t+"]"}():"mapValue"in r?function(t){let e="{",n=!0;for(const r of Object.keys(t.fields||{}).sort())n?n=!1:e+=",",e+=`${r}:${Lt(t.fields[r])}`;return e+"}"}(r.mapValue):L();var t,e}function Ut(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function qt(t){return!!t&&"integerValue"in t}function Kt(t){return!!t&&"arrayValue"in t}function Gt(t){return!!t&&"nullValue"in t}function jt(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function Qt(t){return!!t&&"mapValue"in t}function Wt(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const n={mapValue:{fields:{}}};return lt(e.mapValue.fields,(t,e)=>n.mapValue.fields[t]=Wt(e)),n}if(e.arrayValue){const r={arrayValue:{values:[]}};for(let t=0;t<(e.arrayValue.values||[]).length;++t)r.arrayValue.values[t]=Wt(e.arrayValue.values[t]);return r}return Object.assign({},e)}class zt{constructor(t){this.value=t}static empty(){return new zt({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let e=this.value;for(let t=0;t<n.length-1;++t)if(e=(e.mapValue.fields||{})[n.get(t)],!Qt(e))return null;return e=(e.mapValue.fields||{})[n.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=Wt(e)}setAll(t){let n=mt.emptyPath(),r={},s=[];t.forEach((t,e)=>{if(!n.isImmediateParentOf(e)){const t=this.getFieldsMap(n);this.applyChanges(t,r,s),r={},s=[],n=e.popLast()}t?r[e.lastSegment()]=Wt(t):s.push(e.lastSegment())});t=this.getFieldsMap(n);this.applyChanges(t,r,s)}delete(t){const e=this.field(t.popLast());Qt(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Ot(this.value,t.value)}getFieldsMap(n){let r=this.value;r.mapValue.fields||(r.mapValue={fields:{}});for(let e=0;e<n.length;++e){let t=r.mapValue.fields[n.get(e)];Qt(t)&&t.mapValue.fields||(t={mapValue:{fields:{}}},r.mapValue.fields[n.get(e)]=t),r=t}return r.mapValue.fields}applyChanges(n,t,e){lt(t,(t,e)=>n[t]=e);for(const t of e)delete n[t]}clone(){return new zt(Wt(this.value))}}function Ht(t){const r=[];return lt(t.fields,(t,e)=>{const n=new mt([t]);if(Qt(e)){const t=Ht(e.mapValue).fields;if(0===t.length)r.push(n);else for(const e of t)r.push(n.child(e))}else r.push(n)}),new gt(r)}class Jt{constructor(t,e,n,r,s,i){this.key=t,this.documentType=e,this.version=n,this.readTime=r,this.data=s,this.documentState=i}static newInvalidDocument(t){return new Jt(t,0,at.min(),at.min(),zt.empty(),0)}static newFoundDocument(t,e,n){return new Jt(t,1,e,at.min(),n,0)}static newNoDocument(t,e){return new Jt(t,2,e,at.min(),zt.empty(),0)}static newUnknownDocument(t,e){return new Jt(t,3,e,at.min(),zt.empty(),2)}convertToFoundDocument(t,e){return this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=zt.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=zt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof Jt&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new Jt(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Yt{constructor(t,e,n,r){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=r}}Yt.UNKNOWN_ID=-1;class Xt{constructor(t,e){this.fieldPath=t,this.kind=e}}class Zt{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new Zt(0,te.min())}}class te{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new te(at.min(),Nt.empty(),-1)}}class ee{constructor(t,e=null,n=[],r=[],s=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.P=null}}function ne(t,e=null,n=[],r=[],s=null,i=null,o=null){return new ee(t,e,n,r,s,i,o)}function se(t){const e=K(t);if(null===e.P){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(t=>{return(t=t).field.canonicalString()+t.op.toString()+Bt(t.value)}).join(","),t+="|ob:",t+=e.orderBy.map(t=>function(t){return t.field.canonicalString()+t.dir}(t)).join(","),St(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(t=>Bt(t)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(t=>Bt(t)).join(",")),e.P=t}return e.P}function ie(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),0<t.filters.length&&(e+=`, filters: [${t.filters.map(t=>{return`${(t=t).field.canonicalString()} ${t.op} ${Bt(t.value)}`}).join(", ")}]`),St(t.limit)||(e+=", limit: "+t.limit),0<t.orderBy.length&&(e+=`, orderBy: [${t.orderBy.map(t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t)).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(t=>Bt(t)).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(t=>Bt(t)).join(",")),`Target(${e})`}function re(e,n){if(e.limit!==n.limit)return!1;if(e.orderBy.length!==n.orderBy.length)return!1;for(let t=0;t<e.orderBy.length;t++)if(!ye(e.orderBy[t],n.orderBy[t]))return!1;if(e.filters.length!==n.filters.length)return!1;for(let t=0;t<e.filters.length;t++)if(r=e.filters[t],s=n.filters[t],r.op!==s.op||!r.field.isEqual(s.field)||!Ot(r.value,s.value))return!1;var r,s;return e.collectionGroup===n.collectionGroup&&!!e.path.isEqual(n.path)&&!!Ie(e.startAt,n.startAt)&&Ie(e.endAt,n.endAt)}function oe(t){return Nt.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}class ce extends class{}{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.v(t,e,n):new ue(t,e,n):"array-contains"===e?new fe(t,n):"in"===e?new de(t,n):"not-in"===e?new _e(t,n):"array-contains-any"===e?new we(t,n):new ce(t,e,n)}static v(t,e,n){return new("in"===e?ae:he)(t,n)}matches(t){t=t.data.field(this.field);return"!="===this.op?null!==t&&this.V($t(t,this.value)):null!==t&&kt(this.value)===kt(t)&&this.V($t(t,this.value))}V(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return 0<t;case">=":return 0<=t;default:return L()}}S(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}}class ue extends ce{constructor(t,e,n){super(t,e,n),this.key=Nt.fromName(n.referenceValue)}matches(t){t=Nt.comparator(t.key,this.key);return this.V(t)}}class ae extends ce{constructor(t,e){super(t,"in",e),this.keys=le("in",e)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class he extends ce{constructor(t,e){super(t,"not-in",e),this.keys=le("not-in",e)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function le(t,e){return((null===(e=e.arrayValue)||void 0===e?void 0:e.values)||[]).map(t=>Nt.fromName(t.referenceValue))}class fe extends ce{constructor(t,e){super(t,"array-contains",e)}matches(t){t=t.data.field(this.field);return Kt(t)&&Mt(t.arrayValue,this.value)}}class de extends ce{constructor(t,e){super(t,"in",e)}matches(t){t=t.data.field(this.field);return null!==t&&Mt(this.value.arrayValue,t)}}class _e extends ce{constructor(t,e){super(t,"not-in",e)}matches(t){if(Mt(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;t=t.data.field(this.field);return null!==t&&!Mt(this.value.arrayValue,t)}}class we extends ce{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!Kt(e)||!e.arrayValue.values)&&e.arrayValue.values.some(t=>Mt(this.value.arrayValue,t))}}class me{constructor(t,e){this.position=t,this.inclusive=e}}class ge{constructor(t,e="asc"){this.field=t,this.dir=e}}function ye(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}function pe(e,n,r){let s=0;for(let t=0;t<e.position.length;t++){const i=n[t],o=e.position[t];if(s=i.field.isKeyField()?Nt.comparator(Nt.fromName(o.referenceValue),r.key):$t(o,r.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function Ie(e,n){if(null===e)return null===n;if(null===n)return!1;if(e.inclusive!==n.inclusive||e.position.length!==n.position.length)return!1;for(let t=0;t<e.position.length;t++)if(!Ot(e.position[t],n.position[t]))return!1;return!0}class Ee{constructor(t,e=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.D=null,this.C=null,this.startAt,this.endAt}}function Te(t,e,n,r,s,i,o,a){return new Ee(t,e,n,r,s,i,o,a)}function Ae(t){return new Ee(t)}function Re(t){return!St(t.limit)&&"F"===t.limitType}function Pe(t){return!St(t.limit)&&"L"===t.limitType}function be(t){return 0<t.explicitOrderBy.length?t.explicitOrderBy[0].field:null}function ve(t){for(const e of t.filters)if(e.S())return e.field;return null}function Ve(t){return null!==t.collectionGroup}function Se(e){const n=K(e);if(null===n.D){n.D=[];const e=ve(n),t=be(n);if(null!==e&&null===t)e.isKeyField()||n.D.push(new ge(e)),n.D.push(new ge(mt.keyField(),"asc"));else{let t=!1;for(const r of n.explicitOrderBy)n.D.push(r),r.field.isKeyField()&&(t=!0);if(!t){const e=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n.D.push(new ge(mt.keyField(),e))}}}return n.D}function De(t){const e=K(t);if(!e.C)if("F"===e.limitType)e.C=ne(e.path,e.collectionGroup,Se(e),e.filters,e.limit,e.startAt,e.endAt);else{const r=[];for(const s of Se(e)){const e="desc"===s.dir?"asc":"desc";r.push(new ge(s.field,e))}var n=e.endAt?new me(e.endAt.position,!e.endAt.inclusive):null,t=e.startAt?new me(e.startAt.position,!e.startAt.inclusive):null;e.C=ne(e.path,e.collectionGroup,r,e.filters,e.limit,n,t)}return e.C}function Ce(t,e,n){return new Ee(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function Ne(t,e){return re(De(t),De(e))&&t.limitType===e.limitType}function xe(t){return`${se(De(t))}|lt:${t.limitType}`}function ke(t){return`Query(target=${ie(De(t))}; limitType=${t.limitType})`}function Oe(n,t){return t.isFoundDocument()&&(r=n,i=(s=t).key.path,null!==r.collectionGroup?s.key.hasCollectionId(r.collectionGroup)&&r.path.isPrefixOf(i):Nt.isDocumentKey(r.path)?r.path.isEqual(i):r.path.isImmediateParentOf(i))&&function(t){for(const e of n.explicitOrderBy)if(!e.field.isKeyField()&&null===t.data.field(e.field))return!1;return!0}(t)&&function(t){for(const e of n.filters)if(!e.matches(t))return!1;return!0}(t)&&(r=t,(!(i=n).startAt||(t=i.startAt,e=pe(t,Se(i),r),t.inclusive?e<=0:e<0))&&(!i.endAt||(e=i.endAt,r=pe(e,Se(i),r),e.inclusive?0<=r:0<r)));var e,r,s,i}function Me(s){return(t,e)=>{let n=!1;for(const r of Se(s)){const s=$e(r,t,e);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}function $e(t,e,n){var r,s=t.field.isKeyField()?Nt.comparator(e.key,n.key):(r=t.field,n=n,e=e.data.field(r),r=n.data.field(r),null!==e&&null!==r?$t(e,r):L());switch(t.dir){case"asc":return s;case"desc":return-1*s;default:return L()}}function Fe(t,e){if(t.N){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Dt(e)?"-0":e}}function Be(t){return{integerValue:""+t}}function Le(t,e){return Ct(e)?Be(e):Fe(t,e)}class Ue{constructor(){this._=void 0}}function qe(t,e,n){return t instanceof je?function(){const t={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:n.seconds,nanos:n.nanoseconds}}}};return e&&(t.fields.__previous_value__=e),{mapValue:t}}():t instanceof Qe?We(t,e):t instanceof ze?He(t,e):(s=Ge(r=t,e),t=Ye(s)+Ye(r.k),qt(s)&&qt(r.k)?Be(t):Fe(r.O,t));var r,s}function Ke(t,e,n){return t instanceof Qe?We(t,e):t instanceof ze?He(t,e):n}function Ge(t,e){return t instanceof Je?qt(t=e)||t&&"doubleValue"in t?e:{integerValue:0}:null}class je extends Ue{}class Qe extends Ue{constructor(t){super(),this.elements=t}}function We(t,e){const n=Xe(e);for(const e of t.elements)n.some(t=>Ot(t,e))||n.push(e);return{arrayValue:{values:n}}}class ze extends Ue{constructor(t){super(),this.elements=t}}function He(t,e){let n=Xe(e);for(const e of t.elements)n=n.filter(t=>!Ot(t,e));return{arrayValue:{values:n}}}class Je extends Ue{constructor(t,e){super(),this.O=t,this.k=e}}function Ye(t){return Tt(t.integerValue||t.doubleValue)}function Xe(t){return Kt(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Ze{constructor(t,e){this.field=t,this.transform=e}}function tn(t,e){return t.field.isEqual(e.field)&&(t=t.transform,e=e.transform,t instanceof Qe&&e instanceof Qe||t instanceof ze&&e instanceof ze?ot(t.elements,e.elements,Ot):t instanceof Je&&e instanceof Je?Ot(t.k,e.k):t instanceof je&&e instanceof je)}class en{constructor(t,e){this.version=t,this.transformResults=e}}class nn{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new nn}static exists(t){return new nn(void 0,t)}static updateTime(t){return new nn(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function sn(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class rn{}function on(t,e,n){t instanceof ln?function(t,e,n){const r=t.value.clone(),s=_n(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof fn?function(t,e,n){if(!sn(t.precondition,e))return e.convertToUnknownDocument(n.version);const r=_n(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll(dn(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):e.convertToNoDocument(n.version).setHasCommittedMutations()}function cn(t,e,n){t instanceof ln?function(t,e,n){if(sn(t.precondition,e)){const r=t.value.clone(),s=wn(t.fieldTransforms,n,e);r.setAll(s),e.convertToFoundDocument(hn(e),r).setHasLocalMutations()}}(t,e,n):t instanceof fn?function(t,e,n){if(sn(t.precondition,e)){const r=wn(t.fieldTransforms,n,e),s=e.data;s.setAll(dn(t)),s.setAll(r),e.convertToFoundDocument(hn(e),s).setHasLocalMutations()}}(t,e,n):(e=e,sn(t.precondition,e)&&e.convertToNoDocument(at.min()))}function un(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=Ge(r.transform,t||null);null!=s&&(null==n&&(n=zt.empty()),n.set(r.field,s))}return n||null}function an(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&(n=t.fieldTransforms,r=e.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&ot(n,r,(t,e)=>tn(t,e)))&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask)));var n,r}function hn(t){return t.isFoundDocument()?t.version:at.min()}class ln extends rn{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}}class fn extends rn{constructor(t,e,n,r,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}}function dn(n){const r=new Map;return n.fieldMask.fields.forEach(t=>{var e;t.isEmpty()||(e=n.data.field(t),r.set(t,e))}),r}function _n(e,n,r){const s=new Map;U(e.length===r.length);for(let t=0;t<r.length;t++){var i=e[t],o=i.transform,a=n.data.field(i.field);s.set(i.field,Ke(o,a,r[t]))}return s}function wn(t,e,n){const r=new Map;for(const s of t){const t=s.transform,i=n.data.field(s.field);r.set(s.field,qe(t,i,e))}return r}class mn extends rn{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}}class gn extends rn{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}}class yn{constructor(t){this.count=t}}function En(t){switch(t){default:return L();case G.CANCELLED:case G.UNKNOWN:case G.DEADLINE_EXCEEDED:case G.RESOURCE_EXHAUSTED:case G.INTERNAL:case G.UNAVAILABLE:case G.UNAUTHENTICATED:return!1;case G.INVALID_ARGUMENT:case G.NOT_FOUND:case G.ALREADY_EXISTS:case G.PERMISSION_DENIED:case G.FAILED_PRECONDITION:case G.ABORTED:case G.OUT_OF_RANGE:case G.UNIMPLEMENTED:case G.DATA_LOSS:return!0}}function Tn(t){if(void 0===t)return $("GRPC error has no .code"),G.UNKNOWN;switch(t){case pn.OK:return G.OK;case pn.CANCELLED:return G.CANCELLED;case pn.UNKNOWN:return G.UNKNOWN;case pn.DEADLINE_EXCEEDED:return G.DEADLINE_EXCEEDED;case pn.RESOURCE_EXHAUSTED:return G.RESOURCE_EXHAUSTED;case pn.INTERNAL:return G.INTERNAL;case pn.UNAVAILABLE:return G.UNAVAILABLE;case pn.UNAUTHENTICATED:return G.UNAUTHENTICATED;case pn.INVALID_ARGUMENT:return G.INVALID_ARGUMENT;case pn.NOT_FOUND:return G.NOT_FOUND;case pn.ALREADY_EXISTS:return G.ALREADY_EXISTS;case pn.PERMISSION_DENIED:return G.PERMISSION_DENIED;case pn.FAILED_PRECONDITION:return G.FAILED_PRECONDITION;case pn.ABORTED:return G.ABORTED;case pn.OUT_OF_RANGE:return G.OUT_OF_RANGE;case pn.UNIMPLEMENTED:return G.UNIMPLEMENTED;case pn.DATA_LOSS:return G.DATA_LOSS;default:return L()}}(In=pn=pn||{})[In.OK=0]="OK",In[In.CANCELLED=1]="CANCELLED",In[In.UNKNOWN=2]="UNKNOWN",In[In.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",In[In.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",In[In.NOT_FOUND=5]="NOT_FOUND",In[In.ALREADY_EXISTS=6]="ALREADY_EXISTS",In[In.PERMISSION_DENIED=7]="PERMISSION_DENIED",In[In.UNAUTHENTICATED=16]="UNAUTHENTICATED",In[In.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",In[In.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",In[In.ABORTED=10]="ABORTED",In[In.OUT_OF_RANGE=11]="OUT_OF_RANGE",In[In.UNIMPLEMENTED=12]="UNIMPLEMENTED",In[In.INTERNAL=13]="INTERNAL",In[In.UNAVAILABLE=14]="UNAVAILABLE",In[In.DATA_LOSS=15]="DATA_LOSS";class An{constructor(t,e){this.comparator=t,this.root=e||Pn.EMPTY}insert(t,e){return new An(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Pn.BLACK,null,null))}remove(t){return new An(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Pn.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){var n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:0<n&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(t,n.key);if(0===r)return e+n.left.size;n=r<0?n.left:(e+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(n){this.inorderTraversal((t,e)=>(n(t,e),!1))}toString(){const n=[];return this.inorderTraversal((t,e)=>(n.push(`${t}:${e}`),!1)),`{${n.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new Rn(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new Rn(this.root,t,this.comparator,!1)}getReverseIterator(){return new Rn(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new Rn(this.root,t,this.comparator,!0)}}class Rn{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();var e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Pn{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:Pn.RED,this.left=null!=r?r:Pn.EMPTY,this.right=null!=s?s:Pn.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new Pn(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;var s=n(t,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Pn.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return Pn.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){var t=this.copy(null,null,Pn.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){var t=this.copy(null,null,Pn.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){var t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){var t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw L();if(this.right.isRed())throw L();var t=this.left.check();if(t!==this.right.check())throw L();return t+(this.isRed()?0:1)}}Pn.EMPTY=null,Pn.RED=!0,Pn.BLACK=!1,Pn.EMPTY=new class{constructor(){this.size=0}get key(){throw L()}get value(){throw L()}get color(){throw L()}get left(){throw L()}get right(){throw L()}copy(t,e,n,r,s){return this}insert(t,e,n){return new Pn(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class bn{constructor(t){this.comparator=t,this.data=new An(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(n){this.data.inorderTraversal((t,e)=>(n(t),!1))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,t[1]))return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new vn(this.data.getIterator())}getIteratorFrom(t){return new vn(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach(t=>{e=e.add(t)}),e}isEqual(t){if(!(t instanceof bn))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const e=[];return this.forEach(t=>{e.push(t)}),e}toString(){const e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(t){const e=new bn(this.comparator);return e.data=t,e}}class vn{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Vn(t){return t.hasNext()?t.getNext():void 0}const Sn=new An(Nt.comparator);function Dn(){return Sn}const Cn=new An(Nt.comparator);function Nn(){return Cn}const xn=new An(Nt.comparator),kn=new bn(Nt.comparator);function On(...t){let e=kn;for(const n of t)e=e.add(n);return e}const Mn=new bn(rt);function $n(){return Mn}class Fn{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e){const n=new Map;return n.set(t,Bn.createSynthesizedTargetChangeForCurrentChange(t,e)),new Fn(at.min(),n,$n(),Dn(),On())}}class Bn{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e){return new Bn(pt.EMPTY_BYTE_STRING,e,On(),On(),On())}}class Ln{constructor(t,e,n,r){this.M=t,this.removedTargetIds=e,this.key=n,this.$=r}}class Un{constructor(t,e){this.targetId=t,this.F=e}}class qn{constructor(t,e,n=pt.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class Kn{constructor(){this.B=0,this.L=Qn(),this.U=pt.EMPTY_BYTE_STRING,this.q=!1,this.K=!0}get current(){return this.q}get resumeToken(){return this.U}get G(){return 0!==this.B}get j(){return this.K}W(t){0<t.approximateByteSize()&&(this.K=!0,this.U=t)}H(){let n=On(),r=On(),s=On();return this.L.forEach((t,e)=>{switch(e){case 0:n=n.add(t);break;case 2:r=r.add(t);break;case 1:s=s.add(t);break;default:L()}}),new Bn(this.U,this.q,n,r,s)}J(){this.K=!1,this.L=Qn()}Y(t,e){this.K=!0,this.L=this.L.insert(t,e)}X(t){this.K=!0,this.L=this.L.remove(t)}Z(){this.B+=1}tt(){--this.B}et(){this.K=!0,this.q=!0}}class Gn{constructor(t){this.nt=t,this.st=new Map,this.it=Dn(),this.rt=jn(),this.ot=new bn(rt)}ct(t){for(const e of t.M)t.$&&t.$.isFoundDocument()?this.ut(e,t.$):this.at(e,t.key,t.$);for(const n of t.removedTargetIds)this.at(n,t.key,t.$)}ht(n){this.forEachTarget(n,t=>{const e=this.lt(t);switch(n.state){case 0:this.ft(t)&&e.W(n.resumeToken);break;case 1:e.tt(),e.G||e.J(),e.W(n.resumeToken);break;case 2:e.tt(),e.G||this.removeTarget(t);break;case 3:this.ft(t)&&(e.et(),e.W(n.resumeToken));break;case 4:this.ft(t)&&(this.dt(t),e.W(n.resumeToken));break;default:L()}})}forEachTarget(t,n){0<t.targetIds.length?t.targetIds.forEach(n):this.st.forEach((t,e)=>{this.ft(e)&&n(e)})}_t(t){const e=t.targetId,n=t.F.count,r=this.wt(e);if(r){const t=r.target;if(oe(t))if(0===n){const n=new Nt(t.path);this.at(e,n,Jt.newNoDocument(n,at.min()))}else U(1===n);else this.gt(e)!==n&&(this.dt(e),this.ot=this.ot.add(e))}}yt(r){const s=new Map;this.st.forEach((t,e)=>{var n=this.wt(e);if(n){if(t.current&&oe(n.target)){const s=new Nt(n.target.path);null!==this.it.get(s)||this.It(e,s)||this.at(e,s,Jt.newNoDocument(s,r))}t.j&&(s.set(e,t.H()),t.J())}});let i=On();this.rt.forEach((t,e)=>{let n=!0;e.forEachWhile(t=>{t=this.wt(t);return!t||2===t.purpose||(n=!1)}),n&&(i=i.add(t))}),this.it.forEach((t,e)=>e.setReadTime(r));var t=new Fn(r,s,this.ot,this.it,i);return this.it=Dn(),this.rt=jn(),this.ot=new bn(rt),t}ut(t,e){var n;this.ft(t)&&(n=this.It(t,e.key)?2:0,this.lt(t).Y(e.key,n),this.it=this.it.insert(e.key,e),this.rt=this.rt.insert(e.key,this.Et(e.key).add(t)))}at(t,e,n){if(this.ft(t)){const r=this.lt(t);this.It(t,e)?r.Y(e,1):r.X(e),this.rt=this.rt.insert(e,this.Et(e).delete(t)),n&&(this.it=this.it.insert(e,n))}}removeTarget(t){this.st.delete(t)}gt(t){var e=this.lt(t).H();return this.nt.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Z(t){this.lt(t).Z()}lt(t){let e=this.st.get(t);return e||(e=new Kn,this.st.set(t,e)),e}Et(t){let e=this.rt.get(t);return e||(e=new bn(rt),this.rt=this.rt.insert(t,e)),e}ft(t){var e=null!==this.wt(t);return e||M("WatchChangeAggregator","Detected inactive target",t),e}wt(t){var e=this.st.get(t);return e&&e.G?null:this.nt.Tt(t)}dt(e){this.st.set(e,new Kn),this.nt.getRemoteKeysForTarget(e).forEach(t=>{this.at(e,t,null)})}It(t,e){return this.nt.getRemoteKeysForTarget(t).has(e)}}function jn(){return new An(Nt.comparator)}function Qn(){return new An(Nt.comparator)}const Wn={asc:"ASCENDING",desc:"DESCENDING"},zn={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class Hn{constructor(t,e){this.databaseId=t,this.N=e}}function Jn(t,e){return t.N?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function Yn(t,e){return t.N?e.toBase64():e.toUint8Array()}function Xn(t,e){return Jn(t,e.toTimestamp())}function Zn(t){return U(!!t),at.fromTimestamp((t=Et(t),new ut(t.seconds,t.nanos)))}function ts(t,e){return t=t,new _t(["projects",t.projectId,"databases",t.database]).child("documents").child(e).canonicalString()}function es(t){t=_t.fromString(t);return U(vs(t)),t}function ns(t,e){return ts(t.databaseId,e.path)}function ss(t,e){const n=es(e);if(n.get(1)!==t.databaseId.projectId)throw new j(G.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new j(G.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new Nt(cs(n))}function is(t,e){return ts(t.databaseId,e)}function rs(t){t=es(t);return 4===t.length?_t.emptyPath():cs(t)}function os(t){return new _t(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function cs(t){return U(4<t.length&&"documents"===t.get(4)),t.popFirst(5)}function us(t,e,n){return{name:ns(t,e),fields:n.value.mapValue.fields}}function as(t,e,n){const r=ss(t,e.name),s=Zn(e.updateTime),i=new zt({mapValue:{fields:e.fields}}),o=Jt.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function hs(t,e){return"found"in e?function(t,e){U(!!e.found),e.found.name,e.found.updateTime;var n=ss(t,e.found.name),t=Zn(e.found.updateTime),e=new zt({mapValue:{fields:e.found.fields}});return Jt.newFoundDocument(n,t,e)}(t,e):"missing"in e?function(t,e){U(!!e.missing),U(!!e.readTime);t=ss(t,e.missing),e=Zn(e.readTime);return Jt.newNoDocument(t,e)}(t,e):L()}function ls(t,e){let n;if("targetChange"in e){e.targetChange;var r="NO_CHANGE"===(i=e.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===i?1:"REMOVE"===i?2:"CURRENT"===i?3:"RESET"===i?4:L(),s=e.targetChange.targetIds||[],i=(o=e.targetChange.resumeToken,t.N?(U(void 0===o||"string"==typeof o),pt.fromBase64String(o||"")):(U(void 0===o||o instanceof Uint8Array),pt.fromUint8Array(o||new Uint8Array))),o=e.targetChange.cause,a=o&&(o=void 0===(a=o).code?G.UNKNOWN:Tn(a.code),new j(o,a.message||""));n=new qn(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;var c=e.documentChange;c.document,c.document.name,c.document.updateTime;var i=ss(t,c.document.name),u=Zn(c.document.updateTime),a=new zt({mapValue:{fields:c.document.fields}}),u=Jt.newFoundDocument(i,u,a),a=c.targetIds||[],c=c.removedTargetIds||[];n=new Ln(a,c,u.key,u)}else if("documentDelete"in e){e.documentDelete;c=e.documentDelete;c.document;var u=ss(t,c.document),h=c.readTime?Zn(c.readTime):at.min(),h=Jt.newNoDocument(u,h),c=c.removedTargetIds||[];n=new Ln([],c,h.key,h)}else if("documentRemove"in e){e.documentRemove;h=e.documentRemove;h.document;var l=ss(t,h.document),h=h.removedTargetIds||[];n=new Ln([],h,l,null)}else{if(!("filter"in e))return L();{e.filter;const t=e.filter;t.targetId;l=t.count||0,e=new yn(l),l=t.targetId;n=new Un(l,e)}}var a,o,i;return n}function fs(t,e){let n;if(e instanceof ln)n={update:us(t,e.key,e.value)};else if(e instanceof mn)n={delete:ns(t,e.key)};else if(e instanceof fn)n={update:us(t,e.key,e.data),updateMask:bs(e.fieldMask)};else{if(!(e instanceof gn))return L();n={verify:ns(t,e.key)}}return 0<e.fieldTransforms.length&&(n.updateTransforms=e.fieldTransforms.map(t=>function(t){var e=t.transform;if(e instanceof je)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(e instanceof Qe)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:e.elements}};if(e instanceof ze)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:e.elements}};if(e instanceof Je)return{fieldPath:t.field.canonicalString(),increment:e.k};throw L()}(t))),e.precondition.isNone||(n.currentDocument=void 0!==(e=e.precondition).updateTime?{updateTime:Xn(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:L()),n}function ds(e,n){const t=n.currentDocument?void 0!==(i=n.currentDocument).updateTime?nn.updateTime(Zn(i.updateTime)):void 0!==i.exists?nn.exists(i.exists):nn.none():nn.none(),r=n.updateTransforms?n.updateTransforms.map(t=>function(t,e){let n=null;if("setToServerValue"in e)U("REQUEST_TIME"===e.setToServerValue),n=new je;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new Qe(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new ze(t)}else"increment"in e?n=new Je(t,e.increment):L();e=mt.fromServerFormat(e.fieldPath);return new Ze(e,n)}(e,t)):[];if(n.update){n.update.name;var s=ss(e,n.update.name),i=new zt({mapValue:{fields:n.update.fields}});if(n.updateMask){const e=function(){const t=n.updateMask.fieldPaths||[];return new gt(t.map(t=>mt.fromServerFormat(t)))}();return new fn(s,i,e,t,r)}return new ln(s,i,t,r)}if(n.delete){const r=ss(e,n.delete);return new mn(r,t)}if(n.verify){const r=ss(e,n.verify);return new gn(r,t)}return L()}function _s(t,e){return t&&0<t.length?(U(void 0!==e),t.map(t=>function(t,e){let n=t.updateTime?Zn(t.updateTime):Zn(e);return n.isEqual(at.min())&&(n=Zn(e)),new en(n,t.transformResults||[])}(t,e))):[]}function ws(t,e){return{documents:[is(t,e.path)]}}function ms(t,e){const n={structuredQuery:{}},r=e.path;null!==e.collectionGroup?(n.parent=is(t,r),n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(n.parent=is(t,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s=function(t){if(0!==t.length){t=t.map(t=>function(t){if("=="===t.op){if(jt(t.value))return{unaryFilter:{field:Ts(t.field),op:"IS_NAN"}};if(Gt(t.value))return{unaryFilter:{field:Ts(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(jt(t.value))return{unaryFilter:{field:Ts(t.field),op:"IS_NOT_NAN"}};if(Gt(t.value))return{unaryFilter:{field:Ts(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Ts(t.field),op:Es(t.op),value:t.value}}}(t));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}}(e.filters);s&&(n.structuredQuery.where=s);s=function(t){if(0!==t.length)return t.map(t=>function(t){return{field:Ts(t.field),direction:Is(t.dir)}}(t))}(e.orderBy);s&&(n.structuredQuery.orderBy=s);s=e.limit,s=t.N||St(s)?s:{value:s};return null!==s&&(n.structuredQuery.limit=s),e.startAt&&(n.structuredQuery.startAt={before:(s=e.startAt).inclusive,values:s.position}),e.endAt&&(n.structuredQuery.endAt={before:!(e=e.endAt).inclusive,values:e.position}),n}function gs(t){let e=rs(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(0<r){U(1===r);const t=n.from[0];t.allDescendants?s=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=ps(n.where));let o=[];n.orderBy&&(o=n.orderBy.map(t=>function(t){return new ge(As(t.field),function(){switch(t.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())}(t)));let a=null;n.limit&&(a=function(t){t="object"==typeof t?t.value:t;return St(t)?null:t}(n.limit));let c=null;var u,h;n.startAt&&(c=(u=n.startAt,h=!!u.before,u=u.values||[],new me(u,h)));let l=null;return n.endAt&&(l=(u=n.endAt,h=!u.before,u=u.values||[],new me(u,h))),Te(e,s,o,i,a,"F",c,l)}function ys(t,e){var n=function(){switch(e.purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return L()}}();return null==n?null:{"goog-listen-tags":n}}function ps(t){return t?void 0!==t.unaryFilter?[Ps(t)]:void 0!==t.fieldFilter?[Rs(t)]:void 0!==t.compositeFilter?t.compositeFilter.filters.map(t=>ps(t)).reduce((t,e)=>t.concat(e)):L():[]}function Is(t){return Wn[t]}function Es(t){return zn[t]}function Ts(t){return{fieldPath:t.canonicalString()}}function As(t){return mt.fromServerFormat(t.fieldPath)}function Rs(t){return ce.create(As(t.fieldFilter.field),function(){switch(t.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return L()}}(),t.fieldFilter.value)}function Ps(t){switch(t.unaryFilter.op){case"IS_NAN":var e=As(t.unaryFilter.field);return ce.create(e,"==",{doubleValue:NaN});case"IS_NULL":e=As(t.unaryFilter.field);return ce.create(e,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var n=As(t.unaryFilter.field);return ce.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":n=As(t.unaryFilter.field);return ce.create(n,"!=",{nullValue:"NULL_VALUE"});default:return L()}}function bs(t){const e=[];return t.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}function vs(t){return 4<=t.length&&"projects"===t.get(0)&&"databases"===t.get(2)}function Vs(e){let n="";for(let t=0;t<e.length;t++)0<n.length&&(n=Ds(n)),n=Ss(e.get(t),n);return Ds(n)}function Ss(e,t){let n=t;const r=e.length;for(let t=0;t<r;t++){const r=e.charAt(t);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}function Ds(t){return t+""}function Cs(n){const r=n.length;if(U(2<=r),2===r)return U(""===n.charAt(0)&&""===n.charAt(1)),_t.emptyPath();const s=r-2,i=[];let o="";for(let e=0;e<r;){const r=n.indexOf("",e);switch((r<0||r>s)&&L(),n.charAt(r+1)){case"":const s=n.substring(e,r);let t;0===o.length?t=s:(o+=s,t=o,o=""),i.push(t);break;case"":o+=n.substring(e,r),o+="\0";break;case"":o+=n.substring(e,r+1);break;default:L()}e=r+2}return new _t(i)}class Ns{constructor(t,e){this.seconds=t,this.nanoseconds=e}}class xs{constructor(t,e,n){this.ownerId=t,this.allowTabSynchronization=e,this.leaseTimestampMs=n}}xs.store="owner",xs.key="owner";class ks{constructor(t,e,n){this.userId=t,this.lastAcknowledgedBatchId=e,this.lastStreamToken=n}}ks.store="mutationQueues",ks.keyPath="userId";class Os{constructor(t,e,n,r,s){this.userId=t,this.batchId=e,this.localWriteTimeMs=n,this.baseMutations=r,this.mutations=s}}Os.store="mutations",Os.keyPath="batchId",Os.userMutationsIndex="userMutationsIndex",Os.userMutationsKeyPath=["userId","batchId"];class Ms{constructor(){}static prefixForUser(t){return[t]}static prefixForPath(t,e){return[t,Vs(e)]}static key(t,e,n){return[t,Vs(e),n]}}Ms.store="documentMutations",Ms.PLACEHOLDER=new Ms;class $s{constructor(t,e){this.path=t,this.readTime=e}}class Fs{constructor(t,e){this.path=t,this.version=e}}class Bs{constructor(t,e,n,r,s,i){this.unknownDocument=t,this.noDocument=e,this.document=n,this.hasCommittedMutations=r,this.readTime=s,this.parentPath=i}}Bs.store="remoteDocuments",Bs.readTimeIndex="readTimeIndex",Bs.readTimeIndexPath="readTime",Bs.collectionReadTimeIndex="collectionReadTimeIndex",Bs.collectionReadTimeIndexPath=["parentPath","readTime"];class Ls{constructor(t){this.byteSize=t}}Ls.store="remoteDocumentGlobal",Ls.key="remoteDocumentGlobalKey";class Us{constructor(t,e,n,r,s,i,o){this.targetId=t,this.canonicalId=e,this.readTime=n,this.resumeToken=r,this.lastListenSequenceNumber=s,this.lastLimboFreeSnapshotVersion=i,this.query=o}}Us.store="targets",Us.keyPath="targetId",Us.queryTargetsIndexName="queryTargetsIndex",Us.queryTargetsKeyPath=["canonicalId","targetId"];class qs{constructor(t,e,n){this.targetId=t,this.path=e,this.sequenceNumber=n}}qs.store="targetDocuments",qs.keyPath=["targetId","path"],qs.documentTargetsIndex="documentTargetsIndex",qs.documentTargetsKeyPath=["path","targetId"];class Ks{constructor(t,e,n,r){this.highestTargetId=t,this.highestListenSequenceNumber=e,this.lastRemoteSnapshotVersion=n,this.targetCount=r}}Ks.key="targetGlobalKey",Ks.store="targetGlobal";class Gs{constructor(t,e){this.collectionId=t,this.parent=e}}Gs.store="collectionParents",Gs.keyPath=["collectionId","parent"];class js{constructor(t,e,n,r){this.clientId=t,this.updateTimeMs=e,this.networkEnabled=n,this.inForeground=r}}js.store="clientMetadata",js.keyPath="clientId";class Qs{constructor(t,e,n){this.bundleId=t,this.createTime=e,this.version=n}}Qs.store="bundles",Qs.keyPath="bundleId";class Ws{constructor(t,e,n){this.name=t,this.readTime=e,this.bundledQuery=n}}Ws.store="namedQueries",Ws.keyPath="name";class zs{constructor(t,e,n){this.indexId=t,this.collectionGroup=e,this.fields=n}}zs.store="indexConfiguration",zs.keyPath="indexId",zs.collectionGroupIndex="collectionGroupIndex",zs.collectionGroupIndexPath="collectionGroup";class Hs{constructor(t,e,n,r,s,i){this.indexId=t,this.uid=e,this.sequenceNumber=n,this.readTime=r,this.documentKey=s,this.largestBatchId=i}}Hs.store="indexState",Hs.keyPath=["indexId","uid"],Hs.sequenceNumberIndex="sequenceNumberIndex",Hs.sequenceNumberIndexPath=["uid","sequenceNumber"];class Js{constructor(t,e,n,r,s){this.indexId=t,this.uid=e,this.arrayValue=n,this.directionalValue=r,this.documentKey=s}}Js.store="indexEntries",Js.keyPath=["indexId","uid","arrayValue","directionalValue","documentKey"],Js.documentKeyIndex="documentKeyIndex",Js.documentKeyIndexPath=["indexId","uid","documentKey"];class Ys{constructor(t,e,n,r,s,i){this.userId=t,this.collectionPath=e,this.documentId=n,this.collectionGroup=r,this.largestBatchId=s,this.overlayMutation=i}}Ys.store="documentOverlays",Ys.keyPath=["userId","collectionPath","documentId"],Ys.collectionPathOverlayIndex="collectionPathOverlayIndex",Ys.collectionPathOverlayIndexPath=["userId","collectionPath","largestBatchId"],Ys.collectionGroupOverlayIndex="collectionGroupOverlayIndex",Ys.collectionGroupOverlayIndexPath=["userId","collectionGroup","largestBatchId"];const Xs=[ks.store,Os.store,Ms.store,Bs.store,Us.store,xs.store,Ks.store,qs.store,js.store,Ls.store,Gs.store,Qs.store,Ws.store],Zs=[...Xs,Ys.store],ti=[...Zs,zs.store,Hs.store,Js.store],ei="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ni{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(t=>t())}}class si{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(t){return this.next(void 0,t)}next(r,s){return this.callbackAttached&&L(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new si((e,n)=>{this.nextCallback=t=>{this.wrapSuccess(r,t).next(e,n)},this.catchCallback=t=>{this.wrapFailure(s,t).next(e,n)}})}toPromise(){return new Promise((t,e)=>{this.next(t,e)})}wrapUserFunction(t){try{var e=t();return e instanceof si?e:si.resolve(e)}catch(t){return si.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction(()=>t(e)):si.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction(()=>t(e)):si.reject(e)}static resolve(n){return new si((t,e)=>{t(n)})}static reject(n){return new si((t,e)=>{e(n)})}static waitFor(t){return new si((e,n)=>{let r=0,s=0,i=!1;t.forEach(t=>{++r,t.next(()=>{++s,i&&s===r&&e()},t=>n(t))}),i=!0,s===r&&e()})}static or(t){let e=si.resolve(!1);for(const n of t)e=e.next(t=>t?si.resolve(t):n());return e}static forEach(t,n){const r=[];return t.forEach((t,e)=>{r.push(n.call(this,t,e))}),this.waitFor(r)}}class ii{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.At=new Q,this.transaction.oncomplete=()=>{this.At.resolve()},this.transaction.onabort=()=>{t.error?this.At.reject(new ci(e,t.error)):this.At.resolve()},this.transaction.onerror=t=>{t=fi(t.target.error);this.At.reject(new ci(e,t))}}static open(t,e,n,r){try{return new ii(e,t.transaction(r,n))}catch(t){throw new ci(e,t)}}get Rt(){return this.At.promise}abort(t){t&&this.At.reject(t),this.aborted||(M("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}Pt(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){t=this.transaction.objectStore(t);return new ai(t)}}class ri{constructor(t,e,n){this.name=t,this.version=e,this.bt=n,12.2===ri.vt(getUA())&&$("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return M("SimpleDb","Removing database:",t),hi(window.indexedDB.deleteDatabase(t)).toPromise()}static Vt(){if(!isIndexedDBAvailable())return!1;if(ri.St())return!0;const t=getUA(),e=ri.vt(t),n=0<e&&e<10,r=ri.Dt(t),s=0<r&&r<4.5;return!(0<t.indexOf("MSIE ")||0<t.indexOf("Trident/")||0<t.indexOf("Edge/")||n||s)}static St(){var t;return"undefined"!=typeof process&&"YES"===(null===(t=process.env)||void 0===t?void 0:t.Ct)}static Nt(t,e){return t.store(e)}static vt(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static Dt(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async xt(s){return this.db||(M("SimpleDb","Opening database:",this.name),this.db=await new Promise((e,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=t=>{t=t.target.result;e(t)},r.onblocked=()=>{n(new ci(s,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{t=t.target.error;"VersionError"===t.name?n(new j(G.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===t.name?n(new j(G.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+t)):n(new ci(s,t))},r.onupgradeneeded=t=>{M("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);var e=t.target.result;this.bt.kt(e,r.transaction,t.oldVersion,this.version).next(()=>{M("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.Ot&&(this.db.onversionchange=t=>this.Ot(t)),this.db}Mt(e){this.Ot=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(t,e,n,r){var s="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.xt(t);const e=ii.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).next(t=>(e.Pt(),t)).catch(t=>(e.abort(t),si.reject(t))).toPromise();return i.catch(()=>{}),await e.Rt,i}catch(t){const e="FirebaseError"!==t.name&&i<3;if(M("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class oi{constructor(t){this.$t=t,this.Ft=!1,this.Bt=null}get isDone(){return this.Ft}get Lt(){return this.Bt}set cursor(t){this.$t=t}done(){this.Ft=!0}Ut(t){this.Bt=t}delete(){return hi(this.$t.delete())}}class ci extends j{constructor(t,e){super(G.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function ui(t){return"IndexedDbTransactionError"===t.name}class ai{constructor(t){this.store=t}put(t,e){let n;return n=void 0!==e?(M("SimpleDb","PUT",this.store.name,t,e),this.store.put(e,t)):(M("SimpleDb","PUT",this.store.name,"<auto-key>",t),this.store.put(t)),hi(n)}add(t){return M("SimpleDb","ADD",this.store.name,t,t),hi(this.store.add(t))}get(e){return hi(this.store.get(e)).next(t=>(M("SimpleDb","GET",this.store.name,e,t=void 0===t?null:t),t))}delete(t){return M("SimpleDb","DELETE",this.store.name,t),hi(this.store.delete(t))}count(){return M("SimpleDb","COUNT",this.store.name),hi(this.store.count())}qt(t,e){e=this.options(t,e);if(e.index||"function"!=typeof this.store.getAll){const t=this.cursor(e),n=[];return this.Kt(t,(t,e)=>{n.push(e)}).next(()=>n)}{const t=this.store.getAll(e.range);return new si((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}})}}Gt(t,e){M("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.jt=!1;e=this.cursor(n);return this.Kt(e,(t,e,n)=>n.delete())}Qt(t,e){let n;e?n=t:(n={},e=t);t=this.cursor(n);return this.Kt(t,e)}Wt(r){const t=this.cursor({});return new si((n,e)=>{t.onerror=t=>{t=fi(t.target.error);e(t)},t.onsuccess=t=>{const e=t.target.result;e?r(e.primaryKey,e.value).next(t=>{t?e.continue():n()}):n()}})}Kt(t,i){const o=[];return new si((s,e)=>{t.onerror=t=>{e(t.target.error)},t.onsuccess=t=>{const e=t.target.result;if(e){const n=new oi(e),r=i(e.primaryKey,e.value,n);if(r instanceof si){const t=r.catch(t=>(n.done(),si.reject(t)));o.push(t)}n.isDone?s():null===n.Lt?e.continue():e.continue(n.Lt)}else s()}}).next(()=>si.waitFor(o))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.jt?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function hi(t){return new si((e,n)=>{t.onsuccess=t=>{t=t.target.result;e(t)},t.onerror=t=>{t=fi(t.target.error);n(t)}})}let li=!1;function fi(t){const e=ri.vt(getUA());if(12.2<=e&&e<13){const e="An internal error was encountered in the Indexed Database server";if(0<=t.message.indexOf(e)){const t=new j("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return li||(li=!0,setTimeout(()=>{throw t},0)),t}}return t}class di extends ni{constructor(t,e){super(),this.zt=t,this.currentSequenceNumber=e}}function _i(t,e){t=K(t);return ri.Nt(t.zt,e)}class wi{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];r.key.isEqual(e.key)&&on(r,e,n[t])}}applyToLocalView(t){for(const e of this.baseMutations)e.key.isEqual(t.key)&&cn(e,t,this.localWriteTime);for(const n of this.mutations)n.key.isEqual(t.key)&&cn(n,t,this.localWriteTime)}applyToLocalDocumentSet(r){this.mutations.forEach(t=>{const e=r.get(t.key),n=e;this.applyToLocalView(n),e.isValidDocument()||n.convertToNoDocument(at.min())})}keys(){return this.mutations.reduce((t,e)=>t.add(e.key),On())}isEqual(t){return this.batchId===t.batchId&&ot(this.mutations,t.mutations,(t,e)=>an(t,e))&&ot(this.baseMutations,t.baseMutations,(t,e)=>an(t,e))}}class mi{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){U(t.mutations.length===n.length);let r=xn;var s=t.mutations;for(let t=0;t<s.length;t++)r=r.insert(s[t].key,n[t].version);return new mi(t,e,n,r)}}class gi{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class yi{constructor(t,e,n,r,s=at.min(),i=at.min(),o=pt.EMPTY_BYTE_STRING){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(t){return new yi(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(t,e){return new yi(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t)}withLastLimboFreeSnapshotVersion(t){return new yi(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken)}}class pi{constructor(t){this.Ht=t}}function Ii(t,e){let n;if(e.document)n=as(t.Ht,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=Nt.fromSegments(e.noDocument.path),r=Pi(e.noDocument.readTime);n=Jt.newNoDocument(t,r),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return L();{const t=Nt.fromSegments(e.unknownDocument.path),s=Pi(e.unknownDocument.version);n=Jt.newUnknownDocument(t,s)}}return e.readTime&&n.setReadTime(Ai(e.readTime)),n}function Ei(t,e){var n=Ti(e.readTime),r=e.key.path.popLast().toArray();if(e.isFoundDocument()){var s={name:ns(s=t.Ht,(t=e).key),fields:t.data.value.mapValue.fields,updateTime:Jn(s,t.version.toTimestamp())},t=e.hasCommittedMutations;return new Bs(null,null,s,t,n,r)}if(e.isNoDocument()){const i=e.key.path.toArray(),o=Ri(e.version),a=e.hasCommittedMutations;return new Bs(null,new $s(i,o),null,a,n,r)}if(e.isUnknownDocument()){const i=e.key.path.toArray(),c=Ri(e.version);return new Bs(new Fs(i,c),null,null,!0,n,r)}return L()}function Ti(t){t=t.toTimestamp();return[t.seconds,t.nanoseconds]}function Ai(t){t=new ut(t[0],t[1]);return at.fromTimestamp(t)}function Ri(t){t=t.toTimestamp();return new Ns(t.seconds,t.nanoseconds)}function Pi(t){t=new ut(t.seconds,t.nanoseconds);return at.fromTimestamp(t)}function bi(e,n){const r=(n.baseMutations||[]).map(t=>ds(e.Ht,t));for(let t=0;t<n.mutations.length-1;++t){const r=n.mutations[t];if(t+1<n.mutations.length&&void 0!==n.mutations[t+1].transform){const s=n.mutations[t+1];r.updateTransforms=s.transform.fieldTransforms,n.mutations.splice(t+1,1),++t}}const s=n.mutations.map(t=>ds(e.Ht,t)),t=ut.fromMillis(n.localWriteTimeMs);return new wi(n.batchId,t,r,s)}function vi(t){var e,n=Pi(t.readTime),r=void 0!==t.lastLimboFreeSnapshotVersion?Pi(t.lastLimboFreeSnapshotVersion):at.min();let s;return s=void 0!==t.query.documents?(U(1===(e=t.query).documents.length),De(Ae(rs(e.documents[0])))):De(gs(t.query)),new yi(s,t.targetId,0,t.lastListenSequenceNumber,n,r,pt.fromBase64String(t.resumeToken))}function Vi(t,e){var n=Ri(e.snapshotVersion),r=Ri(e.lastLimboFreeSnapshotVersion),s=(oe(e.target)?ws:ms)(t.Ht,e.target),t=e.resumeToken.toBase64();return new Us(e.targetId,se(e.target),n,t,e.sequenceNumber,r,s)}function Si(t){var e=gs({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?Ce(e,e.limit,"L"):e}function Di(t,e){return new gi(e.largestBatchId,ds(t.Ht,e.overlayMutation))}function Ci(t,e){var n=e.path.lastSegment();return[t,Vs(e.path.popLast()),n]}class Ni{getBundleMetadata(t,e){return xi(t).get(e).next(t=>{if(t)return{id:(t=t).bundleId,createTime:Pi(t.createTime),version:t.version}})}saveBundleMetadata(t,e){return xi(t).put({bundleId:(e=e).id,createTime:Ri(Zn(e.createTime)),version:e.version})}getNamedQuery(t,e){return ki(t).get(e).next(t=>{if(t)return{name:(t=t).name,query:Si(t.bundledQuery),readTime:Pi(t.readTime)}})}saveNamedQuery(t,e){return ki(t).put({name:(e=e).name,readTime:Ri(Zn(e.readTime)),bundledQuery:e.bundledQuery})}}function xi(t){return _i(t,Qs.store)}function ki(t){return _i(t,Ws.store)}class Oi{constructor(t,e){this.O=t,this.userId=e}static Jt(t,e){e=e.uid||"";return new Oi(t,e)}getOverlay(t,e){return Mi(t).get(Ci(this.userId,e)).next(t=>t?Di(this.O,t):null)}saveOverlays(e,n,t){const r=[];return t.forEach(t=>{t=new gi(n,t);r.push(this.Yt(e,t))}),si.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach(t=>r.add(Vs(t.getCollectionPath())));const s=[];return r.forEach(t=>{t=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(Mi(e).Gt(Ys.collectionPathOverlayIndex,t))}),si.waitFor(s)}getOverlaysForCollection(t,e,n){const r=new Map,s=Vs(e),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Mi(t).qt(Ys.collectionPathOverlayIndex,i).next(t=>{for(const e of t){const t=Di(this.O,e);r.set(t.getKey(),t)}return r})}getOverlaysForCollectionGroup(t,e,n,s){const i=new Map;let o;e=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return Mi(t).Qt({index:Ys.collectionGroupOverlayIndex,range:e},(t,e,n)=>{const r=Di(this.O,e);i.size<s||r.largestBatchId===o?(i.set(r.getKey(),r),o=r.largestBatchId):n.done()}).next(()=>i)}Yt(t,e){return Mi(t).put(function(t,e,n){var[,r,s]=Ci(e,n.mutation.key);return new Ys(e,r,s,n.mutation.key.getCollectionGroup(),n.largestBatchId,fs(t.Ht,n.mutation))}(this.O,this.userId,e))}}function Mi(t){return _i(t,Ys.store)}class $i{constructor(){}Xt(t,e){this.Zt(t,e),e.te()}Zt(t,e){var n,r;"nullValue"in t?this.ee(e,5):"booleanValue"in t?(this.ee(e,10),e.ne(t.booleanValue?1:0)):"integerValue"in t?(this.ee(e,15),e.ne(Tt(t.integerValue))):"doubleValue"in t?(n=Tt(t.doubleValue),isNaN(n)?this.ee(e,13):(this.ee(e,15),Dt(n)?e.ne(0):e.ne(n))):"timestampValue"in t?(r=t.timestampValue,this.ee(e,20),"string"==typeof r?e.se(r):(e.se(`${r.seconds||""}`),e.ne(r.nanos||0))):"stringValue"in t?(this.ie(t.stringValue,e),this.re(e)):"bytesValue"in t?(this.ee(e,30),e.oe(At(t.bytesValue)),this.re(e)):"referenceValue"in t?this.ce(t.referenceValue,e):"geoPointValue"in t?(r=t.geoPointValue,this.ee(e,45),e.ne(r.latitude||0),e.ne(r.longitude||0)):"mapValue"in t?Ot(t,xt)?this.ee(e,Number.MAX_SAFE_INTEGER):(this.ue(t.mapValue,e),this.re(e)):"arrayValue"in t?(this.ae(t.arrayValue,e),this.re(e)):L()}ie(t,e){this.ee(e,25),this.he(t,e)}he(t,e){e.se(t)}ue(t,e){var n=t.fields||{};this.ee(e,55);for(const t of Object.keys(n))this.ie(t,e),this.Zt(n[t],e)}ae(t,e){t=t.values||[];this.ee(e,50);for(const n of t)this.Zt(n,e)}ce(t,e){this.ee(e,37),Nt.fromName(t).path.forEach(t=>{this.ee(e,60),this.he(t,e)})}ee(t,e){t.ne(e)}re(t){t.ne(2)}}function Fi(t){if(0===t)return 8;let e=0;return t>>4==0&&(e+=4,t<<=4),t>>6==0&&(e+=2,t<<=2),t>>7==0&&(e+=1),e}function Bi(t){t=64-function(e){let n=0;for(let t=0;t<8;++t){var r=Fi(255&e[t]);if(n+=r,8!==r)break}return n}(t);return Math.ceil(t/8)}$i.le=new $i;class Li{constructor(){this.buffer=new Uint8Array(1024),this.position=0}fe(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.de(n.value),n=e.next();this._e()}we(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.me(n.value),n=e.next();this.ge()}ye(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.de(t);else if(t<2048)this.de(960|t>>>6),this.de(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.de(480|t>>>12),this.de(128|63&t>>>6),this.de(128|63&t);else{const t=e.codePointAt(0);this.de(240|t>>>18),this.de(128|63&t>>>12),this.de(128|63&t>>>6),this.de(128|63&t)}}this._e()}pe(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.me(t);else if(t<2048)this.me(960|t>>>6),this.me(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.me(480|t>>>12),this.me(128|63&t>>>6),this.me(128|63&t);else{const t=e.codePointAt(0);this.me(240|t>>>18),this.me(128|63&t>>>12),this.me(128|63&t>>>6),this.me(128|63&t)}}this.ge()}Ie(e){var n=this.Ee(e),e=Bi(n);this.Te(1+e),this.buffer[this.position++]=255&e;for(let t=n.length-e;t<n.length;++t)this.buffer[this.position++]=255&n[t]}Ae(e){var n=this.Ee(e),e=Bi(n);this.Te(1+e),this.buffer[this.position++]=~(255&e);for(let t=n.length-e;t<n.length;++t)this.buffer[this.position++]=~(255&n[t])}Re(){this.Pe(255),this.Pe(255)}be(){this.ve(255),this.ve(255)}reset(){this.position=0}seed(t){this.Te(t.length),this.buffer.set(t,this.position),this.position+=t.length}Ve(){return this.buffer.slice(0,this.position)}Ee(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=0!=(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}de(t){t&=255;0==t?(this.Pe(0),this.Pe(255)):255==t?(this.Pe(255),this.Pe(0)):this.Pe(t)}me(t){var e=255&t;0==e?(this.ve(0),this.ve(255)):255==e?(this.ve(255),this.ve(0)):this.ve(t)}_e(){this.Pe(0),this.Pe(1)}ge(){this.ve(0),this.ve(1)}Pe(t){this.Te(1),this.buffer[this.position++]=t}ve(t){this.Te(1),this.buffer[this.position++]=~t}Te(e){e+=this.position;if(!(e<=this.buffer.length)){let t=2*this.buffer.length;t<e&&(t=e);const n=new Uint8Array(t);n.set(this.buffer),this.buffer=n}}}class Ui{constructor(t){this.Se=t}oe(t){this.Se.fe(t)}se(t){this.Se.ye(t)}ne(t){this.Se.Ie(t)}te(){this.Se.Re()}}class qi{constructor(t){this.Se=t}oe(t){this.Se.we(t)}se(t){this.Se.pe(t)}ne(t){this.Se.Ae(t)}te(){this.Se.be()}}class Ki{constructor(){this.Se=new Li,this.De=new Ui(this.Se),this.Ce=new qi(this.Se)}seed(t){this.Se.seed(t)}Ne(t){return 0===t?this.De:this.Ce}Ve(){return this.Se.Ve()}reset(){this.Se.reset()}}class Gi{constructor(t,e,n,r){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=r}}function ji(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=Nt.comparator(t.documentKey,e.documentKey),0!==n?n:(n=Qi(t.arrayValue,e.arrayValue),0!==n?n:Qi(t.directionalValue,e.directionalValue)))}function Qi(e,n){for(let t=0;t<e.length&&t<n.length;++t){var r=e[t]-n[t];if(0!=r)return r}return e.length-n.length}class Wi{constructor(){this.xe=new zi}addToCollectionParentIndex(t,e){return this.xe.add(e),si.resolve()}getCollectionParents(t,e){return si.resolve(this.xe.getEntries(e))}addFieldIndex(t,e){return si.resolve()}deleteFieldIndex(t,e){return si.resolve()}getDocumentsMatchingTarget(t,e,n){return si.resolve(On())}getFieldIndex(t,e){return si.resolve(null)}getFieldIndexes(t,e){return si.resolve([])}getNextCollectionGroupToUpdate(t){return si.resolve(null)}updateCollectionGroup(t,e,n){return si.resolve()}updateIndexEntries(t,e){return si.resolve()}}class zi{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new bn(_t.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new bn(_t.comparator)).toArray()}}class Hi{constructor(t){this.user=t,this.ke=new zi,this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(this.ke.has(e))return si.resolve();var n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener(()=>{this.ke.add(e)});r={collectionId:n,parent:Vs(r)};return Ji(t).put(r)}getCollectionParents(t,n){const r=[],e=IDBKeyRange.bound([n,""],[ct(n),""],!1,!0);return Ji(t).qt(e).next(t=>{for(const e of t){if(e.collectionId!==n)break;r.push(Cs(e.parent))}return r})}addFieldIndex(t,e){const n=Xi(t),r=(e=e,new zs(e.indexId,e.collectionGroup,e.fields.map(t=>[t.fieldPath.canonicalString(),t.kind])));return delete r.indexId,n.add(r).next()}deleteFieldIndex(t,e){const n=Xi(t),r=Zi(t),s=Yi(t);return n.delete(e.indexId).next(()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))}getDocumentsMatchingTarget(t,e,n){return si.resolve(On())}getFieldIndex(t,e){return si.resolve(null)}Oe(t,e){const n=new Ki;for(const s of t.fields.filter(t=>2!==t.kind)){const t=e.data.field(s.fieldPath);if(null==t)return null;var r=n.Ne(s.kind);$i.le.Xt(t,r)}return n.Ve()}Me(t){const e=new Ki;return $i.le.Xt(t,e.Ne(0)),e.Ve()}getFieldIndexes(t,e){const n=Xi(t),i=Zi(t);return(e?n.qt(zs.collectionGroupIndex,IDBKeyRange.bound(e,e)):n.qt()).next(t=>{const s=[];return si.forEach(t,r=>i.get([r.indexId,this.uid]).next(t=>{var e,n;s.push((e=r,t=(n=t)?new Zt(n.sequenceNumber,new te(Pi(n.readTime),new Nt(Cs(n.documentKey)),n.largestBatchId)):Zt.empty(),n=e.fields.map(([t,e])=>new Xt(mt.fromServerFormat(t),e)),new Yt(e.indexId,e.collectionGroup,n,t)))})).next(()=>s)})}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next(t=>0===t.length?null:(t.sort((t,e)=>t.indexState.sequenceNumber-e.indexState.sequenceNumber),t[0].collectionGroup))}updateCollectionGroup(t,n,r){const s=Xi(t),i=Zi(t);return this.$e(t).next(e=>s.qt(zs.collectionGroupIndex,IDBKeyRange.bound(n,n)).next(t=>si.forEach(t,t=>i.put(function(t,e,n,r){return new Hs(t,e.uid||"",n,Ri(r.readTime),Vs(r.documentKey.path),r.largestBatchId)}(t.indexId,this.user,e,r)))))}updateIndexEntries(s,t){const n=new Map;return si.forEach(t,(e,r)=>{var t=n.get(e.collectionGroup);return(t?si.resolve(t):this.getFieldIndexes(s,e.collectionGroup)).next(t=>(n.set(e.collectionGroup,t),si.forEach(t,n=>this.Fe(s,e,n).next(t=>{var e=this.Be(r,n);return t.isEqual(e)?si.resolve():this.Le(s,r,t,e)}))))})}Ue(t,e,n){return Yi(t).put(new Js(n.indexId,this.uid,n.arrayValue,n.directionalValue,Vs(e.key.path)))}qe(t,e,n){return Yi(t).delete([n.indexId,this.uid,n.arrayValue,n.directionalValue,Vs(e.key.path)])}Fe(t,n,r){const e=Yi(t);let s=new bn(ji);return e.Qt({index:Js.documentKeyIndex,range:IDBKeyRange.only([r.indexId,this.uid,Vs(n.path)])},(t,e)=>{s=s.add(new Gi(r.indexId,n,e.arrayValue,e.directionalValue))}).next(()=>s)}Be(t,e){let n=new bn(ji);var r=this.Oe(e,t);if(null==r)return n;const s=e.fields.find(t=>2===t.kind);if(null!=s){var i=t.data.field(s.fieldPath);if(Kt(i))for(const s of i.arrayValue.values||[])n=n.add(new Gi(e.indexId,t.key,this.Me(s),r))}else n=n.add(new Gi(e.indexId,t.key,new Uint8Array,r));return n}Le(e,n,u,t){M("IndexedDbIndexManager","Updating index entries for document '%s'",n.key);const r=[];return function(t,n,r,s){var i=u.getIterator(),o=t.getIterator();let a=Vn(i),c=Vn(o);for(;a||c;){let t=!1,e=!1;if(a&&c){const r=n(a,c);r<0?e=!0:0<r&&(t=!0)}else null!=a?e=!0:t=!0;t?(r(c),c=Vn(o)):e?(s(a),a=Vn(i)):(a=Vn(i),c=Vn(o))}}(t,ji,t=>{r.push(this.Ue(e,n,t))},t=>{r.push(this.qe(e,n,t))}),si.waitFor(r)}$e(t){let r=1;return Zi(t).Qt({index:Hs.sequenceNumberIndex,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(t,e,n)=>{n.done(),r=e.sequenceNumber+1}).next(()=>r)}}function Ji(t){return _i(t,Gs.store)}function Yi(t){return _i(t,Js.store)}function Xi(t){return _i(t,zs.store)}function Zi(t){return _i(t,Hs.store)}const tr={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class er{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new er(t,er.DEFAULT_COLLECTION_PERCENTILE,er.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function nr(t,e,n){const r=t.store(Os.store),s=t.store(Ms.store),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=r.Qt({range:o},(t,e,n)=>(a++,n.delete()));i.push(c.next(()=>{U(1===a)}));const u=[];for(const t of n.mutations){const r=Ms.key(e,t.key.path,n.batchId);i.push(s.delete(r)),u.push(t.key)}return si.waitFor(i).next(()=>u)}function sr(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw L();e=t.noDocument}return JSON.stringify(e).length}er.DEFAULT_COLLECTION_PERCENTILE=10,er.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,er.DEFAULT=new er(41943040,er.DEFAULT_COLLECTION_PERCENTILE,er.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),er.DISABLED=new er(-1,0,0);class ir{constructor(t,e,n,r){this.userId=t,this.O=e,this.indexManager=n,this.referenceDelegate=r,this.Ke={}}static Jt(t,e,n,r){U(""!==t.uid);t=t.isAuthenticated()?t.uid:"";return new ir(t,e,n,r)}checkEmpty(t){let r=!0;var e=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return or(t).Qt({index:Os.userMutationsIndex,range:e},(t,e,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(h,l,d,f){const g=cr(h),m=or(h);return m.add({}).next(t=>{U("number"==typeof t);const e=new wi(t,l,d,f),n=(s=this.O,i=this.userId,o=e,a=o.baseMutations.map(t=>fs(s.Ht,t)),c=o.mutations.map(t=>fs(s.Ht,t)),new Os(i,o.batchId,o.localWriteTime.toMillis(),a,c)),r=[];var s,i,o,a,c;let u=new bn((t,e)=>rt(t.canonicalString(),e.canonicalString()));for(const h of f){const l=Ms.key(this.userId,h.key.path,t);u=u.add(h.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,Ms.PLACEHOLDER))}return u.forEach(t=>{r.push(this.indexManager.addToCollectionParentIndex(h,t))}),h.addOnCommittedListener(()=>{this.Ke[t]=e.keys()}),si.waitFor(r).next(()=>e)})}lookupMutationBatch(t,e){return or(t).get(e).next(t=>t?(U(t.userId===this.userId),bi(this.O,t)):null)}Ge(t,e){return this.Ke[e]?si.resolve(this.Ke[e]):this.lookupMutationBatch(t,e).next(t=>{if(t){t=t.keys();return this.Ke[e]=t}return null})}getNextMutationBatchAfterBatchId(t,e){const r=e+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return or(t).Qt({index:Os.userMutationsIndex,range:n},(t,e,n)=>{e.userId===this.userId&&(U(e.batchId>=r),s=bi(this.O,e)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(t){var e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return or(t).Qt({index:Os.userMutationsIndex,range:e,reverse:!0},(t,e,n)=>{r=e.batchId,n.done()}).next(()=>r)}getAllMutationBatches(t){var e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return or(t).qt(Os.userMutationsIndex,e).next(t=>t.map(t=>bi(this.O,t)))}getAllMutationBatchesAffectingDocumentKey(i,o){const t=Ms.prefixForPath(this.userId,o.path),e=IDBKeyRange.lowerBound(t),a=[];return cr(i).Qt({range:e},(t,e,n)=>{var[r,s,t]=t,s=Cs(s);if(r===this.userId&&o.path.isEqual(s))return or(i).get(t).next(t=>{if(!t)throw L();U(t.userId===this.userId),a.push(bi(this.O,t))});n.done()}).next(()=>a)}getAllMutationBatchesAffectingDocumentKeys(e,t){let o=new bn(rt);const n=[];return t.forEach(i=>{var t=Ms.prefixForPath(this.userId,i.path),t=IDBKeyRange.lowerBound(t),t=cr(e).Qt({range:t},(t,e,n)=>{var[r,s,t]=t,s=Cs(s);r===this.userId&&i.path.isEqual(s)?o=o.add(t):n.done()});n.push(t)}),si.waitFor(n).next(()=>this.je(e,o))}getAllMutationBatchesAffectingQuery(t,e){const i=e.path,o=i.length+1,n=Ms.prefixForPath(this.userId,i),r=IDBKeyRange.lowerBound(n);let a=new bn(rt);return cr(t).Qt({range:r},(t,e,n)=>{var[r,s,t]=t,s=Cs(s);r===this.userId&&i.isPrefixOf(s)?s.length===o&&(a=a.add(t)):n.done()}).next(()=>this.je(t,a))}je(e,t){const n=[],r=[];return t.forEach(t=>{r.push(or(e).get(t).next(t=>{if(null===t)throw L();U(t.userId===this.userId),n.push(bi(this.O,t))}))}),si.waitFor(r).next(()=>n)}removeMutationBatch(e,n){return nr(e.zt,this.userId,n).next(t=>(e.addOnCommittedListener(()=>{this.Qe(n.batchId)}),si.forEach(t,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}Qe(t){delete this.Ke[t]}performConsistencyCheck(n){return this.checkEmpty(n).next(t=>{if(!t)return si.resolve();const e=IDBKeyRange.lowerBound(Ms.prefixForUser(this.userId)),r=[];return cr(n).Qt({range:e},(t,e,n)=>{if(t[0]===this.userId){const e=Cs(t[1]);r.push(e)}else n.done()}).next(()=>{U(0===r.length)})})}containsKey(t,e){return rr(t,this.userId,e)}We(t){return ur(t).get(this.userId).next(t=>t||new ks(this.userId,-1,""))}}function rr(t,s,e){const n=Ms.prefixForPath(s,e.path),i=n[1],r=IDBKeyRange.lowerBound(n);let o=!1;return cr(t).Qt({range:r,jt:!0},(t,e,n)=>{var[r,t]=t;r===s&&t===i&&(o=!0),n.done()}).next(()=>o)}function or(t){return _i(t,Os.store)}function cr(t){return _i(t,Ms.store)}function ur(t){return _i(t,ks.store)}class ar{constructor(t){this.ze=t}next(){return this.ze+=2,this.ze}static He(){return new ar(0)}static Je(){return new ar(-1)}}class hr{constructor(t,e){this.referenceDelegate=t,this.O=e}allocateTargetId(n){return this.Ye(n).next(t=>{const e=new ar(t.highestTargetId);return t.highestTargetId=e.next(),this.Xe(n,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(t){return this.Ye(t).next(t=>at.fromTimestamp(new ut(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(t){return this.Ye(t).next(t=>t.highestListenSequenceNumber)}setTargetsMetadata(e,n,r){return this.Ye(e).next(t=>(t.highestListenSequenceNumber=n,r&&(t.lastRemoteSnapshotVersion=r.toTimestamp()),n>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=n),this.Xe(e,t)))}addTargetData(e,n){return this.Ze(e,n).next(()=>this.Ye(e).next(t=>(t.targetCount+=1,this.tn(n,t),this.Xe(e,t))))}updateTargetData(t,e){return this.Ze(t,e)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>lr(e).delete(t.targetId)).next(()=>this.Ye(e)).next(t=>(U(0<t.targetCount),--t.targetCount,this.Xe(e,t)))}removeTargets(n,r,s){let i=0;const o=[];return lr(n).Qt((t,e)=>{e=vi(e);e.sequenceNumber<=r&&null===s.get(e.targetId)&&(i++,o.push(this.removeTargetData(n,e)))}).next(()=>si.waitFor(o)).next(()=>i)}forEachTarget(t,n){return lr(t).Qt((t,e)=>{e=vi(e);n(e)})}Ye(t){return fr(t).get(Ks.key).next(t=>(U(null!==t),t))}Xe(t,e){return fr(t).put(Ks.key,e)}Ze(t,e){return lr(t).put(Vi(this.O,e))}tn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.Ye(t).next(t=>t.targetCount)}getTargetData(t,r){var e=se(r),e=IDBKeyRange.bound([e,Number.NEGATIVE_INFINITY],[e,Number.POSITIVE_INFINITY]);let s=null;return lr(t).Qt({range:e,index:Us.queryTargetsIndexName},(t,e,n)=>{e=vi(e);re(r,e.target)&&(s=e,n.done())}).next(()=>s)}addMatchingKeys(n,t,r){const s=[],i=dr(n);return t.forEach(t=>{var e=Vs(t.path);s.push(i.put(new qs(r,e))),s.push(this.referenceDelegate.addReference(n,r,t))}),si.waitFor(s)}removeMatchingKeys(n,t,r){const s=dr(n);return si.forEach(t,t=>{var e=Vs(t.path);return si.waitFor([s.delete([r,e]),this.referenceDelegate.removeReference(n,r,t)])})}removeMatchingKeysForTargetId(t,e){const n=dr(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=dr(t);let s=On();return r.Qt({range:n,jt:!0},(t,e,n)=>{t=Cs(t[1]),t=new Nt(t);s=s.add(t)}).next(()=>s)}containsKey(t,e){e=Vs(e.path),e=IDBKeyRange.bound([e],[ct(e)],!1,!0);let r=0;return dr(t).Qt({index:qs.documentTargetsIndex,jt:!0,range:e},([t],e,n)=>{0!==t&&(r++,n.done())}).next(()=>0<r)}Tt(t,e){return lr(t).get(e).next(t=>t?vi(t):null)}}function lr(t){return _i(t,Us.store)}function fr(t){return _i(t,Ks.store)}function dr(t){return _i(t,qs.store)}async function _r(t){if(t.code!==G.FAILED_PRECONDITION||t.message!==ei)throw t;M("LocalStore","Unexpectedly lost primary lease")}function wr([t,e],[n,r]){n=rt(t,n);return 0===n?rt(e,r):n}class mr{constructor(t){this.en=t,this.buffer=new bn(wr),this.nn=0}sn(){return++this.nn}rn(t){t=[t,this.sn()];if(this.buffer.size<this.en)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();wr(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class gr{constructor(t,e){this.garbageCollector=t,this.asyncQueue=e,this.on=!1,this.cn=null}start(t){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.un(t)}stop(){this.cn&&(this.cn.cancel(),this.cn=null)}get started(){return null!==this.cn}un(t){var e=this.on?3e5:6e4;M("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.cn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.cn=null,this.on=!0;try{await t.collectGarbage(this.garbageCollector)}catch(t){ui(t)?M("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await _r(t)}await this.un(t)})}}class yr{constructor(t,e){this.an=t,this.params=e}calculateTargetCount(t,e){return this.an.hn(t).next(t=>Math.floor(e/100*t))}nthSequenceNumber(t,e){if(0===e)return si.resolve(nt.A);const n=new mr(e);return this.an.forEachTarget(t,t=>n.rn(t.sequenceNumber)).next(()=>this.an.ln(t,t=>n.rn(t))).next(()=>n.maxValue)}removeTargets(t,e,n){return this.an.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.an.removeOrphanedDocuments(t,e)}collect(e,n){return-1===this.params.cacheSizeCollectionThreshold?(M("LruGarbageCollector","Garbage collection skipped; disabled"),si.resolve(tr)):this.getCacheSize(e).next(t=>t<this.params.cacheSizeCollectionThreshold?(M("LruGarbageCollector",`Garbage collection skipped; Cache size ${t} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),tr):this.fn(e,n))}getCacheSize(t){return this.an.getCacheSize(t)}fn(e,n){let r,s,i,o,a,c,u;const h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(s=t>this.params.maximumSequenceNumbersToCollect?(M("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),this.params.maximumSequenceNumbersToCollect):t,o=Date.now(),this.nthSequenceNumber(e,s))).next(t=>(r=t,a=Date.now(),this.removeTargets(e,r,n))).next(t=>(i=t,c=Date.now(),this.removeOrphanedDocuments(e,r))).next(t=>(u=Date.now(),k()<=LogLevel.DEBUG&&M("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-h}ms\n\tDetermined least recently used ${s} in `+(a-o)+"ms\n"+`\tRemoved ${i} targets in `+(c-a)+"ms\n"+`\tRemoved ${t} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-h}ms`),si.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:t})))}}class pr{constructor(t,e){this.db=t,this.garbageCollector=(t=this,e=e,new yr(t,e))}hn(t){const n=this.dn(t);return this.db.getTargetCache().getTargetCount(t).next(e=>n.next(t=>e+t))}dn(t){let e=0;return this.ln(t,t=>{e++}).next(()=>e)}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}ln(t,n){return this._n(t,(t,e)=>n(e))}addReference(t,e,n){return Ir(t,n)}removeReference(t,e,n){return Ir(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return Ir(t,e)}wn(e,n){let r=!1;return ur(e).Wt(t=>rr(e,t,n).next(t=>(t&&(r=!0),si.resolve(!t)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let o=0;return this._n(n,(e,t)=>{if(t<=r){const r=this.wn(n,e).next(t=>{if(!t)return o++,s.getEntry(n,e).next(()=>(s.removeEntry(e,at.min()),dr(n).delete([0,Vs(e.path)])))});i.push(r)}}).next(()=>si.waitFor(i)).next(()=>s.apply(n)).next(()=>o)}removeTarget(t,e){e=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,e)}updateLimboDocument(t,e){return Ir(t,e)}_n(t,r){const e=dr(t);let s,i=nt.A;return e.Qt({index:qs.documentTargetsIndex},([t],{path:e,sequenceNumber:n})=>{0===t?(i!==nt.A&&r(new Nt(Cs(s)),i),i=n,s=e):i=nt.A}).next(()=>{i!==nt.A&&r(new Nt(Cs(s)),i)})}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function Ir(t,e){return dr(t).put((e=e,t=t.currentSequenceNumber,new qs(0,Vs(e.path),t)))}class Er{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={}}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,r]of n)if(this.equalsFn(e,t))return r}has(t){return void 0!==this.get(t)}set(e,n){const t=this.mapKeyFn(e),r=this.inner[t];if(void 0!==r){for(let t=0;t<r.length;t++)if(this.equalsFn(r[t][0],e))return void(r[t]=[e,n]);r.push([e,n])}else this.inner[t]=[[e,n]]}delete(e){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return!1;for(let t=0;t<r.length;t++)if(this.equalsFn(r[t][0],e))return 1===r.length?delete this.inner[n]:r.splice(t,1),!0;return!1}forEach(r){lt(this.inner,(t,e)=>{for(const[t,n]of e)r(t,n)})}isEmpty(){return ft(this.inner)}}class Tr{constructor(){this.changes=new Er(t=>t.toString(),(t,e)=>t.isEqual(e)),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,Jt.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();var n=this.changes.get(e);return void 0!==n?si.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Ar{constructor(t){this.O=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return br(t).put(vr(e),n)}removeEntry(t,e){const n=br(t),r=vr(e);return n.delete(r)}updateMetadata(e,n){return this.getMetadata(e).next(t=>(t.byteSize+=n,this.mn(e,t)))}getEntry(t,e){return br(t).get(vr(e)).next(t=>this.gn(e,t))}yn(t,e){return br(t).get(vr(e)).next(t=>({document:this.gn(e,t),size:sr(t)}))}getEntries(t,e){let n=Dn();return this.pn(t,e,(t,e)=>{e=this.gn(t,e);n=n.insert(t,e)}).next(()=>n)}In(t,e){let r=Dn(),s=new An(Nt.comparator);return this.pn(t,e,(t,e)=>{var n=this.gn(t,e);r=r.insert(t,n),s=s.insert(t,sr(e))}).next(()=>({documents:r,En:s}))}pn(t,e,s){if(e.isEmpty())return si.resolve();const n=IDBKeyRange.bound(e.first().path.toArray(),e.last().path.toArray()),i=e.getIterator();let o=i.getNext();return br(t).Qt({range:n},(t,e,n)=>{for(var r=Nt.fromSegments(t);o&&Nt.comparator(o,r)<0;)s(o,null),o=i.getNext();o&&o.isEqual(r)&&(s(o,e),o=i.hasNext()?i.getNext():null),o?n.Ut(o.path.toArray()):n.done()}).next(()=>{for(;o;)s(o,null),o=i.hasNext()?i.getNext():null})}getAll(t,r,e){let s=Dn();const i=r.length+1,n={};if(e.isEqual(at.min())){const t=r.toArray();n.range=IDBKeyRange.lowerBound(t)}else{const t=r.toArray(),s=Ti(e);n.range=IDBKeyRange.lowerBound([t,s],!0),n.index=Bs.collectionReadTimeIndex}return br(t).Qt(n,(t,e,n)=>{t.length===i&&(e=this.gn(Nt.fromSegments(t),e),r.isPrefixOf(e.key.path)?s=s.insert(e.key,e):n.done())}).next(()=>s)}newChangeBuffer(t){return new Rr(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next(t=>t.byteSize)}getMetadata(t){return Pr(t).get(Ls.key).next(t=>(U(!!t),t))}mn(t,e){return Pr(t).put(Ls.key,e)}gn(t,e){if(e){const t=Ii(this.O,e);if(!t.isNoDocument()||!t.version.isEqual(at.min()))return t}return Jt.newInvalidDocument(t)}}class Rr extends Tr{constructor(t,e){super(),this.Tn=t,this.trackRemovals=e,this.An=new Er(t=>t.toString(),(t,e)=>t.isEqual(e))}applyChanges(i){const o=[];let a=0,c=new bn((t,e)=>rt(t.canonicalString(),e.canonicalString()));return this.changes.forEach((t,e)=>{var n=this.An.get(t);if(e.isValidDocument()){var r=Ei(this.Tn.O,e);c=c.add(t.path.popLast());var s=sr(r);a+=s-n,o.push(this.Tn.addEntry(i,t,r))}else if(a-=n,this.trackRemovals){const a=Ei(this.Tn.O,e.convertToNoDocument(at.min()));o.push(this.Tn.addEntry(i,t,a))}else o.push(this.Tn.removeEntry(i,t))}),c.forEach(t=>{o.push(this.Tn.indexManager.addToCollectionParentIndex(i,t))}),o.push(this.Tn.updateMetadata(i,a)),si.waitFor(o)}getFromCache(t,e){return this.Tn.yn(t,e).next(t=>(this.An.set(e,t.size),t.document))}getAllFromCache(t,e){return this.Tn.In(t,e).next(({documents:t,En:e})=>(e.forEach((t,e)=>{this.An.set(t,e)}),t))}}function Pr(t){return _i(t,Ls.store)}function br(t){return _i(t,Bs.store)}function vr(t){return t.path.toArray()}class Vr{constructor(t){this.O=t}kt(e,n,t,r){const s=new ii("createOrUpgrade",n);var i;t<1&&1<=r&&(e.createObjectStore(xs.store),(i=e).createObjectStore(ks.store,{keyPath:ks.keyPath}),i.createObjectStore(Os.store,{keyPath:Os.keyPath,autoIncrement:!0}).createIndex(Os.userMutationsIndex,Os.userMutationsKeyPath,{unique:!0}),i.createObjectStore(Ms.store),Sr(e),e.createObjectStore(Bs.store));let o=si.resolve();return t<3&&3<=r&&(0!==t&&((i=e).deleteObjectStore(qs.store),i.deleteObjectStore(Us.store),i.deleteObjectStore(Ks.store),Sr(e)),o=o.next(()=>function(){const t=s.store(Ks.store),e=new Ks(0,0,at.min().toTimestamp(),0);return t.put(Ks.key,e)}())),t<4&&4<=r&&(0!==t&&(o=o.next(()=>function(r,s){return s.store(Os.store).qt().next(t=>{r.deleteObjectStore(Os.store),r.createObjectStore(Os.store,{keyPath:Os.keyPath,autoIncrement:!0}).createIndex(Os.userMutationsIndex,Os.userMutationsKeyPath,{unique:!0});const e=s.store(Os.store),n=t.map(t=>e.put(t));return si.waitFor(n)})}(e,s))),o=o.next(()=>{e.createObjectStore(js.store,{keyPath:js.keyPath})})),t<5&&5<=r&&(o=o.next(()=>this.Rn(s))),t<6&&6<=r&&(o=o.next(()=>(e.createObjectStore(Ls.store),this.Pn(s)))),t<7&&7<=r&&(o=o.next(()=>this.bn(s))),t<8&&8<=r&&(o=o.next(()=>this.vn(e,s))),t<9&&9<=r&&(o=o.next(()=>{var t;(t=e).objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges"),function(){const t=n.objectStore(Bs.store);t.createIndex(Bs.readTimeIndex,Bs.readTimeIndexPath,{unique:!1}),t.createIndex(Bs.collectionReadTimeIndex,Bs.collectionReadTimeIndexPath,{unique:!1})}()})),t<10&&10<=r&&(o=o.next(()=>this.Vn(s))),t<11&&11<=r&&(o=o.next(()=>{e.createObjectStore(Qs.store,{keyPath:Qs.keyPath}),e.createObjectStore(Ws.store,{keyPath:Ws.keyPath})})),t<12&&12<=r&&(o=o.next(()=>{!function(){const t=e.createObjectStore(Ys.store,{keyPath:Ys.keyPath});t.createIndex(Ys.collectionPathOverlayIndex,Ys.collectionPathOverlayIndexPath,{unique:!1}),t.createIndex(Ys.collectionGroupOverlayIndex,Ys.collectionGroupOverlayIndexPath,{unique:!1})}()})),t<13&&13<=r&&(o=o.next(()=>{var t;(t=e).createObjectStore(zs.store,{keyPath:zs.keyPath,autoIncrement:!0}).createIndex(zs.collectionGroupIndex,zs.collectionGroupIndexPath,{unique:!1}),t.createObjectStore(Hs.store,{keyPath:Hs.keyPath}).createIndex(Hs.sequenceNumberIndex,Hs.sequenceNumberIndexPath,{unique:!1}),t.createObjectStore(Js.store,{keyPath:Js.keyPath}).createIndex(Js.documentKeyIndex,Js.documentKeyIndexPath,{unique:!1})})),o}Pn(e){let n=0;return e.store(Bs.store).Qt((t,e)=>{n+=sr(e)}).next(()=>{var t=new Ls(n);return e.store(Ls.store).put(Ls.key,t)})}Rn(n){const t=n.store(ks.store),r=n.store(Os.store);return t.qt().next(t=>si.forEach(t,e=>{var t=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return r.qt(Os.userMutationsIndex,t).next(t=>si.forEach(t,t=>{U(t.userId===e.userId);t=bi(this.O,t);return nr(n,e.userId,t).next(()=>{})}))}))}bn(t){const o=t.store(qs.store),e=t.store(Bs.store);return t.store(Ks.store).get(Ks.key).next(s=>{const i=[];return e.Qt((t,e)=>{const n=new _t(t),r=[0,Vs(n)];i.push(o.get(r).next(t=>t?si.resolve():(t=>o.put(new qs(0,Vs(t),s.highestListenSequenceNumber)))(n)))}).next(()=>si.waitFor(i))})}vn(t,e){t.createObjectStore(Gs.store,{keyPath:Gs.keyPath});const n=e.store(Gs.store),r=new zi,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:Vs(r)})}};return e.store(Bs.store).Qt({jt:!0},(t,e)=>{const n=new _t(t);return s(n.popLast())}).next(()=>e.store(Ms.store).Qt({jt:!0},([,t],e)=>{const n=Cs(t);return s(n.popLast())}))}Vn(t){const n=t.store(Us.store);return n.Qt((t,e)=>{e=vi(e),e=Vi(this.O,e);return n.put(e)})}}function Sr(t){t.createObjectStore(qs.store,{keyPath:qs.keyPath}).createIndex(qs.documentTargetsIndex,qs.documentTargetsKeyPath,{unique:!0}),t.createObjectStore(Us.store,{keyPath:Us.keyPath}).createIndex(Us.queryTargetsIndexName,Us.queryTargetsKeyPath,{unique:!0}),t.createObjectStore(Ks.store)}const Dr="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Cr{constructor(t,e,n,r,s,i,o,a,c,u,h=12){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.Sn=s,this.window=i,this.document=o,this.Dn=c,this.Cn=u,this.schemaVersion=h,this.Nn=null,this.xn=!1,this.isPrimary=!1,this.networkEnabled=!0,this.kn=null,this.inForeground=!1,this.On=null,this.Mn=null,this.$n=Number.NEGATIVE_INFINITY,this.Fn=t=>Promise.resolve(),!Cr.Vt())throw new j(G.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new pr(this,r),this.Bn=e+"main",this.O=new pi(a),this.Ln=new ri(this.Bn,this.schemaVersion,new Vr(this.O)),this.Un=new hr(this.referenceDelegate,this.O),this.qn=(a=this.O,new Ar(a)),this.Kn=new Ni,this.window&&this.window.localStorage?this.Gn=this.window.localStorage:(this.Gn=null,!1===u&&$("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.jn().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new j(G.FAILED_PRECONDITION,Dr);return this.Qn(),this.Wn(),this.zn(),this.runTransaction("getHighestListenSequenceNumber","readonly",t=>this.Un.getHighestSequenceNumber(t))}).then(t=>{this.Nn=new nt(t,this.Dn)}).then(()=>{this.xn=!0}).catch(t=>(this.Ln&&this.Ln.close(),Promise.reject(t)))}Hn(e){return this.Fn=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ln.Mt(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.Sn.enqueueAndForget(async()=>{this.started&&await this.jn()}))}jn(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>xr(e).put(new js(this.clientId,Date.now(),this.networkEnabled,this.inForeground)).next(()=>{if(this.isPrimary)return this.Jn(e).next(t=>{t||(this.isPrimary=!1,this.Sn.enqueueRetryable(()=>this.Fn(!1)))})}).next(()=>this.Yn(e)).next(t=>this.isPrimary&&!t?this.Xn(e).next(()=>!1):!!t&&this.Zn(e).next(()=>!0))).catch(t=>{if(ui(t))return M("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return M("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1}).then(t=>{this.isPrimary!==t&&this.Sn.enqueueRetryable(()=>this.Fn(t)),this.isPrimary=t})}Jn(t){return Nr(t).get(xs.key).next(t=>si.resolve(this.ts(t)))}es(t){return xr(t).delete(this.clientId)}async ns(){if(this.isPrimary&&!this.ss(this.$n,18e5)){this.$n=Date.now();var t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",t=>{const r=_i(t,js.store);return r.qt().next(t=>{const e=this.rs(t,18e5),n=t.filter(t=>-1===e.indexOf(t));return si.forEach(n,t=>r.delete(t.clientId)).next(()=>n)})}).catch(()=>[]);if(this.Gn)for(const e of t)this.Gn.removeItem(this.os(e.clientId))}}zn(){this.Mn=this.Sn.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.jn().then(()=>this.ns()).then(()=>this.zn()))}ts(t){return!!t&&t.ownerId===this.clientId}Yn(e){return this.Cn?si.resolve(!0):Nr(e).get(xs.key).next(t=>{if(null!==t&&this.ss(t.leaseTimestampMs,5e3)&&!this.cs(t.ownerId)){if(this.ts(t)&&this.networkEnabled)return!0;if(!this.ts(t)){if(!t.allowTabSynchronization)throw new j(G.FAILED_PRECONDITION,Dr);return!1}}return!(!this.networkEnabled||!this.inForeground)||xr(e).qt().next(t=>void 0===this.rs(t,5e3).find(t=>{if(this.clientId!==t.clientId){var e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,t=this.networkEnabled===t.networkEnabled;if(e||n&&t)return!0}return!1}))}).next(t=>(this.isPrimary!==t&&M("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t))}async shutdown(){this.xn=!1,this.us(),this.Mn&&(this.Mn.cancel(),this.Mn=null),this.hs(),this.ls(),await this.Ln.runTransaction("shutdown","readwrite",[xs.store,js.store],t=>{const e=new di(t,nt.A);return this.Xn(e).next(()=>this.es(e))}),this.Ln.close(),this.fs()}rs(t,e){return t.filter(t=>this.ss(t.updateTimeMs,e)&&!this.cs(t.clientId))}ds(){return this.runTransaction("getActiveClients","readonly",t=>xr(t).qt().next(t=>this.rs(t,18e5).map(t=>t.clientId)))}get started(){return this.xn}getMutationQueue(t,e){return ir.Jt(t,this.O,e,this.referenceDelegate)}getTargetCache(){return this.Un}getRemoteDocumentCache(){return this.qn}getIndexManager(t){return new Hi(t)}getDocumentOverlayCache(t){return Oi.Jt(this.O,t)}getBundleCache(){return this.Kn}runTransaction(e,n,r){M("IndexedDbPersistence","Starting transaction:",e);var t,s="readonly"===n?"readonly":"readwrite",t=13===(t=this.schemaVersion)?ti:12===t?Zs:11===t?Xs:void L();let i;return this.Ln.runTransaction(e,s,t,t=>(i=new di(t,this.Nn?this.Nn.next():nt.A),"readwrite-primary"===n?this.Jn(i).next(t=>!!t||this.Yn(i)).next(t=>{if(!t)throw $(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Sn.enqueueRetryable(()=>this.Fn(!1)),new j(G.FAILED_PRECONDITION,ei);return r(i)}).next(t=>this.Zn(i).next(()=>t)):this._s(i).next(()=>r(i)))).then(t=>(i.raiseOnCommittedEvent(),t))}_s(t){return Nr(t).get(xs.key).next(t=>{if(null!==t&&this.ss(t.leaseTimestampMs,5e3)&&!this.cs(t.ownerId)&&!this.ts(t)&&!(this.Cn||this.allowTabSynchronization&&t.allowTabSynchronization))throw new j(G.FAILED_PRECONDITION,Dr)})}Zn(t){var e=new xs(this.clientId,this.allowTabSynchronization,Date.now());return Nr(t).put(xs.key,e)}static Vt(){return ri.Vt()}Xn(t){const e=Nr(t);return e.get(xs.key).next(t=>this.ts(t)?(M("IndexedDbPersistence","Releasing primary lease."),e.delete(xs.key)):si.resolve())}ss(t,e){var n=Date.now();return!(t<n-e||n<t&&($(`Detected an update time that is in the future: ${t} > ${n}`),1))}Qn(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.On=()=>{this.Sn.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.jn()))},this.document.addEventListener("visibilitychange",this.On),this.inForeground="visible"===this.document.visibilityState)}hs(){this.On&&(this.document.removeEventListener("visibilitychange",this.On),this.On=null)}Wn(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.kn=()=>{this.us(),isSafari()&&navigator.appVersion.match(/Version\/1[45]/)&&this.Sn.enterRestrictedMode(!0),this.Sn.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.kn))}ls(){this.kn&&(this.window.removeEventListener("pagehide",this.kn),this.kn=null)}cs(t){var e;try{var n=null!==(null===(e=this.Gn)||void 0===e?void 0:e.getItem(this.os(t)));return M("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return $("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}us(){if(this.Gn)try{this.Gn.setItem(this.os(this.clientId),String(Date.now()))}catch(t){$("Failed to set zombie client id.",t)}}fs(){if(this.Gn)try{this.Gn.removeItem(this.os(this.clientId))}catch(t){}}os(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function Nr(t){return _i(t,xs.store)}function xr(t){return _i(t,js.store)}function kr(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class Or{constructor(t,e){this.progress=t,this.ws=e}}class Mr{constructor(t,e,n){this.qn=t,this.gs=e,this.indexManager=n}ys(e,n){return this.gs.getAllMutationBatchesAffectingDocumentKey(e,n).next(t=>this.ps(e,n,t))}ps(t,e,n){return this.qn.getEntry(t,e).next(t=>{for(const e of n)e.applyToLocalView(t);return t})}Is(t,n){t.forEach((t,e)=>{for(const t of n)t.applyToLocalView(e)})}Es(e,t){return this.qn.getEntries(e,t).next(t=>this.Ts(e,t).next(()=>t))}Ts(t,e){return this.gs.getAllMutationBatchesAffectingDocumentKeys(t,e).next(t=>this.Is(e,t))}As(t,e,n){return r=e,Nt.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.Rs(t,e.path):Ve(e)?this.Ps(t,e,n):this.bs(t,e,n);var r}Rs(t,e){return this.ys(t,new Nt(e)).next(t=>{let e=Nn();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e})}Ps(n,r,s){const i=r.collectionGroup;let o=Nn();return this.indexManager.getCollectionParents(n,i).next(t=>si.forEach(t,t=>{var e,e=(e=r,t=t.child(i),new Ee(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt));return this.bs(n,e,s).next(t=>{t.forEach((t,e)=>{o=o.insert(t,e)})})}).next(()=>o))}bs(e,n,t){let s;return this.qn.getAll(e,n.path,t).next(t=>(s=t,this.gs.getAllMutationBatchesAffectingQuery(e,n))).next(e=>{for(const r of e)for(const e of r.mutations){var n=e.key;let t=s.get(n);null==t&&(t=Jt.newInvalidDocument(n),s=s.insert(n,t)),cn(e,t,r.localWriteTime),t.isFoundDocument()||(s=s.remove(n))}}).next(()=>(s.forEach((t,e)=>{Oe(n,e)||(s=s.remove(t))}),s))}}class $r{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.vs=n,this.Vs=r}static Ss(t,e){let n=On(),r=On();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:r=r.add(t.doc.key)}return new $r(t,e.fromCache,n,r)}}class Fr{Ds(t){this.Cs=t}As(e,r,s,i){return 0===(t=r).filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())||s.isEqual(at.min())?this.Ns(e,r):this.Cs.Es(e,i).next(t=>{const n=this.xs(r,t);return(Re(r)||Pe(r))&&this.ks(r.limitType,n,i,s)?this.Ns(e,r):(k()<=LogLevel.DEBUG&&M("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),ke(r)),this.Cs.As(e,r,s).next(e=>(n.forEach(t=>{e=e.insert(t.key,t)}),e)))});var t}xs(n,t){let r=new bn(Me(n));return t.forEach((t,e)=>{Oe(n,e)&&(r=r.add(e))}),r}ks(t,e,n,r){if(n.size!==e.size)return!0;const s="F"===t?e.last():e.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Ns(t,e){return k()<=LogLevel.DEBUG&&M("QueryEngine","Using full collection scan to execute query:",ke(e)),this.Cs.As(t,e,at.min())}}class Br{constructor(t,e,n,r){this.persistence=t,this.Os=e,this.O=r,this.Ms=new An(rt),this.$s=new Er(t=>se(t),re),this.Fs=at.min(),this.Bs=t.getRemoteDocumentCache(),this.Un=t.getTargetCache(),this.Kn=t.getBundleCache(),this.Ls(n)}Ls(t){this.indexManager=this.persistence.getIndexManager(t),this.gs=this.persistence.getMutationQueue(t,this.indexManager),this.Us=new Mr(this.Bs,this.gs,this.indexManager),this.Bs.setIndexManager(this.indexManager),this.Os.Ds(this.Us)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Ms))}}function Lr(t,e,n,r){return new Br(t,e,n,r)}async function Ur(t,e){const o=K(t);return o.persistence.runTransaction("Handle user change","readonly",s=>{let i;return o.gs.getAllMutationBatches(s).next(t=>(i=t,o.Ls(e),o.gs.getAllMutationBatches(s))).next(t=>{const e=[],n=[];let r=On();for(const s of i){e.push(s.batchId);for(const t of s.mutations)r=r.add(t.key)}for(const s of t){n.push(s.batchId);for(const t of s.mutations)r=r.add(t.key)}return o.Us.Es(s,r).next(t=>({qs:t,removedBatchIds:e,addedBatchIds:n}))})})}function qr(t,r){const s=K(t);return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",t=>{const e=r.batch.keys(),n=s.Bs.newChangeBuffer({trackRemovals:!0});return function(t,e,r,s){const i=r.batch,n=i.keys();let o=si.resolve();return n.forEach(n=>{o=o.next(()=>s.getEntry(e,n)).next(t=>{var e=r.docVersions.get(n);U(null!==e),t.version.compareTo(e)<0&&(i.applyToRemoteDocument(t,r),t.isValidDocument()&&(t.setReadTime(r.commitVersion),s.addEntry(t)))})}),o.next(()=>t.gs.removeMutationBatch(e,i))}(s,t,r,n).next(()=>n.apply(t)).next(()=>s.gs.performConsistencyCheck(t)).next(()=>s.Us.Es(t,e))})}function Kr(t){const e=K(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Un.getLastRemoteSnapshotVersion(t))}function Gr(t,u){const h=K(t),l=u.snapshotVersion;let d=h.Ms;return h.persistence.runTransaction("Apply remote event","readwrite-primary",a=>{const t=h.Bs.newChangeBuffer({trackRemovals:!0});d=h.Ms;const c=[];u.targetChanges.forEach((e,n)=>{const r=d.get(n);if(r){c.push(h.Un.removeMatchingKeys(a,e.removedDocuments,n).next(()=>h.Un.addMatchingKeys(a,e.addedDocuments,n)));let t=r.withSequenceNumber(a.currentSequenceNumber);var s,i,o;u.targetMismatches.has(n)?t=t.withResumeToken(pt.EMPTY_BYTE_STRING,at.min()).withLastLimboFreeSnapshotVersion(at.min()):0<e.resumeToken.approximateByteSize()&&(t=t.withResumeToken(e.resumeToken,l)),d=d.insert(n,t),s=r,i=t,o=e,0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<o.addedDocuments.size+o.modifiedDocuments.size+o.removedDocuments.size)||c.push(h.Un.updateTargetData(a,t))}});let e=Dn();if(u.documentUpdates.forEach(t=>{u.resolvedLimboDocuments.has(t)&&c.push(h.persistence.referenceDelegate.updateLimboDocument(a,t))}),c.push(jr(a,t,u.documentUpdates).next(t=>{e=t})),!l.isEqual(at.min())){const u=h.Un.getLastRemoteSnapshotVersion(a).next(t=>h.Un.setTargetsMetadata(a,a.currentSequenceNumber,l));c.push(u)}return si.waitFor(c).next(()=>t.apply(a)).next(()=>h.Us.Ts(a,e)).next(()=>e)}).then(t=>(h.Ms=d,t))}function jr(t,i,e){let n=On();return e.forEach(t=>n=n.add(t)),i.getEntries(t,n).next(r=>{let s=Dn();return e.forEach((t,e)=>{const n=r.get(t);e.isNoDocument()&&e.version.isEqual(at.min())?(i.removeEntry(t,e.readTime),s=s.insert(t,e)):!n.isValidDocument()||0<e.version.compareTo(n.version)||0===e.version.compareTo(n.version)&&n.hasPendingWrites?(i.addEntry(e),s=s.insert(t,e)):M("LocalStore","Ignoring outdated watch update for ",t,". Current version:",n.version," Watch version:",e.version)}),s})}function Qr(t,e){const n=K(t);return n.persistence.runTransaction("Get next mutation batch","readonly",t=>(void 0===e&&(e=-1),n.gs.getNextMutationBatchAfterBatchId(t,e)))}function Wr(t,r){const s=K(t);return s.persistence.runTransaction("Allocate target","readwrite",e=>{let n;return s.Un.getTargetData(e,r).next(t=>t?(n=t,si.resolve(n)):s.Un.allocateTargetId(e).next(t=>(n=new yi(r,t,0,e.currentSequenceNumber),s.Un.addTargetData(e,n).next(()=>n))))}).then(t=>{var e=s.Ms.get(t.targetId);return(null===e||0<t.snapshotVersion.compareTo(e.snapshotVersion))&&(s.Ms=s.Ms.insert(t.targetId,t),s.$s.set(r,t.targetId)),t})}async function zr(t,e,n){const r=K(t),s=r.Ms.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,t=>r.persistence.referenceDelegate.removeTarget(t,s))}catch(t){if(!ui(t))throw t;M("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.Ms=r.Ms.remove(e),r.$s.delete(s.target)}function Hr(t,n,r){const s=K(t);let i=at.min(),o=On();return s.persistence.runTransaction("Execute query","readonly",e=>function(t,e,n){const r=K(t),s=r.$s.get(n);return void 0!==s?si.resolve(r.Ms.get(s)):r.Un.getTargetData(e,n)}(s,e,De(n)).next(t=>{if(t)return i=t.lastLimboFreeSnapshotVersion,s.Un.getMatchingKeysForTargetId(e,t.targetId).next(t=>{o=t})}).next(()=>s.Os.As(e,n,r?i:at.min(),r?o:On())).next(t=>({documents:t,Ks:o})))}function Jr(t,e){const n=K(t),r=K(n.Un),s=n.Ms.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",t=>r.Tt(t,e).next(t=>t?t.target:null))}function Yr(t){const n=K(t);return n.persistence.runTransaction("Get new document changes","readonly",t=>function(t,e,n){const r=K(t);let s=Dn(),i=Ti(n);const o=br(e),a=IDBKeyRange.lowerBound(i,!0);return o.Qt({index:Bs.readTimeIndex,range:a},(t,e)=>{var n=Ii(r.O,e);s=s.insert(n.key,n),i=e.readTime}).next(()=>({ws:s,readTime:Ai(i)}))}(n.Bs,t,n.Fs)).then(({ws:t,readTime:e})=>(n.Fs=e,t))}async function Xr(t){const e=K(t);return e.persistence.runTransaction("Synchronize last document change read time","readonly",e=>function(){const t=br(e);let r=at.min();return t.Qt({index:Bs.readTimeIndex,reverse:!0},(t,e,n)=>{e.readTime&&(r=Ai(e.readTime)),n.done()}).next(()=>r)}()).then(t=>{e.Fs=t})}async function Zr(t,e,n,r){const s=K(t);let i=On(),o=Dn();for(const t of n){const n=e.Gs(t.metadata.name);t.document&&(i=i.add(n));const u=e.js(t);u.setReadTime(e.Qs(t.metadata.readTime)),o=o.insert(n,u)}const a=s.Bs.newChangeBuffer({trackRemovals:!0}),c=await Wr(s,(r=r,De(Ae(_t.fromString(`__bundle__/docs/${r}`)))));return s.persistence.runTransaction("Apply bundle documents","readwrite",e=>jr(e,a,o).next(t=>(a.apply(e),t)).next(t=>s.Un.removeMatchingKeysForTargetId(e,c.targetId).next(()=>s.Un.addMatchingKeys(e,i,c.targetId)).next(()=>s.Us.Ts(e,t)).next(()=>t)))}async function to(t,n,r=On()){const s=await Wr(t,De(Si(n.bundledQuery))),i=K(t);return i.persistence.runTransaction("Save named query","readwrite",t=>{var e=Zn(n.readTime);if(0<=s.snapshotVersion.compareTo(e))return i.Kn.saveNamedQuery(t,n);e=s.withResumeToken(pt.EMPTY_BYTE_STRING,e);return i.Ms=i.Ms.insert(e.targetId,e),i.Un.updateTargetData(t,e).next(()=>i.Un.removeMatchingKeysForTargetId(t,s.targetId)).next(()=>i.Un.addMatchingKeys(t,r,s.targetId)).next(()=>i.Kn.saveNamedQuery(t,n))})}class eo{constructor(t){this.O=t,this.Ws=new Map,this.zs=new Map}getBundleMetadata(t,e){return si.resolve(this.Ws.get(e))}saveBundleMetadata(t,e){return this.Ws.set(e.id,{id:e.id,version:e.version,createTime:Zn(e.createTime)}),si.resolve()}getNamedQuery(t,e){return si.resolve(this.zs.get(e))}saveNamedQuery(t,e){return this.zs.set(e.name,{name:(e=e).name,query:Si(e.bundledQuery),readTime:Zn(e.readTime)}),si.resolve()}}class no{constructor(){this.overlays=new An(Nt.comparator),this.Hs=new Map}getOverlay(t,e){return si.resolve(this.overlays.get(e))}saveOverlays(e,n,t){return t.forEach(t=>{this.Yt(e,n,t)}),si.resolve()}removeOverlaysForBatchId(t,e,n){const r=this.Hs.get(n);return void 0!==r&&(r.forEach(t=>this.overlays=this.overlays.remove(t)),this.Hs.delete(n)),si.resolve()}getOverlaysForCollection(t,e,n){const r=new Map,s=e.length+1,i=new Nt(e.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const t=o.getNext().value,i=t.getKey();if(!e.isPrefixOf(i.path))break;i.path.length===s&&t.largestBatchId>n&&r.set(t.getKey(),t)}return si.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new An((t,e)=>t-e);const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=new Map,s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=new Map,a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach((t,e)=>o.set(e,t)),!(o.size>=r)););return si.resolve(o)}Yt(t,e,n){if(null!==n){var r=this.overlays.get(n.key);null!==r&&this.Hs.get(r.largestBatchId).delete(n.key),this.overlays=this.overlays.insert(n.key,new gi(e,n));let t=this.Hs.get(e);void 0===t&&(t=new Set,this.Hs.set(e,t)),t.add(n.key)}}}class so{constructor(){this.Js=new bn(io.Ys),this.Xs=new bn(io.Zs)}isEmpty(){return this.Js.isEmpty()}addReference(t,e){e=new io(t,e);this.Js=this.Js.add(e),this.Xs=this.Xs.add(e)}ti(t,e){t.forEach(t=>this.addReference(t,e))}removeReference(t,e){this.ei(new io(t,e))}ni(t,e){t.forEach(t=>this.removeReference(t,e))}si(t){const e=new Nt(new _t([])),n=new io(e,t),r=new io(e,t+1),s=[];return this.Xs.forEachInRange([n,r],t=>{this.ei(t),s.push(t.key)}),s}ii(){this.Js.forEach(t=>this.ei(t))}ei(t){this.Js=this.Js.delete(t),this.Xs=this.Xs.delete(t)}ri(t){var e=new Nt(new _t([])),n=new io(e,t),t=new io(e,t+1);let r=On();return this.Xs.forEachInRange([n,t],t=>{r=r.add(t.key)}),r}containsKey(t){var e=new io(t,0),e=this.Js.firstAfterOrEqual(e);return null!==e&&t.isEqual(e.key)}}class io{constructor(t,e){this.key=t,this.oi=e}static Ys(t,e){return Nt.comparator(t.key,e.key)||rt(t.oi,e.oi)}static Zs(t,e){return rt(t.oi,e.oi)||Nt.comparator(t.key,e.key)}}class ro{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.gs=[],this.ci=1,this.ui=new bn(io.Ys)}checkEmpty(t){return si.resolve(0===this.gs.length)}addMutationBatch(t,e,n,r){var s=this.ci;this.ci++,0<this.gs.length&&this.gs[this.gs.length-1];n=new wi(s,e,n,r);this.gs.push(n);for(const e of r)this.ui=this.ui.add(new io(e.key,s)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return si.resolve(n)}lookupMutationBatch(t,e){return si.resolve(this.ai(e))}getNextMutationBatchAfterBatchId(t,e){e=this.hi(e+1),e=e<0?0:e;return si.resolve(this.gs.length>e?this.gs[e]:null)}getHighestUnacknowledgedBatchId(){return si.resolve(0===this.gs.length?-1:this.ci-1)}getAllMutationBatches(t){return si.resolve(this.gs.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new io(e,0),r=new io(e,Number.POSITIVE_INFINITY),s=[];return this.ui.forEachInRange([n,r],t=>{t=this.ai(t.oi);s.push(t)}),si.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new bn(rt);return e.forEach(t=>{var e=new io(t,0),t=new io(t,Number.POSITIVE_INFINITY);this.ui.forEachInRange([e,t],t=>{n=n.add(t.oi)})}),si.resolve(this.li(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;Nt.isDocumentKey(s)||(s=s.child(""));e=new io(new Nt(s),0);let i=new bn(rt);return this.ui.forEachWhile(t=>{var e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(i=i.add(t.oi)),!0)},e),si.resolve(this.li(i))}li(t){const e=[];return t.forEach(t=>{t=this.ai(t);null!==t&&e.push(t)}),e}removeMutationBatch(n,r){U(0===this.fi(r.batchId,"removed")),this.gs.shift();let s=this.ui;return si.forEach(r.mutations,t=>{var e=new io(t.key,r.batchId);return s=s.delete(e),this.referenceDelegate.markPotentiallyOrphaned(n,t.key)}).next(()=>{this.ui=s})}Qe(t){}containsKey(t,e){var n=new io(e,0),n=this.ui.firstAfterOrEqual(n);return si.resolve(e.isEqual(n&&n.key))}performConsistencyCheck(t){return this.gs.length,si.resolve()}fi(t,e){return this.hi(t)}hi(t){return 0===this.gs.length?0:t-this.gs[0].batchId}ai(t){t=this.hi(t);return t<0||t>=this.gs.length?null:this.gs[t]}}class oo{constructor(t){this.di=t,this.docs=new An(Nt.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,r=this.docs.get(n),s=r?r.size:0,i=this.di(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){var e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return si.resolve(n?n.document.mutableCopy():Jt.newInvalidDocument(e))}getEntries(t,e){let n=Dn();return e.forEach(t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():Jt.newInvalidDocument(t))}),si.resolve(n)}getAll(t,e,n){let r=Dn();const s=new Nt(e.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:t,value:{document:s}}=i.getNext();if(!e.isPrefixOf(t.path))break;t.path.length>e.length+1||s.readTime.compareTo(n)<=0||(r=r.insert(s.key,s.mutableCopy()))}return si.resolve(r)}_i(t,e){return si.forEach(this.docs,t=>e(t))}newChangeBuffer(t){return new co(this)}getSize(t){return si.resolve(this.size)}}class co extends Tr{constructor(t){super(),this.Tn=t}applyChanges(n){const r=[];return this.changes.forEach((t,e)=>{e.isValidDocument()?r.push(this.Tn.addEntry(n,e)):this.Tn.removeEntry(t)}),si.waitFor(r)}getFromCache(t,e){return this.Tn.getEntry(t,e)}getAllFromCache(t,e){return this.Tn.getEntries(t,e)}}class uo{constructor(t){this.persistence=t,this.wi=new Er(t=>se(t),re),this.lastRemoteSnapshotVersion=at.min(),this.highestTargetId=0,this.mi=0,this.gi=new so,this.targetCount=0,this.yi=ar.He()}forEachTarget(t,n){return this.wi.forEach((t,e)=>n(e)),si.resolve()}getLastRemoteSnapshotVersion(t){return si.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return si.resolve(this.mi)}allocateTargetId(t){return this.highestTargetId=this.yi.next(),si.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.mi&&(this.mi=e),si.resolve()}Ze(t){this.wi.set(t.target,t);var e=t.targetId;e>this.highestTargetId&&(this.yi=new ar(e),this.highestTargetId=e),t.sequenceNumber>this.mi&&(this.mi=t.sequenceNumber)}addTargetData(t,e){return this.Ze(e),this.targetCount+=1,si.resolve()}updateTargetData(t,e){return this.Ze(e),si.resolve()}removeTargetData(t,e){return this.wi.delete(e.target),this.gi.si(e.targetId),--this.targetCount,si.resolve()}removeTargets(n,r,s){let i=0;const o=[];return this.wi.forEach((t,e)=>{e.sequenceNumber<=r&&null===s.get(e.targetId)&&(this.wi.delete(t),o.push(this.removeMatchingKeysForTargetId(n,e.targetId)),i++)}),si.waitFor(o).next(()=>i)}getTargetCount(t){return si.resolve(this.targetCount)}getTargetData(t,e){e=this.wi.get(e)||null;return si.resolve(e)}addMatchingKeys(t,e,n){return this.gi.ti(e,n),si.resolve()}removeMatchingKeys(e,t,n){this.gi.ni(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach(t=>{s.push(r.markPotentiallyOrphaned(e,t))}),si.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.gi.si(e),si.resolve()}getMatchingKeysForTargetId(t,e){e=this.gi.ri(e);return si.resolve(e)}containsKey(t,e){return si.resolve(this.gi.containsKey(e))}}class ao{constructor(t,e){this.pi={},this.overlays={},this.Nn=new nt(0),this.xn=!1,this.xn=!0,this.referenceDelegate=t(this),this.Un=new uo(this),this.indexManager=new Wi,this.qn=(t=t=>this.referenceDelegate.Ii(t),new oo(t)),this.O=new pi(e),this.Kn=new eo(this.O)}start(){return Promise.resolve()}shutdown(){return this.xn=!1,Promise.resolve()}get started(){return this.xn}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new no,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.pi[t.toKey()];return n||(n=new ro(e,this.referenceDelegate),this.pi[t.toKey()]=n),n}getTargetCache(){return this.Un}getRemoteDocumentCache(){return this.qn}getBundleCache(){return this.Kn}runTransaction(t,e,n){M("MemoryPersistence","Starting transaction:",t);const r=new ho(this.Nn.next());return this.referenceDelegate.Ei(),n(r).next(t=>this.referenceDelegate.Ti(r).next(()=>t)).toPromise().then(t=>(r.raiseOnCommittedEvent(),t))}Ai(e,n){return si.or(Object.values(this.pi).map(t=>()=>t.containsKey(e,n)))}}class ho extends ni{constructor(t){super(),this.currentSequenceNumber=t}}class lo{constructor(t){this.persistence=t,this.Ri=new so,this.Pi=null}static bi(t){return new lo(t)}get vi(){if(this.Pi)return this.Pi;throw L()}addReference(t,e,n){return this.Ri.addReference(n,e),this.vi.delete(n.toString()),si.resolve()}removeReference(t,e,n){return this.Ri.removeReference(n,e),this.vi.add(n.toString()),si.resolve()}markPotentiallyOrphaned(t,e){return this.vi.add(e.toString()),si.resolve()}removeTarget(t,e){this.Ri.si(e.targetId).forEach(t=>this.vi.add(t.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next(t=>{t.forEach(t=>this.vi.add(t.toString()))}).next(()=>n.removeTargetData(t,e))}Ei(){this.Pi=new Set}Ti(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return si.forEach(this.vi,t=>{const e=Nt.fromPath(t);return this.Vi(n,e).next(t=>{t||r.removeEntry(e,at.min())})}).next(()=>(this.Pi=null,r.apply(n)))}updateLimboDocument(t,e){return this.Vi(t,e).next(t=>{t?this.vi.delete(e.toString()):this.vi.add(e.toString())})}Ii(t){return 0}Vi(t,e){return si.or([()=>si.resolve(this.Ri.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Ai(t,e)])}}function fo(t,e){return`firestore_clients_${t}_${e}`}function _o(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function wo(t,e){return`firestore_targets_${t}_${e}`}class mo{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static Si(t,e,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new j(r.error.code,r.error.message))),i?new mo(t,e,r.state,s):($("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}Di(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class go{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Si(t,e){var n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new j(n.error.code,n.error.message))),s?new go(t,n.state,r):($("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}Di(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class yo{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Si(t,e){var n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=$n();for(let t=0;r&&t<n.activeTargetIds.length;++t)r=Ct(n.activeTargetIds[t]),s=s.add(n.activeTargetIds[t]);return r?new yo(t,s):($("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class po{constructor(t,e){this.clientId=t,this.onlineState=e}static Si(t){var e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new po(e.clientId,e.onlineState):($("SharedClientState",`Failed to parse online state: ${t}`),null)}}class Io{constructor(){this.activeTargetIds=$n()}Ci(t){this.activeTargetIds=this.activeTargetIds.add(t)}Ni(t){this.activeTargetIds=this.activeTargetIds.delete(t)}Di(){var t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Eo{constructor(t,e,n,r,s){this.window=t,this.Sn=e,this.persistenceKey=n,this.xi=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ki=this.Oi.bind(this),this.Mi=new An(rt),this.started=!1,this.$i=[];n=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.Fi=fo(this.persistenceKey,this.xi),this.Bi=`firestore_sequence_number_${this.persistenceKey}`,this.Mi=this.Mi.insert(this.xi,new Io),this.Li=new RegExp(`^firestore_clients_${n}_([^_]*)$`),this.Ui=new RegExp(`^firestore_mutations_${n}_(\\d+)(?:_(.*))?$`),this.qi=new RegExp(`^firestore_targets_${n}_(\\d+)$`),this.Ki=`firestore_online_state_${this.persistenceKey}`,this.Gi=`firestore_bundle_loaded_${this.persistenceKey}`,this.window.addEventListener("storage",this.ki)}static Vt(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.ds();for(const n of t)if(n!==this.xi){const t=this.getItem(fo(this.persistenceKey,n));var e;!t||(e=yo.Si(n,t))&&(this.Mi=this.Mi.insert(e.clientId,e))}this.ji();const n=this.storage.getItem(this.Ki);if(n){const t=this.Qi(n);t&&this.Wi(t)}for(const t of this.$i)this.Oi(t);this.$i=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(t){this.setItem(this.Bi,JSON.stringify(t))}getAllActiveQueryTargets(){return this.zi(this.Mi)}isActiveQueryTarget(n){let r=!1;return this.Mi.forEach((t,e)=>{e.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(t){this.Hi(t,"pending")}updateMutationState(t,e,n){this.Hi(t,e,n),this.Ji(t)}addLocalQueryTarget(t){let e="not-current";var n;return this.isActiveQueryTarget(t)&&(!(n=this.storage.getItem(wo(this.persistenceKey,t)))||(n=go.Si(t,n))&&(e=n.state)),this.Yi.Ci(t),this.ji(),e}removeLocalQueryTarget(t){this.Yi.Ni(t),this.ji()}isLocalQueryTarget(t){return this.Yi.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(wo(this.persistenceKey,t))}updateQueryState(t,e,n){this.Xi(t,e,n)}handleUserChange(t,e,n){e.forEach(t=>{this.Ji(t)}),this.currentUser=t,n.forEach(t=>{this.addPendingMutation(t)})}setOnlineState(t){this.Zi(t)}notifyBundleLoaded(){this.tr()}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ki),this.removeItem(this.Fi),this.started=!1)}getItem(t){var e=this.storage.getItem(t);return M("SharedClientState","READ",t,e),e}setItem(t,e){M("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){M("SharedClientState","REMOVE",t),this.storage.removeItem(t)}Oi(t){const r=t;r.storageArea===this.storage&&(M("SharedClientState","EVENT",r.key,r.newValue),r.key!==this.Fi?this.Sn.enqueueRetryable(async()=>{if(this.started){if(null!==r.key)if(this.Li.test(r.key)){if(null==r.newValue){var t=this.er(r.key);return this.nr(t,null)}t=this.sr(r.key,r.newValue);if(t)return this.nr(t.clientId,t)}else if(this.Ui.test(r.key)){if(null!==r.newValue){var e=this.ir(r.key,r.newValue);if(e)return this.rr(e)}}else if(this.qi.test(r.key)){if(null!==r.newValue){e=this.cr(r.key,r.newValue);if(e)return this.ur(e)}}else if(r.key===this.Ki){if(null!==r.newValue){var n=this.Qi(r.newValue);if(n)return this.Wi(n)}}else if(r.key===this.Bi){n=function(t){let e=nt.A;if(null!=t)try{var n=JSON.parse(t);U("number"==typeof n),e=n}catch(t){$("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(r.newValue);n!==nt.A&&this.sequenceNumberHandler(n)}else if(r.key===this.Gi)return this.syncEngine.ar()}else this.$i.push(r)}):$("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Yi(){return this.Mi.get(this.xi)}ji(){this.setItem(this.Fi,this.Yi.Di())}Hi(t,e,n){const r=new mo(this.currentUser,t,e,n),s=_o(this.persistenceKey,this.currentUser,t);this.setItem(s,r.Di())}Ji(t){t=_o(this.persistenceKey,this.currentUser,t);this.removeItem(t)}Zi(t){t={clientId:this.xi,onlineState:t};this.storage.setItem(this.Ki,JSON.stringify(t))}Xi(t,e,n){const r=wo(this.persistenceKey,t),s=new go(t,e,n);this.setItem(r,s.Di())}tr(){this.setItem(this.Gi,"value-not-used")}er(t){t=this.Li.exec(t);return t?t[1]:null}sr(t,e){t=this.er(t);return yo.Si(t,e)}ir(t,e){var n=this.Ui.exec(t),t=Number(n[1]),n=void 0!==n[2]?n[2]:null;return mo.Si(new C(n),t,e)}cr(t,e){t=this.qi.exec(t),t=Number(t[1]);return go.Si(t,e)}Qi(t){return po.Si(t)}async rr(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.hr(t.batchId,t.state,t.error);M("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}ur(t){return this.syncEngine.lr(t.targetId,t.state,t.error)}nr(t,e){const n=e?this.Mi.insert(t,e):this.Mi.remove(t),r=this.zi(this.Mi),s=this.zi(n),i=[],o=[];return s.forEach(t=>{r.has(t)||i.push(t)}),r.forEach(t=>{s.has(t)||o.push(t)}),this.syncEngine.dr(i,o).then(()=>{this.Mi=n})}Wi(t){this.Mi.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}zi(t){let n=$n();return t.forEach((t,e)=>{n=n.unionWith(e.activeTargetIds)}),n}}class To{constructor(){this._r=new Io,this.wr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this._r.Ci(t),this.wr[t]||"not-current"}updateQueryState(t,e,n){this.wr[t]=e}removeLocalQueryTarget(t){this._r.Ni(t)}isLocalQueryTarget(t){return this._r.activeTargetIds.has(t)}clearQueryState(t){delete this.wr[t]}getAllActiveQueryTargets(){return this._r.activeTargetIds}isActiveQueryTarget(t){return this._r.activeTargetIds.has(t)}start(){return this._r=new Io,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(){}}class Ao{mr(t){}shutdown(){}}class Ro{constructor(){this.gr=()=>this.yr(),this.pr=()=>this.Ir(),this.Er=[],this.Tr()}mr(t){this.Er.push(t)}shutdown(){window.removeEventListener("online",this.gr),window.removeEventListener("offline",this.pr)}Tr(){window.addEventListener("online",this.gr),window.addEventListener("offline",this.pr)}yr(){M("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.Er)t(0)}Ir(){M("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.Er)t(1)}static Vt(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Po={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class bo{constructor(t){this.Ar=t.Ar,this.Rr=t.Rr}Pr(t){this.br=t}vr(t){this.Vr=t}onMessage(t){this.Sr=t}close(){this.Rr()}send(t){this.Ar(t)}Dr(){this.br()}Cr(t){this.Vr(t)}Nr(t){this.Sr(t)}}class vo extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;var e=t.ssl?"https":"http";this.kr=e+"://"+t.host,this.Or="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}Mr(e,t,n,r,s){const i=this.$r(e,t);M("RestConnection","Sending: ",i,n);t={};return this.Fr(t,r,s),this.Br(e,i,t,n).then(t=>(M("RestConnection","Received: ",t),t),t=>{throw F("RestConnection",`${e} failed with error: `,t,"url: ",i,"request:",n),t})}Lr(t,e,n,r,s){return this.Mr(t,e,n,r,s)}Fr(n,t,e){n["X-Goog-Api-Client"]="gl-js/ fire/"+N,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,e)=>n[e]=t),e&&e.headers.forEach((t,e)=>n[e]=t)}$r(t,e){t=Po[t];return`${this.kr}/v1/${e}:${t}`}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams}Br(a,e,n,r){return new Promise((s,i)=>{const o=new XhrIo;o.listenOnce(EventType.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case ErrorCode.NO_ERROR:var t=o.getResponseJson();M("Connection","XHR received:",JSON.stringify(t)),s(t);break;case ErrorCode.TIMEOUT:M("Connection",'RPC "'+a+'" timed out'),i(new j(G.DEADLINE_EXCEEDED,"Request time out"));break;case ErrorCode.HTTP_ERROR:var e,n=o.getStatus();if(M("Connection",'RPC "'+a+'" failed with status:',n,"response text:",o.getResponseText()),0<n){const a=o.getResponseJson().error;a&&a.status&&a.message?(r=a.status.toLowerCase().replace(/_/g,"-"),e=0<=Object.values(G).indexOf(r)?r:G.UNKNOWN,i(new j(e,a.message))):i(new j(G.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new j(G.UNAVAILABLE,"Connection failed."));break;default:L()}}finally{M("Connection",'RPC "'+a+'" completed.')}var r});var t=JSON.stringify(r);o.send(e,"POST",t,n,15)})}Ur(t,e,n){const r=[this.kr,"/","google.firestore.v1.Firestore","/",t,"/channel"],s=createWebChannelTransport(),i=getStatEventTarget(),o={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(o.xmlHttpFactory=new FetchXmlHttpFactory({})),this.Fr(o.initMessageHeaders,e,n),isMobileCordova()||isReactNative()||isElectron()||isIE()||isUWP()||isBrowserExtension()||(o.httpHeadersOverwriteParam="$httpHeaders");n=r.join("");M("Connection","Creating WebChannel: "+n,o);const a=s.createWebChannel(n,o);let c=!1,u=!1;const h=new bo({Ar:t=>{u?M("Connection","Not sending because WebChannel is closed:",t):(c||(M("Connection","Opening WebChannel transport."),a.open(),c=!0),M("Connection","WebChannel sending:",t),a.send(t))},Rr:()=>a.close()}),l=(t,e,n)=>{t.listen(e,t=>{try{n(t)}catch(t){setTimeout(()=>{throw t},0)}})};return l(a,WebChannel.EventType.OPEN,()=>{u||M("Connection","WebChannel transport opened.")}),l(a,WebChannel.EventType.CLOSE,()=>{u||(u=!0,M("Connection","WebChannel transport closed"),h.Cr())}),l(a,WebChannel.EventType.ERROR,t=>{u||(u=!0,F("Connection","WebChannel transport errored:",t),h.Cr(new j(G.UNAVAILABLE,"The operation could not be completed")))}),l(a,WebChannel.EventType.MESSAGE,t=>{if(!u){t=t.data[0];U(!!t);var n=t.error||(null===(n=t[0])||void 0===n?void 0:n.error);if(n){M("Connection","WebChannel received error:",n);const r=n.status;let t=function(t){t=pn[t];if(void 0!==t)return Tn(t)}(r),e=n.message;void 0===t&&(t=G.INTERNAL,e="Unknown error status: "+r+" with message "+n.message),u=!0,h.Cr(new j(t,e)),a.close()}else M("Connection","WebChannel received:",t),h.Nr(t)}}),l(i,Event.STAT_EVENT,t=>{t.stat===Stat.PROXY?M("Connection","Detected buffering proxy"):t.stat===Stat.NOPROXY&&M("Connection","Detected no buffering proxy")}),setTimeout(()=>{h.Dr()},0),h}}function Vo(){return"undefined"!=typeof window?window:null}function So(){return"undefined"!=typeof document?document:null}function Do(t){return new Hn(t,!0)}class Co{constructor(t,e,n=1e3,r=1.5,s=6e4){this.Sn=t,this.timerId=e,this.qr=n,this.Kr=r,this.Gr=s,this.jr=0,this.Qr=null,this.Wr=Date.now(),this.reset()}reset(){this.jr=0}zr(){this.jr=this.Gr}Hr(t){this.cancel();var e=Math.floor(this.jr+this.Jr()),n=Math.max(0,Date.now()-this.Wr),r=Math.max(0,e-n);0<r&&M("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.jr} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Qr=this.Sn.enqueueAfterDelay(this.timerId,r,()=>(this.Wr=Date.now(),t())),this.jr*=this.Kr,this.jr<this.qr&&(this.jr=this.qr),this.jr>this.Gr&&(this.jr=this.Gr)}Yr(){null!==this.Qr&&(this.Qr.skipDelay(),this.Qr=null)}cancel(){null!==this.Qr&&(this.Qr.cancel(),this.Qr=null)}Jr(){return(Math.random()-.5)*this.jr}}class No{constructor(t,e,n,r,s,i,o,a){this.Sn=t,this.Xr=n,this.Zr=r,this.eo=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.no=0,this.so=null,this.io=null,this.stream=null,this.ro=new Co(t,e)}oo(){return 1===this.state||5===this.state||this.co()}co(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.uo()}async stop(){this.oo()&&await this.close(0)}ao(){this.state=0,this.ro.reset()}ho(){this.co()&&null===this.so&&(this.so=this.Sn.enqueueAfterDelay(this.Xr,6e4,()=>this.lo()))}fo(t){this._o(),this.stream.send(t)}async lo(){if(this.co())return this.close(0)}_o(){this.so&&(this.so.cancel(),this.so=null)}wo(){this.io&&(this.io.cancel(),this.io=null)}async close(t,e){this._o(),this.wo(),this.ro.cancel(),this.no++,4!==t?this.ro.reset():e&&e.code===G.RESOURCE_EXHAUSTED?($(e.toString()),$("Using maximum backoff delay to prevent overloading the backend."),this.ro.zr()):e&&e.code===G.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.mo(),this.stream.close(),this.stream=null),this.state=t,await this.listener.vr(e)}mo(){}auth(){this.state=1;const t=this.yo(this.no),n=this.no;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([t,e])=>{this.no===n&&this.po(t,e)},e=>{t(()=>{var t=new j(G.UNKNOWN,"Fetching auth token failed: "+e.message);return this.Io(t)})})}po(t,e){const n=this.yo(this.no);this.stream=this.Eo(t,e),this.stream.Pr(()=>{n(()=>(this.state=2,this.io=this.Sn.enqueueAfterDelay(this.Zr,1e4,()=>(this.co()&&(this.state=3),Promise.resolve())),this.listener.Pr()))}),this.stream.vr(t=>{n(()=>this.Io(t))}),this.stream.onMessage(t=>{n(()=>this.onMessage(t))})}uo(){this.state=5,this.ro.Hr(async()=>{this.state=0,this.start()})}Io(t){return M("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}yo(e){return t=>{this.Sn.enqueueAndForget(()=>this.no===e?t():(M("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class xo extends No{constructor(t,e,n,r,s,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,r,i),this.O=s}Eo(t,e){return this.eo.Ur("Listen",t,e)}onMessage(t){this.ro.reset();var e=ls(this.O,t),t=function(t){if(!("targetChange"in t))return at.min();t=t.targetChange;return(!t.targetIds||!t.targetIds.length)&&t.readTime?Zn(t.readTime):at.min()}(t);return this.listener.To(e,t)}Ao(t){const e={};e.database=os(this.O),e.addTarget=function(t,e){let n;var r=e.target;return n=oe(r)?{documents:ws(t,r)}:{query:ms(t,r)},n.targetId=e.targetId,0<e.resumeToken.approximateByteSize()?n.resumeToken=Yn(t,e.resumeToken):0<e.snapshotVersion.compareTo(at.min())&&(n.readTime=Jn(t,e.snapshotVersion.toTimestamp())),n}(this.O,t);t=ys(this.O,t);t&&(e.labels=t),this.fo(e)}Ro(t){const e={};e.database=os(this.O),e.removeTarget=t,this.fo(e)}}class ko extends No{constructor(t,e,n,r,s,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,r,i),this.O=s,this.Po=!1}get bo(){return this.Po}start(){this.Po=!1,this.lastStreamToken=void 0,super.start()}mo(){this.Po&&this.vo([])}Eo(t,e){return this.eo.Ur("Write",t,e)}onMessage(t){if(U(!!t.streamToken),this.lastStreamToken=t.streamToken,this.Po){this.ro.reset();var e=_s(t.writeResults,t.commitTime),n=Zn(t.commitTime);return this.listener.Vo(n,e)}return U(!t.writeResults||0===t.writeResults.length),this.Po=!0,this.listener.So()}Do(){const t={};t.database=os(this.O),this.fo(t)}vo(t){t={streamToken:this.lastStreamToken,writes:t.map(t=>fs(this.O,t))};this.fo(t)}}class Oo extends class{}{constructor(t,e,n,r){super(),this.authCredentials=t,this.appCheckCredentials=e,this.eo=n,this.O=r,this.Co=!1}No(){if(this.Co)throw new j(G.FAILED_PRECONDITION,"The client has already been terminated.")}Mr(n,r,s){return this.No(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([t,e])=>this.eo.Mr(n,r,s,t,e)).catch(t=>{throw"FirebaseError"===t.name?(t.code===G.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new j(G.UNKNOWN,t.toString())})}Lr(n,r,s){return this.No(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([t,e])=>this.eo.Lr(n,r,s,t,e)).catch(t=>{throw"FirebaseError"===t.name?(t.code===G.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new j(G.UNKNOWN,t.toString())})}terminate(){this.Co=!0}}class Mo{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.xo=0,this.ko=null,this.Oo=!0}Mo(){0===this.xo&&(this.$o("Unknown"),this.ko=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.ko=null,this.Fo("Backend didn't respond within 10 seconds."),this.$o("Offline"),Promise.resolve())))}Bo(t){"Online"===this.state?this.$o("Unknown"):(this.xo++,1<=this.xo&&(this.Lo(),this.Fo(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.$o("Offline")))}set(t){this.Lo(),this.xo=0,"Online"===t&&(this.Oo=!1),this.$o(t)}$o(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}Fo(t){t=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.Oo?($(t),this.Oo=!1):M("OnlineStateTracker",t)}Lo(){null!==this.ko&&(this.ko.cancel(),this.ko=null)}}class $o{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.Uo=[],this.qo=new Map,this.Ko=new Set,this.Go=[],this.jo=s,this.jo.mr(t=>{n.enqueueAndForget(async()=>{Qo(this)&&(M("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=K(t);e.Ko.add(4),await Bo(e),e.Qo.set("Unknown"),e.Ko.delete(4),await Fo(e)}(this))})}),this.Qo=new Mo(n,r)}}async function Fo(t){if(Qo(t))for(const e of t.Go)await e(!0)}async function Bo(t){for(const e of t.Go)await e(!1)}function Lo(t,e){const n=K(t);n.qo.has(e.targetId)||(n.qo.set(e.targetId,e),jo(n)?Go(n):hc(n).co()&&qo(n,e))}function Uo(t,e){const n=K(t),r=hc(n);n.qo.delete(e),r.co()&&Ko(n,e),0===n.qo.size&&(r.co()?r.ho():Qo(n)&&n.Qo.set("Unknown"))}function qo(t,e){t.Wo.Z(e.targetId),hc(t).Ao(e)}function Ko(t,e){t.Wo.Z(e),hc(t).Ro(e)}function Go(e){e.Wo=new Gn({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),Tt:t=>e.qo.get(t)||null}),hc(e).start(),e.Qo.Mo()}function jo(t){return Qo(t)&&!hc(t).oo()&&0<t.qo.size}function Qo(t){return 0===K(t).Ko.size}function Wo(t){t.Wo=void 0}async function zo(n){n.qo.forEach((t,e)=>{qo(n,t)})}async function Ho(t,e){Wo(t),jo(t)?(t.Qo.Bo(e),Go(t)):t.Qo.set("Unknown")}async function Jo(t,r,e){if(t.Qo.set("Online"),r instanceof qn&&2===r.state&&r.cause)try{await async function(t){var e=r.cause;for(const n of r.targetIds)t.qo.has(n)&&(await t.remoteSyncer.rejectListen(n,e),t.qo.delete(n),t.Wo.removeTarget(n))}(t)}catch(e){M("RemoteStore","Failed to remove targets %s: %s ",r.targetIds.join(","),e),await Yo(t,e)}else if(r instanceof Ln?t.Wo.ct(r):r instanceof Un?t.Wo._t(r):t.Wo.ht(r),!e.isEqual(at.min()))try{const r=await Kr(t.localStore);0<=e.compareTo(r)&&await function(r,s){const t=r.Wo.yt(s);return t.targetChanges.forEach((t,e)=>{if(0<t.resumeToken.approximateByteSize()){const n=r.qo.get(e);n&&r.qo.set(e,n.withResumeToken(t.resumeToken,s))}}),t.targetMismatches.forEach(t=>{const e=r.qo.get(t);e&&(r.qo.set(t,e.withResumeToken(pt.EMPTY_BYTE_STRING,e.snapshotVersion)),Ko(r,t),t=new yi(e.target,t,1,e.sequenceNumber),qo(r,t))}),r.remoteSyncer.applyRemoteEvent(t)}(t,e)}catch(r){M("RemoteStore","Failed to raise snapshot:",r),await Yo(t,r)}}async function Yo(t,e,n){if(!ui(e))throw e;t.Ko.add(1),await Bo(t),t.Qo.set("Offline"),n=n||(()=>Kr(t.localStore)),t.asyncQueue.enqueueRetryable(async()=>{M("RemoteStore","Retrying IndexedDB access"),await n(),t.Ko.delete(1),await Fo(t)})}function Xo(e,n){return n().catch(t=>Yo(e,t,n))}async function Zo(t){const e=K(t),n=lc(e);let r=0<e.Uo.length?e.Uo[e.Uo.length-1].batchId:-1;for(;tc(e);)try{const t=await Qr(e.localStore,r);if(null===t){0===e.Uo.length&&n.ho();break}r=t.batchId,ec(e,t)}catch(t){await Yo(e,t)}nc(e)&&sc(e)}function tc(t){return Qo(t)&&t.Uo.length<10}function ec(t,e){t.Uo.push(e);const n=lc(t);n.co()&&n.bo&&n.vo(e.mutations)}function nc(t){return Qo(t)&&!lc(t).oo()&&0<t.Uo.length}function sc(t){lc(t).start()}async function ic(t){lc(t).Do()}async function rc(t){const e=lc(t);for(const n of t.Uo)e.vo(n.mutations)}async function oc(t,e,n){const r=t.Uo.shift(),s=mi.from(r,e,n);await Xo(t,()=>t.remoteSyncer.applySuccessfulWrite(s)),await Zo(t)}async function cc(t,e){e&&lc(t).bo&&await async function(t,e){if(En(n=e.code)&&n!==G.ABORTED){const n=t.Uo.shift();lc(t).ao(),await Xo(t,()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e)),await Zo(t)}var n}(t,e),nc(t)&&sc(t)}async function uc(t,e){const n=K(t);n.asyncQueue.verifyOperationInProgress(),M("RemoteStore","RemoteStore received new credentials");t=Qo(n);n.Ko.add(3),await Bo(n),t&&n.Qo.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.Ko.delete(3),await Fo(n)}async function ac(t,e){const n=K(t);e?(n.Ko.delete(2),await Fo(n)):(n.Ko.add(2),await Bo(n),n.Qo.set("Unknown"))}function hc(e){return e.zo||(e.zo=function(t,e,n){const r=K(t);return r.No(),new xo(e,r.eo,r.authCredentials,r.appCheckCredentials,r.O,n)}(e.datastore,e.asyncQueue,{Pr:zo.bind(null,e),vr:Ho.bind(null,e),To:Jo.bind(null,e)}),e.Go.push(async t=>{t?(e.zo.ao(),jo(e)?Go(e):e.Qo.set("Unknown")):(await e.zo.stop(),Wo(e))})),e.zo}function lc(e){return e.Ho||(e.Ho=function(t,e,n){const r=K(t);return r.No(),new ko(e,r.eo,r.authCredentials,r.appCheckCredentials,r.O,n)}(e.datastore,e.asyncQueue,{Pr:ic.bind(null,e),vr:cc.bind(null,e),So:rc.bind(null,e),Vo:oc.bind(null,e)}),e.Go.push(async t=>{t?(e.Ho.ao(),await Zo(e)):(await e.Ho.stop(),0<e.Uo.length&&(M("RemoteStore",`Stopping write stream with ${e.Uo.length} pending writes`),e.Uo=[]))})),e.Ho}class fc{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new Q,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(t=>{})}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new fc(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new j(G.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(t=>this.deferred.resolve(t))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function dc(t,e){if($("AsyncQueue",`${e}: ${t}`),ui(t))return new j(G.UNAVAILABLE,`${e}: ${t}`);throw t}class _c{constructor(n){this.comparator=n?(t,e)=>n(t,e)||Nt.comparator(t.key,e.key):(t,e)=>Nt.comparator(t.key,e.key),this.keyedMap=Nn(),this.sortedSet=new An(this.comparator)}static emptySet(t){return new _c(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){t=this.keyedMap.get(t);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((t,e)=>(n(t),!1))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){var e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof _c))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(t,e){const n=new _c;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class wc{constructor(){this.Jo=new An(Nt.comparator)}track(t){var e=t.doc.key,n=this.Jo.get(e);!n||0!==t.type&&3===n.type?this.Jo=this.Jo.insert(e,t):3===t.type&&1!==n.type?this.Jo=this.Jo.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.Jo=this.Jo.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.Jo=this.Jo.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.Jo=this.Jo.remove(e):1===t.type&&2===n.type?this.Jo=this.Jo.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.Jo=this.Jo.insert(e,{type:2,doc:t.doc}):L()}Yo(){const n=[];return this.Jo.inorderTraversal((t,e)=>{n.push(e)}),n}}class mc{constructor(t,e,n,r,s,i,o,a){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(t,e,n,r){const s=[];return e.forEach(t=>{s.push({type:0,doc:t})}),new mc(t,e,_c.emptySet(e),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&Ne(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class gc{constructor(){this.Xo=void 0,this.listeners=[]}}class yc{constructor(){this.queries=new Er(t=>xe(t),Ne),this.onlineState="Unknown",this.Zo=new Set}}async function pc(t,e){const n=K(t),r=e.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new gc),s)try{i.Xo=await n.onListen(r)}catch(t){const n=dc(t,`Initialization of query '${ke(e.query)}' failed`);return void e.onError(n)}n.queries.set(r,i),i.listeners.push(e),e.tc(n.onlineState),!i.Xo||e.ec(i.Xo)&&Ac(n)}async function Ic(t,e){const n=K(t),r=e.query;let s=!1;const i=n.queries.get(r);if(i){const t=i.listeners.indexOf(e);0<=t&&(i.listeners.splice(t,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Ec(t,e){const n=K(t);let r=!1;for(const t of e){const e=t.query,s=n.queries.get(e);if(s){for(const e of s.listeners)e.ec(t)&&(r=!0);s.Xo=t}}r&&Ac(n)}function Tc(t,e,n){const r=K(t),s=r.queries.get(e);if(s)for(const t of s.listeners)t.onError(n);r.queries.delete(e)}function Ac(t){t.Zo.forEach(t=>{t.next()})}class Rc{constructor(t,e,n){this.query=t,this.nc=e,this.sc=!1,this.ic=null,this.onlineState="Unknown",this.options=n||{}}ec(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new mc(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0)}let e=!1;return this.sc?this.rc(t)&&(this.nc.next(t),e=!0):this.oc(t,this.onlineState)&&(this.cc(t),e=!0),this.ic=t,e}onError(t){this.nc.error(t)}tc(t){this.onlineState=t;let e=!1;return this.ic&&!this.sc&&this.oc(this.ic,t)&&(this.cc(this.ic),e=!0),e}oc(t,e){return!t.fromCache||!(this.options.uc&&"Offline"!==e||t.docs.isEmpty()&&"Offline"!==e)}rc(t){if(0<t.docChanges.length)return!0;var e=this.ic&&this.ic.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}cc(t){t=mc.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache),this.sc=!0,this.nc.next(t)}}class Pc{constructor(t,e){this.payload=t,this.byteLength=e}ac(){return"metadata"in this.payload}}class bc{constructor(t){this.O=t}Gs(t){return ss(this.O,t)}js(t){return t.metadata.exists?as(this.O,t.document,!1):Jt.newNoDocument(this.Gs(t.metadata.name),this.Qs(t.metadata.readTime))}Qs(t){return Zn(t)}}class vc{constructor(t,e,n){this.hc=t,this.localStore=e,this.O=n,this.queries=[],this.documents=[],this.progress=Vc(t)}lc(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;return t.payload.namedQuery?this.queries.push(t.payload.namedQuery):t.payload.documentMetadata?(this.documents.push({metadata:t.payload.documentMetadata}),t.payload.documentMetadata.exists||++e):t.payload.document&&(this.documents[this.documents.length-1].document=t.payload.document,++e),e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}fc(t){const e=new Map,n=new bc(this.O);for(const s of t)if(s.metadata.queries){const t=n.Gs(s.metadata.name);for(const n of s.metadata.queries){var r=(e.get(n)||On()).add(t);e.set(n,r)}}return e}async complete(){const t=await Zr(this.localStore,new bc(this.O),this.documents,this.hc.id),e=this.fc(this.documents);for(const t of this.queries)await to(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",new Or(Object.assign({},this.progress),t)}}function Vc(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class Sc{constructor(t){this.key=t}}class Dc{constructor(t){this.key=t}}class Cc{constructor(t,e){this.query=t,this.dc=e,this._c=null,this.current=!1,this.wc=On(),this.mutatedKeys=On(),this.mc=Me(t),this.gc=new _c(this.mc)}get yc(){return this.dc}Ic(t,e){const a=e?e.Ec:new wc,c=(e||this).gc;let u=(e||this).mutatedKeys,h=c,l=!1;const d=Re(this.query)&&c.size===this.query.limit?c.last():null,f=Pe(this.query)&&c.size===this.query.limit?c.first():null;if(t.inorderTraversal((t,e)=>{const n=c.get(t),r=Oe(this.query,e)?e:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let o=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(a.track({type:3,doc:r}),o=!0):this.Tc(n,r)||(a.track({type:2,doc:r}),o=!0,(d&&0<this.mc(r,d)||f&&this.mc(r,f)<0)&&(l=!0)):!n&&r?(a.track({type:0,doc:r}),o=!0):n&&!r&&(a.track({type:1,doc:n}),o=!0,(d||f)&&(l=!0)),o&&(u=r?(h=h.add(r),i?u.add(t):u.delete(t)):(h=h.delete(t),u.delete(t)))}),Re(this.query)||Pe(this.query))for(;h.size>this.query.limit;){const t=Re(this.query)?h.last():h.first();h=h.delete(t.key),u=u.delete(t.key),a.track({type:1,doc:t})}return{gc:h,Ec:a,ks:l,mutatedKeys:u}}Tc(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n){var r=this.gc;this.gc=t.gc,this.mutatedKeys=t.mutatedKeys;const s=t.Ec.Yo();s.sort((t,e)=>function(t,e){var n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return L()}};return n(t)-n(e)}(t.type,e.type)||this.mc(t.doc,e.doc)),this.Ac(n);var i=e?this.Rc():[],n=0===this.wc.size&&this.current?1:0,e=n!==this._c;return this._c=n,0!==s.length||e?{snapshot:new mc(this.query,t.gc,r,s,t.mutatedKeys,0==n,e,!1),Pc:i}:{Pc:i}}tc(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({gc:this.gc,Ec:new wc,mutatedKeys:this.mutatedKeys,ks:!1},!1)):{Pc:[]}}bc(t){return!this.dc.has(t)&&!!this.gc.has(t)&&!this.gc.get(t).hasLocalMutations}Ac(t){t&&(t.addedDocuments.forEach(t=>this.dc=this.dc.add(t)),t.modifiedDocuments.forEach(t=>{}),t.removedDocuments.forEach(t=>this.dc=this.dc.delete(t)),this.current=t.current)}Rc(){if(!this.current)return[];const e=this.wc;this.wc=On(),this.gc.forEach(t=>{this.bc(t.key)&&(this.wc=this.wc.add(t.key))});const n=[];return e.forEach(t=>{this.wc.has(t)||n.push(new Dc(t))}),this.wc.forEach(t=>{e.has(t)||n.push(new Sc(t))}),n}vc(t){this.dc=t.Ks,this.wc=On();t=this.Ic(t.documents);return this.applyChanges(t,!0)}Vc(){return mc.fromInitialDocuments(this.query,this.gc,this.mutatedKeys,0===this._c)}}class Nc{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class xc{constructor(t){this.key=t,this.Sc=!1}}class kc{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Dc={},this.Cc=new Er(t=>xe(t),Ne),this.Nc=new Map,this.xc=new Set,this.kc=new An(Nt.comparator),this.Oc=new Map,this.Mc=new so,this.$c={},this.Fc=new Map,this.Bc=ar.Je(),this.onlineState="Unknown",this.Lc=void 0}get isPrimaryClient(){return!0===this.Lc}}async function Oc(t,e){const n=hu(t);let r,s;const i=n.Cc.get(e);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Vc();else{const t=await Wr(n.localStore,De(e));n.isPrimaryClient&&Lo(n.remoteStore,t);const i=n.sharedClientState.addLocalQueryTarget(t.targetId);r=t.targetId,s=await Mc(n,e,r,"current"===i)}return s}async function Mc(n,t,e,r){n.Uc=(t,s,e)=>async function(t,e,n){let r=e.view.Ic(s);r.ks&&(r=await Hr(t.localStore,e.query,!1).then(({documents:t})=>e.view.Ic(t,r)));n=n&&n.targetChanges.get(e.targetId),n=e.view.applyChanges(r,t.isPrimaryClient,n);return Hc(t,e.targetId,n.Pc),n.snapshot}(n,t,e);const s=await Hr(n.localStore,t,!0),i=new Cc(t,s.Ks),o=i.Ic(s.documents),a=Bn.createSynthesizedTargetChangeForCurrentChange(e,r&&"Offline"!==n.onlineState),c=i.applyChanges(o,n.isPrimaryClient,a);Hc(n,e,c.Pc);r=new Nc(t,e,i);return n.Cc.set(t,r),n.Nc.has(e)?n.Nc.get(e).push(t):n.Nc.set(e,[t]),c.snapshot}async function $c(t,e){const n=K(t),r=n.Cc.get(e),s=n.Nc.get(r.targetId);if(1<s.length)return n.Nc.set(r.targetId,s.filter(t=>!Ne(t,e))),void n.Cc.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await zr(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),Uo(n.remoteStore,r.targetId),Wc(n,r.targetId)}).catch(_r)):(Wc(n,r.targetId),await zr(n.localStore,r.targetId,!0))}async function Fc(t,e,n){const r=lu(t);try{const t=await function(t,r){const s=K(t),i=ut.now(),e=r.reduce((t,e)=>t.add(e.key),On());let o;return s.persistence.runTransaction("Locally write mutations","readwrite",n=>s.Us.Es(n,e).next(t=>{o=t;const e=[];for(const n of r){const r=un(n,o.get(n.key));null!=r&&e.push(new fn(n.key,r,Ht(r.value.mapValue),nn.exists(!0)))}return s.gs.addMutationBatch(n,i,e,r)})).then(t=>(t.applyToLocalDocumentSet(o),{batchId:t.batchId,changes:o}))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.$c[t.currentUser.toKey()];r=r||new An(rt),r=r.insert(e,n),t.$c[t.currentUser.toKey()]=r}(r,t.batchId,n),await Xc(r,t.changes),await Zo(r.remoteStore)}catch(t){const e=dc(t,"Failed to persist write");n.reject(e)}}async function Bc(t,e){const r=K(t);try{const t=await Gr(r.localStore,e);e.targetChanges.forEach((t,e)=>{const n=r.Oc.get(e);n&&(U(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),0<t.addedDocuments.size?n.Sc=!0:0<t.modifiedDocuments.size?U(n.Sc):0<t.removedDocuments.size&&(U(n.Sc),n.Sc=!1))}),await Xc(r,t,e)}catch(t){await _r(t)}}function Lc(n,r,t){const e=K(n);if(e.isPrimaryClient&&0===t||!e.isPrimaryClient&&1===t){const n=[];e.Cc.forEach((t,e)=>{e=e.view.tc(r);e.snapshot&&n.push(e.snapshot)}),function(t,n){const e=K(t);e.onlineState=n;let r=!1;e.queries.forEach((t,e)=>{for(const t of e.listeners)t.tc(n)&&(r=!0)}),r&&Ac(e)}(e.eventManager,r),n.length&&e.Dc.To(n),e.onlineState=r,e.isPrimaryClient&&e.sharedClientState.setOnlineState(r)}}async function Uc(t,e,n){const r=K(t);r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.Oc.get(e),i=s&&s.key;if(i){let t=new An(Nt.comparator);t=t.insert(i,Jt.newNoDocument(i,at.min()));const n=On().add(i),s=new Fn(at.min(),new Map,new bn(rt),t,n);await Bc(r,s),r.kc=r.kc.remove(i),r.Oc.delete(e),Yc(r)}else await zr(r.localStore,e,!1).then(()=>Wc(r,e,n)).catch(_r)}async function qc(t,e){const n=K(t),r=e.batch.batchId;try{const t=await qr(n.localStore,e);Qc(n,r,null),jc(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Xc(n,t)}catch(t){await _r(t)}}async function Kc(t,e,n){const r=K(t);try{const t=await function(t,r){const s=K(t);return s.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return s.gs.lookupMutationBatch(e,r).next(t=>(U(null!==t),n=t.keys(),s.gs.removeMutationBatch(e,t))).next(()=>s.gs.performConsistencyCheck(e)).next(()=>s.Us.Es(e,n))})}(r.localStore,e);Qc(r,e,n),jc(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await Xc(r,t)}catch(n){await _r(n)}}async function Gc(t,e){const n=K(t);Qo(n.remoteStore)||M("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(){const e=K(n.localStore);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",t=>e.gs.getHighestUnacknowledgedBatchId(t))}();if(-1===t)return void e.resolve();const r=n.Fc.get(t)||[];r.push(e),n.Fc.set(t,r)}catch(t){const n=dc(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}function jc(t,e){(t.Fc.get(e)||[]).forEach(t=>{t.resolve()}),t.Fc.delete(e)}function Qc(t,e,n){const r=K(t);let s=r.$c[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.$c[r.currentUser.toKey()]=s}}function Wc(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.Nc.get(t))e.Cc.delete(r),n&&e.Dc.qc(r,n);e.Nc.delete(t),e.isPrimaryClient&&e.Mc.si(t).forEach(t=>{e.Mc.containsKey(t)||zc(e,t)})}function zc(t,e){t.xc.delete(e.path.canonicalString());var n=t.kc.get(e);null!==n&&(Uo(t.remoteStore,n),t.kc=t.kc.remove(e),t.Oc.delete(n),Yc(t))}function Hc(t,e,n){for(const r of n)r instanceof Sc?(t.Mc.addReference(r.key,e),Jc(t,r)):r instanceof Dc?(M("SyncEngine","Document no longer in limbo: "+r.key),t.Mc.removeReference(r.key,e),t.Mc.containsKey(r.key)||zc(t,r.key)):L()}function Jc(t,e){const n=e.key,r=n.path.canonicalString();t.kc.get(n)||t.xc.has(r)||(M("SyncEngine","New document in limbo: "+n),t.xc.add(r),Yc(t))}function Yc(t){for(;0<t.xc.size&&t.kc.size<t.maxConcurrentLimboResolutions;){var e=t.xc.values().next().value;t.xc.delete(e);var n=new Nt(_t.fromString(e)),e=t.Bc.next();t.Oc.set(e,new xc(n)),t.kc=t.kc.insert(n,e),Lo(t.remoteStore,new yi(De(Ae(n.path)),e,2,nt.A))}}async function Xc(t,n,r){const s=K(t),i=[],o=[],a=[];s.Cc.isEmpty()||(s.Cc.forEach((t,e)=>{a.push(s.Uc(e,n,r).then(t=>{t&&(s.isPrimaryClient&&s.sharedClientState.updateQueryState(e.targetId,t.fromCache?"not-current":"current"),i.push(t),t=$r.Ss(e.targetId,t),o.push(t))}))}),await Promise.all(a),s.Dc.To(i),await async function(t,e){const r=K(t);try{await r.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>si.forEach(e,e=>si.forEach(e.vs,t=>r.persistence.referenceDelegate.addReference(n,e.targetId,t)).next(()=>si.forEach(e.Vs,t=>r.persistence.referenceDelegate.removeReference(n,e.targetId,t)))))}catch(t){if(!ui(t))throw t;M("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=r.Ms.get(e),n=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(n);r.Ms=r.Ms.insert(e,s)}}}(s.localStore,o))}async function Zc(t,e){const n=K(t);if(!n.currentUser.isEqual(e)){M("SyncEngine","User change. New user:",e.toKey());const r=await Ur(n.localStore,e);n.currentUser=e,(t=n).Fc.forEach(t=>{t.forEach(t=>{t.reject(new j(G.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),t.Fc.clear(),n.sharedClientState.handleUserChange(e,r.removedBatchIds,r.addedBatchIds),await Xc(n,r.qs)}}function tu(t,e){const n=K(t),r=n.Oc.get(e);if(r&&r.Sc)return On().add(r.key);{let t=On();const r=n.Nc.get(e);if(!r)return t;for(const e of r){const r=n.Cc.get(e);t=t.unionWith(r.view.yc)}return t}}async function eu(t,e){var n=K(t),t=await Hr(n.localStore,e.query,!0),t=e.view.vc(t);return n.isPrimaryClient&&Hc(n,e.targetId,t.Pc),t}async function nu(t){const e=K(t);return Yr(e.localStore).then(t=>Xc(e,t))}async function su(t,e,n,r){var s=K(t),t=await function(t,n){const r=K(t),s=K(r.gs);return r.persistence.runTransaction("Lookup mutation documents","readonly",e=>s.Ge(e,n).next(t=>t?r.Us.Es(e,t):si.resolve(null)))}(s.localStore,e);null!==t?("pending"===n?await Zo(s.remoteStore):"acknowledged"===n||"rejected"===n?(Qc(s,e,r||null),jc(s,e),n=s.localStore,r=e,K(K(n).gs).Qe(r)):L(),await Xc(s,t)):M("SyncEngine","Cannot apply mutation batch with id: "+e)}async function iu(r,t){const s=K(r);if(hu(s),lu(s),!0===t&&!0!==s.Lc){const r=s.sharedClientState.getAllActiveQueryTargets(),t=await ru(s,r.toArray());s.Lc=!0,await ac(s.remoteStore,!0);for(const r of t)Lo(s.remoteStore,r)}else if(!1===t&&!1!==s.Lc){const r=[];let n=Promise.resolve();s.Nc.forEach((t,e)=>{s.sharedClientState.isLocalQueryTarget(e)?r.push(e):n=n.then(()=>(Wc(s,e),zr(s.localStore,e,!0))),Uo(s.remoteStore,e)}),await n,await ru(s,r),function(){const n=K(s);n.Oc.forEach((t,e)=>{Uo(n.remoteStore,e)}),n.Mc.ii(),n.Oc=new Map,n.kc=new An(Nt.comparator)}(),s.Lc=!1,await ac(s.remoteStore,!1)}}async function ru(e,n,r){const s=K(e),i=[],o=[];for(const e of n){let t;const r=s.Nc.get(e);if(r&&0!==r.length){t=await Wr(s.localStore,De(r[0]));for(const e of r){const n=s.Cc.get(e),r=await eu(s,n);r.snapshot&&o.push(r.snapshot)}}else{const r=await Jr(s.localStore,e);t=await Wr(s.localStore,r),await Mc(s,ou(r),e,!1)}i.push(t)}return s.Dc.To(o),i}function ou(t){return Te(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function cu(t){t=K(t);return K(K(t.localStore).persistence).ds()}async function uu(t,e,n,r){const s=K(t);if(s.Lc)M("SyncEngine","Ignoring unexpected query state notification.");else if(s.Nc.has(e))switch(n){case"current":case"not-current":{const t=await Yr(s.localStore),r=Fn.createSynthesizedRemoteEventForCurrentChange(e,"current"===n);await Xc(s,t,r);break}case"rejected":await zr(s.localStore,e,!0),Wc(s,e,r);break;default:L()}}async function au(t,e,n){const r=hu(t);if(r.Lc){for(const t of e)if(r.Nc.has(t))M("SyncEngine","Adding an already active target "+t);else{const e=await Jr(r.localStore,t),n=await Wr(r.localStore,e);await Mc(r,ou(e),n.targetId,!1),Lo(r.remoteStore,n)}for(const t of n)r.Nc.has(t)&&await zr(r.localStore,t,!1).then(()=>{Uo(r.remoteStore,t),Wc(r,t)}).catch(_r)}}function hu(t){const e=K(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=Bc.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=tu.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Uc.bind(null,e),e.Dc.To=Ec.bind(null,e.eventManager),e.Dc.qc=Tc.bind(null,e.eventManager),e}function lu(t){const e=K(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=qc.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Kc.bind(null,e),e}function fu(t,e,n){const r=K(t);!async function(e,n,r){try{var s=await n.getMetadata();if(await function(t,e){const n=K(t),r=Zn(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",t=>n.Kn.getBundleMetadata(t,e.id)).then(t=>!!t&&0<=t.createTime.compareTo(r))}(e.localStore,s))return await n.close(),void r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes});r._updateProgress(Vc(s));const o=new vc(s,e.localStore,n.O);let t=await n.Kc();for(;t;){const e=await o.lc(t);e&&r._updateProgress(e),t=await n.Kc()}var i=await o.complete();await Xc(e,i.ws,void 0),await function(t,e){const n=K(t);return n.persistence.runTransaction("Save bundle","readwrite",t=>n.Kn.saveBundleMetadata(t,e))}(e.localStore,s),r._completeWith(i.progress)}catch(e){F("SyncEngine",`Loading bundle failed with ${e}`),r._failWith(e)}}(r,e,n).then(()=>{r.sharedClientState.notifyBundleLoaded()})}class du{constructor(){this.synchronizeTabs=!1}async initialize(t){this.O=Do(t.databaseInfo.databaseId),this.sharedClientState=this.Gc(t),this.persistence=this.jc(t),await this.persistence.start(),this.gcScheduler=this.Qc(t),this.localStore=this.Wc(t)}Qc(t){return null}Wc(t){return Lr(this.persistence,new Fr,t.initialUser,this.O)}jc(t){return new ao(lo.bi,this.O)}Gc(t){return new To}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class _u extends du{constructor(t,e,n){super(),this.zc=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await Xr(this.localStore),await this.zc.initialize(this,t),await lu(this.zc.syncEngine),await Zo(this.zc.remoteStore),await this.persistence.Hn(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(this.localStore),Promise.resolve()))}Wc(t){return Lr(this.persistence,new Fr,t.initialUser,this.O)}Qc(t){var e=this.persistence.referenceDelegate.garbageCollector;return new gr(e,t.asyncQueue)}jc(t){var e=kr(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?er.withCacheSize(this.cacheSizeBytes):er.DEFAULT;return new Cr(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Vo(),So(),this.O,this.sharedClientState,!!this.forceOwnership)}Gc(t){return new To}}class wu extends _u{constructor(t,e){super(t,e,!1),this.zc=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);t=this.zc.syncEngine;this.sharedClientState instanceof Eo&&(this.sharedClientState.syncEngine={hr:su.bind(null,t),lr:uu.bind(null,t),dr:au.bind(null,t),ds:cu.bind(null,t),ar:nu.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Hn(async t=>{await iu(this.zc.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start(this.localStore):t||this.gcScheduler.stop())})}Gc(t){var e=Vo();if(!Eo.Vt(e))throw new j(G.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=kr(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Eo(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class mu{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Lc(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=Zc.bind(null,this.syncEngine),await ac(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new yc}createDatastore(t){var e,n=Do(t.databaseInfo.databaseId),r=(e=t.databaseInfo,new vo(e));return e=t.authCredentials,t=t.appCheckCredentials,r=r,n=n,new Oo(e,t,r,n)}createRemoteStore(t){return e=this.localStore,n=this.datastore,r=t.asyncQueue,s=t=>Lc(this.syncEngine,t,0),t=new(Ro.Vt()?Ro:Ao),new $o(e,n,r,s,t);var e,n,r,s}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new kc(t,e,n,r,s,i);return o&&(a.Lc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}terminate(){return async function(t){const e=K(t);M("RemoteStore","RemoteStore shutting down."),e.Ko.add(5),await Bo(e),e.jo.shutdown(),e.Qo.set("Unknown")}(this.remoteStore)}}function gu(e,n=10240){let r=0;return{async read(){if(r<e.byteLength){var t={value:e.slice(r,r+n),done:!1};return r+=n,t}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class yu{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Hc(this.observer.next,t)}error(t){this.observer.error?this.Hc(this.observer.error,t):console.error("Uncaught Error in snapshot listener:",t)}Jc(){this.muted=!0}Hc(t,e){this.muted||setTimeout(()=>{this.muted||t(e)},0)}}class pu{constructor(t,e){this.Yc=t,this.O=e,this.metadata=new Q,this.buffer=new Uint8Array,this.Xc=new TextDecoder("utf-8"),this.Zc().then(t=>{t&&t.ac()?this.metadata.resolve(t.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.payload)}`))},t=>this.metadata.reject(t))}close(){return this.Yc.cancel()}async getMetadata(){return this.metadata.promise}async Kc(){return await this.getMetadata(),this.Zc()}async Zc(){var t=await this.tu();if(null===t)return null;var e=this.Xc.decode(t),n=Number(e);isNaN(n)&&this.eu(`length string (${e}) is not valid number`);e=await this.nu(n);return new Pc(JSON.parse(e),t.length+n)}su(){return this.buffer.findIndex(t=>t==="{".charCodeAt(0))}async tu(){for(;this.su()<0&&!await this.iu(););if(0===this.buffer.length)return null;var t=this.su();t<0&&this.eu("Reached the end of bundle when a length string is expected.");var e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async nu(t){for(;this.buffer.length<t;)await this.iu()&&this.eu("Reached the end of bundle when more is expected.");var e=this.Xc.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}eu(t){throw this.Yc.cancel(),new Error(`Invalid bundle format: ${t}`)}async iu(){var t=await this.Yc.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class Iu{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new j(G.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const e=await async function(t,e){const n=K(t),r=os(n.O)+"/documents",s={documents:e.map(t=>ns(n.O,t))},i=await n.Lr("BatchGetDocuments",r,s),o=new Map;i.forEach(t=>{const e=hs(n.O,t);o.set(e.key.toString(),e)});const a=[];return e.forEach(t=>{t=o.get(t.toString());U(!!t),a.push(t)}),a}(this.datastore,t);return e.forEach(t=>this.recordVersion(t)),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastWriteError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new mn(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((t,e)=>{e=Nt.fromPath(e);this.mutations.push(new gn(e,this.precondition(e)))}),await async function(t,e){const n=K(t),r=os(n.O)+"/documents",s={writes:e.map(t=>fs(n.O,t))};await n.Mr("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw L();e=at.min()}var n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new j(G.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){var e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?nn.updateTime(e):nn.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(this.writtenDocs.has(t.toString())||!e)return nn.exists(!0);if(e.isEqual(at.min()))throw new j(G.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return nn.updateTime(e)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class Eu{constructor(t,e,n,r){this.asyncQueue=t,this.datastore=e,this.updateFunction=n,this.deferred=r,this.ru=5,this.ro=new Co(this.asyncQueue,"transaction_retry")}run(){--this.ru,this.ou()}ou(){this.ro.Hr(async()=>{const e=new Iu(this.datastore),t=this.cu(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(t=>{this.uu(t)}))}).catch(t=>{this.uu(t)})})}cu(t){try{var e=this.updateFunction(t);return!St(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}uu(t){0<this.ru&&this.au(t)?(--this.ru,this.asyncQueue.enqueueAndForget(()=>(this.ou(),Promise.resolve()))):this.deferred.reject(t)}au(t){if("FirebaseError"!==t.name)return!1;t=t.code;return"aborted"===t||"failed-precondition"===t||!En(t)}}class Tu{constructor(t,e,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=r,this.user=C.UNAUTHENTICATED,this.clientId=it.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async t=>{M("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t}),this.appCheckCredentials.start(n,t=>(M("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new j(G.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new Q;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(t){var e=dc(t,"Failed to shutdown persistence");n.reject(e)}}),n.promise}}async function Au(t,e){t.asyncQueue.verifyOperationInProgress(),M("FirestoreClient","Initializing OfflineComponentProvider");var n=await t.getConfiguration();await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener(async t=>{r.isEqual(t)||(await Ur(e.localStore,t),r=t)}),e.persistence.setDatabaseDeletedListener(()=>t.terminate()),t.offlineComponents=e}async function Ru(t,n){t.asyncQueue.verifyOperationInProgress();var e=await Pu(t);M("FirestoreClient","Initializing OnlineComponentProvider");var r=await t.getConfiguration();await n.initialize(e,r),t.setCredentialChangeListener(t=>uc(n.remoteStore,t)),t.setAppCheckTokenChangeListener((t,e)=>uc(n.remoteStore,e)),t.onlineComponents=n}async function Pu(t){return t.offlineComponents||(M("FirestoreClient","Using default OfflineComponentProvider"),await Au(t,new du)),t.offlineComponents}async function bu(t){return t.onlineComponents||(M("FirestoreClient","Using default OnlineComponentProvider"),await Ru(t,new mu)),t.onlineComponents}function vu(t){return Pu(t).then(t=>t.persistence)}function Vu(t){return Pu(t).then(t=>t.localStore)}function Su(t){return bu(t).then(t=>t.remoteStore)}function Du(t){return bu(t).then(t=>t.syncEngine)}async function Cu(t){const e=await bu(t),n=e.eventManager;return n.onListen=Oc.bind(null,e.syncEngine),n.onUnlisten=$c.bind(null,e.syncEngine),n}function Nu(n){return n.asyncQueue.enqueue(async()=>{const t=await vu(n),e=await Su(n);return t.setNetworkEnabled(!0),function(){const t=K(e);return t.Ko.delete(0),Fo(t)}()})}function xu(n){return n.asyncQueue.enqueue(async()=>{const t=await vu(n),e=await Su(n);return t.setNetworkEnabled(!1),async function(){const t=K(e);t.Ko.add(0),await Bo(t),t.Qo.set("Offline")}()})}function ku(t,e){const n=new Q;return t.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){try{const r=await function(e){const n=K(t);return n.persistence.runTransaction("read document","readonly",t=>n.Us.ys(t,e))}(e);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new j(G.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){e=dc(t,`Failed to get document '${e} from cache`);n.reject(e)}}(await Vu(t),e,n)),n.promise}function Ou(t,e,n={}){const r=new Q;return t.asyncQueue.enqueueAndForget(async()=>function(n,r,s,i,o){const t=new yu({next:t=>{r.enqueueAndForget(()=>Ic(n,a));var e=t.docs.has(s);!e&&t.fromCache?o.reject(new j(G.UNAVAILABLE,"Failed to get document because the client is offline.")):e&&t.fromCache&&i&&"server"===i.source?o.reject(new j(G.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):o.resolve(t)},error:t=>o.reject(t)}),a=new Rc(Ae(s.path),t,{includeMetadataChanges:!0,uc:!0});return pc(n,a)}(await Cu(t),t.asyncQueue,e,n,r)),r.promise}function Mu(t,e){const n=new Q;return t.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){try{const r=await Hr(t,e,!0),s=new Cc(e,r.Ks),i=s.Ic(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){e=dc(t,`Failed to execute query '${e} against cache`);n.reject(e)}}(await Vu(t),e,n)),n.promise}function $u(t,e,n={}){const r=new Q;return t.asyncQueue.enqueueAndForget(async()=>function(e,n,t,r,s){const i=new yu({next:t=>{n.enqueueAndForget(()=>Ic(e,o)),t.fromCache&&"server"===r.source?s.reject(new j(G.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(t)},error:t=>s.reject(t)}),o=new Rc(t,i,{includeMetadataChanges:!0,uc:!0});return pc(e,o)}(await Cu(t),t.asyncQueue,e,n,r)),r.promise}function Fu(t,e){const n=new yu(e);return t.asyncQueue.enqueueAndForget(async()=>function(t,e){K(t).Zo.add(e),e.next()}(await Cu(t),n)),()=>{n.Jc(),t.asyncQueue.enqueueAndForget(async()=>function(t,e){K(t).Zo.delete(e)}(await Cu(t),n))}}function Bu(e,n){const r=new Q;return e.asyncQueue.enqueueAndForget(async()=>{var t=await bu(e).then(t=>t.datastore);new Eu(e.asyncQueue,t,n,r).run()}),r.promise}function Lu(t,e,n,r){const s=function(t,e){t="string"==typeof t?(new TextEncoder).encode(t):t;return t=function(t){if(t instanceof Uint8Array)return gu(t,void 0);if(t instanceof ArrayBuffer)return gu(new Uint8Array(t),void 0);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(t),e=e,new pu(t,e)}(n,Do(e));t.asyncQueue.enqueueAndForget(async()=>{fu(await Du(t),s,r)})}function Uu(t,e){return t.asyncQueue.enqueue(async()=>function(t,e){const n=K(t);return n.persistence.runTransaction("Get named query","readonly",t=>n.Kn.getNamedQuery(t,e))}(await Vu(t),e))}const qu=new Map;function Ku(t,e,n){if(!n)throw new j(G.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function Gu(t,e,n,r){if(!0===e&&!0===r)throw new j(G.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function ju(t){if(!Nt.isDocumentKey(t))throw new j(G.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Qu(t){if(Nt.isDocumentKey(t))throw new j(G.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Wu(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return 20<t.length&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"!=typeof t)return"function"==typeof t?"a function":L();if(t instanceof Array)return"an array";t=(t=t).constructor?t.constructor.name:null;return t?`a custom ${t} object`:"an object"}function zu(t,e){if((t="_delegate"in t?t._delegate:t)instanceof e)return t;if(e.name===t.constructor.name)throw new j(G.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");t=Wu(t);throw new j(G.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}function Hu(t,e){if(e<=0)throw new j(G.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class Ju{constructor(t){var e;if(void 0===t.host){if(void 0!==t.ssl)throw new j(G.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new j(G.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.useFetchStreams=!!t.useFetchStreams,Gu("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling)}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Yu{constructor(t,e,n){this._authCredentials=e,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Ju({}),this._settingsFrozen=!1,t instanceof Vt?this._databaseId=t:(this._app=t,this._databaseId=function(t){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new j(G.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Vt(t.options.projectId)}(t))}get app(){if(!this._app)throw new j(G.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new j(G.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Ju(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new z;switch(t.type){case"gapi":var e=t.client;return U(!("object"!=typeof e||null===e||!e.auth||!e.auth.getAuthHeaderValueForFirstParty)),new X(e,t.sessionIndex||"0",t.iamToken||null);case"provider":return t.client;default:throw new j(G.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=qu.get(t);e&&(M("ComponentProvider","Removing Datastore"),qu.delete(t),e.terminate())}(this),Promise.resolve()}}function Xu(n,t,r,s={}){const i=(n=zu(n,Yu))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==t&&F("Host has been set in both settings() and useEmulator(), emulator host will be used"),n._setSettings(Object.assign(Object.assign({},i),{host:`${t}:${r}`,ssl:!1})),s.mockUserToken){let t,e;if("string"==typeof s.mockUserToken)t=s.mockUserToken,e=C.MOCK_USER;else{t=createMockUserToken(s.mockUserToken,null===(r=n._app)||void 0===r?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new j(G.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");e=new C(i)}n._authCredentials=new H(new W(t,e))}}class Zu{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new ea(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new Zu(this.firestore,t,this._key)}}class ta{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new ta(this.firestore,t,this._query)}}class ea extends ta{constructor(t,e,n){super(t,e,Ae(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new Zu(this.firestore,null,new Nt(t))}withConverter(t){return new ea(this.firestore,t,this._path)}}function na(t,e,...n){if(t=getModularInstance(t),Ku("collection","path",e),t instanceof Yu){var r=_t.fromString(e,...n);return Qu(r),new ea(t,null,r)}if(!(t instanceof Zu||t instanceof ea))throw new j(G.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");n=t._path.child(_t.fromString(e,...n));return Qu(n),new ea(t.firestore,null,n)}function sa(t,e){if(t=zu(t,Yu),Ku("collectionGroup","collection id",e),0<=e.indexOf("/"))throw new j(G.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new ta(t,null,(e=e,new Ee(_t.emptyPath(),e)))}function ia(t,e,...n){if(t=getModularInstance(t),Ku("doc","path",e=1===arguments.length?it.R():e),t instanceof Yu){var r=_t.fromString(e,...n);return ju(r),new Zu(t,null,new Nt(r))}if(!(t instanceof Zu||t instanceof ea))throw new j(G.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");r=t._path.child(_t.fromString(e,...n));return ju(r),new Zu(t.firestore,t instanceof ea?t.converter:null,new Nt(r))}function ra(t,e){return t=getModularInstance(t),e=getModularInstance(e),(t instanceof Zu||t instanceof ea)&&(e instanceof Zu||e instanceof ea)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function oa(t,e){return t=getModularInstance(t),e=getModularInstance(e),t instanceof ta&&e instanceof ta&&t.firestore===e.firestore&&Ne(t._query,e._query)&&t.converter===e.converter}class ca{constructor(){this.hu=Promise.resolve(),this.lu=[],this.fu=!1,this.du=[],this._u=null,this.wu=!1,this.mu=!1,this.gu=[],this.ro=new Co(this,"async_queue_retry"),this.yu=()=>{var t=So();t&&M("AsyncQueue","Visibility state changed to "+t.visibilityState),this.ro.Yr()};const t=So();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.yu)}get isShuttingDown(){return this.fu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.pu(),this.Iu(t)}enterRestrictedMode(t){if(!this.fu){this.fu=!0,this.mu=t||!1;const e=So();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this.yu)}}enqueue(t){if(this.pu(),this.fu)return new Promise(()=>{});const e=new Q;return this.Iu(()=>this.fu&&this.mu?Promise.resolve():(t().then(e.resolve,e.reject),e.promise)).then(()=>e.promise)}enqueueRetryable(t){this.enqueueAndForget(()=>(this.lu.push(t),this.Eu()))}async Eu(){if(0!==this.lu.length){try{await this.lu[0](),this.lu.shift(),this.ro.reset()}catch(t){if(!ui(t))throw t;M("AsyncQueue","Operation failed with retryable error: "+t)}0<this.lu.length&&this.ro.Hr(()=>this.Eu())}}Iu(t){var e=this.hu.then(()=>(this.wu=!0,t().catch(t=>{throw this._u=t,this.wu=!1,$("INTERNAL UNHANDLED ERROR: ",function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t)),t}).then(t=>(this.wu=!1,t))));return this.hu=e}enqueueAfterDelay(t,e,n){this.pu(),-1<this.gu.indexOf(t)&&(e=0);n=fc.createAndSchedule(this,t,e,n,t=>this.Tu(t));return this.du.push(n),n}pu(){this._u&&L()}verifyOperationInProgress(){}async Au(){for(var t;await(t=this.hu),t!==this.hu;);}Ru(t){for(const e of this.du)if(e.timerId===t)return!0;return!1}Pu(e){return this.Au().then(()=>{this.du.sort((t,e)=>t.targetTimeMs-e.targetTimeMs);for(const t of this.du)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Au()})}bu(t){this.gu.push(t)}Tu(t){t=this.du.indexOf(t);this.du.splice(t,1)}}function ua(t){return function(t){if("object"!=typeof t||null===t)return!1;var e=t;for(const t of["next","error","complete"])if(t in e&&"function"==typeof e[t])return!0;return!1}(t)}class aa{constructor(){this._progressObserver={},this._taskCompletionResolver=new Q,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const ha=-1;class la extends Yu{constructor(t,e,n){super(t,e,n),this.type="firestore",this._queue=new ca,this._persistenceKey="name"in t?t.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||wa(this),this._firestoreClient.terminate()}}function fa(t,e){const n=_getProvider(t,"firestore");if(n.isInitialized()){const t=n.getImmediate(),r=n.getOptions();if(deepEqual(r,e))return t;throw new j(G.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new j(G.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return n.initialize({options:e})}function da(t=getApp()){return _getProvider(t,"firestore").getImmediate()}function _a(t){return t._firestoreClient||wa(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function wa(t){var e,n,r,s=t._freezeSettings(),s=(e=t._databaseId,n=(null===(r=t._app)||void 0===r?void 0:r.options.appId)||"",r=t._persistenceKey,s=s,new vt(e,n,r,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,s.useFetchStreams));t._firestoreClient=new Tu(t._authCredentials,t._appCheckCredentials,t._queue,s)}function ma(t,e){ba(t=zu(t,la));var n=_a(t),r=t._freezeSettings(),t=new mu;return ya(n,t,new _u(t,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function ga(t){ba(t=zu(t,la));var e=_a(t),n=t._freezeSettings(),t=new mu;return ya(e,t,new wu(t,n.cacheSizeBytes))}function ya(t,n,r){const s=new Q;return t.asyncQueue.enqueue(async()=>{try{await Au(t,r),await Ru(t,n),s.resolve()}catch(t){if(!("FirebaseError"===(e=t).name?e.code===G.FAILED_PRECONDITION||e.code===G.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)))throw t;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+t),s.reject(t)}var e}).then(()=>s.promise)}function pa(t){if(t._initialized&&!t._terminated)throw new j(G.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new Q;return t._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(t){if(!ri.Vt())return Promise.resolve();t+="main";await ri.delete(t)}(kr(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}}),e.promise}function Ia(t){return function(t){const e=new Q;return t.asyncQueue.enqueueAndForget(async()=>Gc(await Du(t),e)),e.promise}(_a(t=zu(t,la)))}function Ea(t){return Nu(_a(t=zu(t,la)))}function Ta(t){return xu(_a(t=zu(t,la)))}function Aa(t){return _removeServiceInstance(t.app,"firestore"),t._delete()}function Ra(t,e){var n=_a(t=zu(t,la)),r=new aa;return Lu(n,t._databaseId,e,r),r}function Pa(e,t){return Uu(_a(e=zu(e,la)),t).then(t=>t?new ta(e,null,t.query):null)}function ba(t){if(t._initialized||t._terminated)throw new j(G.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class va{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new j(G.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new mt(e)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function Va(){return new va("__name__")}class Sa{constructor(t){this._byteString=t}static fromBase64String(t){try{return new Sa(pt.fromBase64String(t))}catch(t){throw new j(G.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new Sa(pt.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class Da{constructor(t){this._methodName=t}}class Ca{constructor(t,e){if(!isFinite(t)||t<-90||90<t)throw new j(G.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||180<e)throw new j(G.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return rt(this._lat,t._lat)||rt(this._long,t._long)}}const Na=/^__.*__$/;class xa{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new fn(t,this.data,this.fieldMask,e,this.fieldTransforms):new ln(t,this.data,e,this.fieldTransforms)}}class ka{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new fn(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function Oa(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw L()}}class Ma{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.O=n,this.ignoreUndefinedProperties=r,void 0===s&&this.vu(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Vu(){return this.settings.Vu}Su(t){return new Ma(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.O,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Du(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Su({path:n,Cu:!1});return r.Nu(t),r}xu(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Su({path:n,Cu:!1});return r.vu(),r}ku(t){return this.Su({path:void 0,Cu:!0})}Ou(t){return nh(t,this.settings.methodName,this.settings.Mu||!1,this.path,this.settings.$u)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}vu(){if(this.path)for(let t=0;t<this.path.length;t++)this.Nu(this.path.get(t))}Nu(t){if(0===t.length)throw this.Ou("Document fields must not be empty");if(Oa(this.Vu)&&Na.test(t))throw this.Ou('Document fields cannot begin and end with "__"')}}class $a{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.O=n||Do(t)}Fu(t,e,n,r=!1){return new Ma({Vu:t,methodName:e,$u:n,path:mt.emptyPath(),Cu:!1,Mu:r},this.databaseId,this.O,this.ignoreUndefinedProperties)}}function Fa(t){var e=t._freezeSettings(),n=Do(t._databaseId);return new $a(t._databaseId,!!e.ignoreUndefinedProperties,n)}function Ba(t,e,n,r,s,i={}){const o=t.Fu(i.merge||i.mergeFields?2:0,e,n,s);Xa("Data must be an object, but it was:",o,r);r=Ja(r,o);let a,c;if(i.merge)a=new gt(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const u of i.mergeFields){const s=Za(e,u,n);if(!o.contains(s))throw new j(G.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);sh(t,s)||t.push(s)}a=new gt(t),c=o.fieldTransforms.filter(t=>a.covers(t.field))}else a=null,c=o.fieldTransforms;return new xa(new zt(r),a,c)}class La extends Da{_toFieldTransform(t){if(2!==t.Vu)throw 1===t.Vu?t.Ou(`${this._methodName}() can only appear at the top level of your update data`):t.Ou(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof La}}function Ua(t,e,n){return new Ma({Vu:3,$u:e.settings.$u,methodName:t._methodName,Cu:n},e.databaseId,e.O,e.ignoreUndefinedProperties)}class qa extends Da{_toFieldTransform(t){return new Ze(t.path,new je)}isEqual(t){return t instanceof qa}}class Ka extends Da{constructor(t,e){super(t),this.Bu=e}_toFieldTransform(t){const e=Ua(this,t,!0),n=this.Bu.map(t=>Ha(t,e)),r=new Qe(n);return new Ze(t.path,r)}isEqual(t){return this===t}}class Ga extends Da{constructor(t,e){super(t),this.Bu=e}_toFieldTransform(t){const e=Ua(this,t,!0),n=this.Bu.map(t=>Ha(t,e)),r=new ze(n);return new Ze(t.path,r)}isEqual(t){return this===t}}class ja extends Da{constructor(t,e){super(t),this.Lu=e}_toFieldTransform(t){var e=new Je(t.O,Le(t.O,this.Lu));return new Ze(t.path,e)}isEqual(t){return this===t}}function Qa(t,s,i,e){const o=t.Fu(1,s,i);Xa("Data must be an object, but it was:",o,e);const a=[],c=zt.empty();lt(e,(t,e)=>{var n=eh(s,t,i);e=getModularInstance(e);t=o.xu(n);if(e instanceof La)a.push(n);else{const r=Ha(e,t);null!=r&&(a.push(n),c.set(n,r))}});e=new gt(a);return new ka(c,e,o.fieldTransforms)}function Wa(e,n,t,r,s,i){const o=e.Fu(1,n,t),a=[Za(n,r,t)],c=[s];if(i.length%2!=0)throw new j(G.INVALID_ARGUMENT,`Function ${n}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)a.push(Za(n,i[t])),c.push(i[t+1]);const u=[],h=zt.empty();for(let t=a.length-1;0<=t;--t)if(!sh(u,a[t])){const n=a[t];var l=getModularInstance(l=c[t]);const r=o.xu(n);if(l instanceof La)u.push(n);else{const e=Ha(l,r);null!=e&&(u.push(n),h.set(n,e))}}s=new gt(u);return new ka(h,s,o.fieldTransforms)}function za(t,e,n,r=!1){return Ha(n,t.Fu(r?4:3,e))}function Ha(i,t){if(Ya(i=getModularInstance(i)))return Xa("Unsupported field value:",t,i),Ja(i,t);if(i instanceof Da)return function(t,e){if(!Oa(e.Vu))throw e.Ou(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.Ou(`${t._methodName}() is not currently supported inside arrays`);t=t._toFieldTransform(e);t&&e.fieldTransforms.push(t)}(i,t),null;if(void 0===i&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),i instanceof Array){if(t.settings.Cu&&4!==t.Vu)throw t.Ou("Nested arrays are not supported");return function(e){const n=[];let r=0;for(const s of i){let t=Ha(s,e.ku(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t)}return function(t,e){if(null===(t=getModularInstance(i)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return Le(e.O,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){var n=ut.fromDate(t);return{timestampValue:Jn(e.O,n)}}if(t instanceof ut){n=new ut(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:Jn(e.O,n)}}if(t instanceof Ca)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof Sa)return{bytesValue:Yn(e.O,t._byteString)};if(t instanceof Zu){const r=e.databaseId,s=t.firestore._databaseId;if(!s.isEqual(r))throw e.Ou(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${r.projectId}/${r.database}`);return{referenceValue:ts(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.Ou(`Unsupported field value: ${Wu(t)}`)}(0,t)}function Ja(t,n){const r={};return ft(t)?n.path&&0<n.path.length&&n.fieldMask.push(n.path):lt(t,(t,e)=>{e=Ha(e,n.Du(t));null!=e&&(r[t]=e)}),{mapValue:{fields:r}}}function Ya(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof ut||t instanceof Ca||t instanceof Sa||t instanceof Zu||t instanceof Da)}function Xa(t,e,n){if(!Ya(n)||("object"!=typeof(r=n)||null===r||Object.getPrototypeOf(r)!==Object.prototype&&null!==Object.getPrototypeOf(r))){n=Wu(n);throw"an object"===n?e.Ou(t+" a custom object"):e.Ou(t+" "+n)}var r}function Za(t,e,n){if((e=getModularInstance(e))instanceof va)return e._internalPath;if("string"==typeof e)return eh(t,e);throw nh("Field path arguments must be of type string or ",t,!1,void 0,n)}const th=new RegExp("[~\\*/\\[\\]]");function eh(e,n,r){if(0<=n.search(th))throw nh(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,r);try{return new va(...n.split("."))._internalPath}catch(t){throw nh(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,r)}}function nh(t,e,n,r,s){var i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${r}`),o&&(c+=` in document ${s}`),c+=")"),new j(G.INVALID_ARGUMENT,a+t+c)}function sh(t,e){return t.some(t=>t.isEqual(e))}class ih{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Zu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var t=new rh(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){t=this._document.data.field(oh("DocumentSnapshot.get",t));if(null!==t)return this._userDataWriter.convertValue(t)}}}class rh extends ih{data(){return super.data()}}function oh(t,e){return"string"==typeof e?eh(t,e):(e instanceof va?e:e._delegate)._internalPath}class ch{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class uh extends ih{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){var e=new ah(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){t=this._document.data.field(oh("DocumentSnapshot.get",t));if(null!==t)return this._userDataWriter.convertValue(t,e.serverTimestamps)}}}class ah extends uh{data(t={}){return super.data(t)}}class hh{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new ch(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,n){this._snapshot.docs.forEach(t=>{e.call(n,new ah(this._firestore,this._userDataWriter,t.key,t,new ch(this._snapshot.mutatedKeys.has(t.key),this._snapshot.fromCache),this.query.converter))})}docChanges(t={}){t=!!t.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new j(G.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(i,e){if(i._snapshot.oldDocs.isEmpty()){let e=0;return i._snapshot.docChanges.map(t=>({type:"added",doc:new ah(i._firestore,i._userDataWriter,t.doc.key,t.doc,new ch(i._snapshot.mutatedKeys.has(t.doc.key),i._snapshot.fromCache),i.query.converter),oldIndex:-1,newIndex:e++}))}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(t=>e||3!==t.type).map(t=>{var e=new ah(i._firestore,i._userDataWriter,t.doc.key,t.doc,new ch(i._snapshot.mutatedKeys.has(t.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==t.type&&(n=s.indexOf(t.doc.key),s=s.delete(t.doc.key)),1!==t.type&&(s=s.add(t.doc),r=s.indexOf(t.doc.key)),{type:lh(t.type),doc:e,oldIndex:n,newIndex:r}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function lh(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return L()}}function fh(t,e){return t instanceof uh&&e instanceof uh?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof hh&&e instanceof hh&&t._firestore===e._firestore&&oa(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function dh(t){if(Pe(t)&&0===t.explicitOrderBy.length)throw new j(G.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class _h{}function wh(t,...e){for(const n of e)t=n._apply(t);return t}class mh extends _h{constructor(t,e,n){super(),this.Uu=t,this.qu=e,this.Ku=n,this.type="where"}_apply(t){var e=Fa(t.firestore),e=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new j(G.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Ch(o,i);const e=[];for(const n of o)e.push(Dh(r,t,n));a={arrayValue:{values:e}}}else a=Dh(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Ch(o,i),a=za(n,e,o,"in"===i||"not-in"===i);i=ce.create(s,i,a);return function(t,e){if(e.S()){const r=ve(t);if(null!==r&&!r.isEqual(e.field))throw new j(G.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${e.field.toString()}'`);var n=be(t);null!==n&&Nh(t,e.field,n)}const r=function(t,e){for(const n of t.filters)if(0<=e.indexOf(n.op))return n.op;return null}(t,function(){switch(e.op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===e.op?new j(G.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new j(G.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${r.toString()}' filters.`)}(t,i),i}(t._query,"where",e,t.firestore._databaseId,this.Uu,this.qu,this.Ku);return new ta(t.firestore,t.converter,(t=t._query,e=t.filters.concat([e]),new Ee(t.path,t.collectionGroup,t.explicitOrderBy.slice(),e,t.limit,t.limitType,t.startAt,t.endAt)))}}function gh(t,e,n){t=oh("where",t);return new mh(t,e,n)}class yh extends _h{constructor(t,e){super(),this.Uu=t,this.Gu=e,this.type="orderBy"}_apply(t){var e=function(t,e,n){if(null!==t.startAt)throw new j(G.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new j(G.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r=new ge(e,n);return e=r,null!==be(n=t)||null!==(t=ve(n))&&Nh(n,t,e.field),r}(t._query,this.Uu,this.Gu);return new ta(t.firestore,t.converter,(t=t._query,e=t.explicitOrderBy.concat([e]),new Ee(t.path,t.collectionGroup,e,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)))}}function ph(t,e="asc"){t=oh("orderBy",t);return new yh(t,e)}class Ih extends _h{constructor(t,e,n){super(),this.type=t,this.ju=e,this.Qu=n}_apply(t){return new ta(t.firestore,t.converter,Ce(t._query,this.ju,this.Qu))}}function Eh(t){return Hu("limit",t),new Ih("limit",t,"F")}function Th(t){return Hu("limitToLast",t),new Ih("limitToLast",t,"L")}class Ah extends _h{constructor(t,e,n){super(),this.type=t,this.Wu=e,this.zu=n}_apply(t){var e=Sh(t,this.type,this.Wu,this.zu);return new ta(t.firestore,t.converter,(t=t._query,e=e,new Ee(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}function Rh(...t){return new Ah("startAt",t,!0)}function Ph(...t){return new Ah("startAfter",t,!1)}class bh extends _h{constructor(t,e,n){super(),this.type=t,this.Wu=e,this.zu=n}_apply(t){var e=Sh(t,this.type,this.Wu,this.zu);return new ta(t.firestore,t.converter,(t=t._query,e=e,new Ee(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function vh(...t){return new bh("endBefore",t,!1)}function Vh(...t){return new bh("endAt",t,!0)}function Sh(t,e,n,r){if(n[0]=getModularInstance(n[0]),n[0]instanceof ih)return function(t,e,n,r,s){if(!r)throw new j(G.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of Se(t))if(n.field.isKeyField())i.push(Ut(e,r.key));else{const t=r.data.field(n.field);if(Rt(t))throw new j(G.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new j(G.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new me(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);var s=Fa(t.firestore);return function(e,n,r,s,i,t){const o=e.explicitOrderBy;if(i.length>o.length)throw new j(G.INVALID_ARGUMENT,`Too many arguments provided to ${s}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let t=0;t<i.length;t++){const c=i[t];if(o[t].field.isKeyField()){if("string"!=typeof c)throw new j(G.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${s}(), but got a ${typeof c}`);if(!Ve(e)&&-1!==c.indexOf("/"))throw new j(G.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${s}() must be a plain document ID, but '${c}' contains a slash.`);const r=e.path.child(_t.fromString(c));if(!Nt.isDocumentKey(r))throw new j(G.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${s}() must result in a valid document path, but '${r}' is not because it contains an odd number of segments.`);const i=new Nt(r);a.push(Ut(n,i))}else{const e=za(r,s,c);a.push(e)}}return new me(a,t)}(t._query,t.firestore._databaseId,s,e,n,r)}function Dh(t,e,n){if("string"==typeof(n=getModularInstance(n))){if(""===n)throw new j(G.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Ve(e)&&-1!==n.indexOf("/"))throw new j(G.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);e=e.path.child(_t.fromString(n));if(!Nt.isDocumentKey(e))throw new j(G.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${e}' is not because it has an odd number of segments (${e.length}).`);return Ut(t,new Nt(e))}if(n instanceof Zu)return Ut(t,n._key);throw new j(G.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Wu(n)}.`)}function Ch(t,e){if(!Array.isArray(t)||0===t.length)throw new j(G.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`);if(10<t.length)throw new j(G.INVALID_ARGUMENT,`Invalid Query. '${e.toString()}' filters support a maximum of 10 elements in the value array.`)}function Nh(t,e,n){if(!n.isEqual(e))throw new j(G.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${e.toString()}' and so you must also use '${e.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class xh{convertValue(t,e="none"){switch(kt(t)){case 0:return null;case 1:return t.booleanValue;case 2:return Tt(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(At(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw L()}}convertObject(t,n){const r={};return lt(t.fields,(t,e)=>{r[t]=this.convertValue(e,n)}),r}convertGeoPoint(t){return new Ca(Tt(t.latitude),Tt(t.longitude))}convertArray(t,e){return(t.values||[]).map(t=>this.convertValue(t,e))}convertServerTimestamp(t,e){switch(e){case"previous":var n=Pt(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp(bt(t));default:return null}}convertTimestamp(t){t=Et(t);return new ut(t.seconds,t.nanos)}convertDocumentKey(t,e){const n=_t.fromString(t);U(vs(n));const r=new Vt(n.get(1),n.get(3)),s=new Nt(n.popFirst(5));return r.isEqual(e)||$(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function kh(t,e,n){return t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e}class Oh extends xh{constructor(t){super(),this.firestore=t}convertBytes(t){return new Sa(t)}convertReference(t){t=this.convertDocumentKey(t,this.firestore._databaseId);return new Zu(this.firestore,null,t)}}class Mh{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=Fa(t)}set(t,e,n){this._verifyNotCommitted();const r=$h(t,this._firestore),s=kh(r.converter,e,n),i=Ba(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,nn.none())),this}update(t,e,n,...r){this._verifyNotCommitted();t=$h(t,this._firestore);let s;return s="string"==typeof(e=getModularInstance(e))||e instanceof va?Wa(this._dataReader,"WriteBatch.update",t._key,e,n,r):Qa(this._dataReader,"WriteBatch.update",t._key,e),this._mutations.push(s.toMutation(t._key,nn.exists(!0))),this}delete(t){this._verifyNotCommitted();t=$h(t,this._firestore);return this._mutations=this._mutations.concat(new mn(t._key,nn.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new j(G.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function $h(t,e){if((t=getModularInstance(t)).firestore!==e)throw new j(G.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}function Fh(e){e=zu(e,Zu);const n=zu(e.firestore,la);return Ou(_a(n),e._key).then(t=>Xh(n,e,t))}class Bh extends xh{constructor(t){super(),this.firestore=t}convertBytes(t){return new Sa(t)}convertReference(t){t=this.convertDocumentKey(t,this.firestore._databaseId);return new Zu(this.firestore,null,t)}}function Lh(e){e=zu(e,Zu);const n=zu(e.firestore,la),t=_a(n),r=new Bh(n);return ku(t,e._key).then(t=>new uh(n,r,e._key,t,new ch(null!==t&&t.hasLocalMutations,!0),e.converter))}function Uh(e){e=zu(e,Zu);const n=zu(e.firestore,la);return Ou(_a(n),e._key,{source:"server"}).then(t=>Xh(n,e,t))}function qh(e){e=zu(e,ta);const n=zu(e.firestore,la),t=_a(n),r=new Bh(n);return dh(e._query),$u(t,e._query).then(t=>new hh(n,r,e,t))}function Kh(e){e=zu(e,ta);const n=zu(e.firestore,la),t=_a(n),r=new Bh(n);return Mu(t,e._query).then(t=>new hh(n,r,e,t))}function Gh(e){e=zu(e,ta);const n=zu(e.firestore,la),t=_a(n),r=new Bh(n);return $u(t,e._query,{source:"server"}).then(t=>new hh(n,r,e,t))}function jh(t,e,n){t=zu(t,Zu);var r=zu(t.firestore,la),e=kh(t.converter,e,n);return Yh(r,[Ba(Fa(r),"setDoc",t._key,e,null!==t.converter,n).toMutation(t._key,nn.none())])}function Qh(t,e,n,...r){t=zu(t,Zu);var s=zu(t.firestore,la),i=Fa(s);let o;return o="string"==typeof(e=getModularInstance(e))||e instanceof va?Wa(i,"updateDoc",t._key,e,n,r):Qa(i,"updateDoc",t._key,e),Yh(s,[o.toMutation(t._key,nn.exists(!0))])}function Wh(t){return Yh(zu(t.firestore,la),[new mn(t._key,nn.none())])}function zh(t,e){const n=zu(t.firestore,la),r=ia(t),s=kh(t.converter,e);return Yh(n,[Ba(Fa(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,nn.exists(!1))]).then(()=>r)}function Hh(e,...n){var t;e=getModularInstance(e);let r={includeMetadataChanges:!1},s=0;"object"!=typeof n[s]||ua(n[s])||(r=n[s],s++);var i={includeMetadataChanges:r.includeMetadataChanges};if(ua(n[s])){const e=n[s];n[s]=null===(t=e.next)||void 0===t?void 0:t.bind(e),n[s+1]=null===(t=e.error)||void 0===t?void 0:t.bind(e),n[s+2]=null===(t=e.complete)||void 0===t?void 0:t.bind(e)}let o,a,c;if(e instanceof Zu)a=zu(e.firestore,la),c=Ae(e._key.path),o={next:t=>{n[s]&&n[s](Xh(a,e,t))},error:n[s+1],complete:n[s+2]};else{const u=zu(e,ta);a=zu(u.firestore,la),c=u._query;const h=new Bh(a);o={next:t=>{n[s]&&n[s](new hh(a,h,u,t))},error:n[s+1],complete:n[s+2]},dh(e._query)}return function(t,e,n,r){const s=new yu(r),i=new Rc(e,s,n);return t.asyncQueue.enqueueAndForget(async()=>pc(await Cu(t),i)),()=>{s.Jc(),t.asyncQueue.enqueueAndForget(async()=>Ic(await Cu(t),i))}}(_a(a),c,i,o)}function Jh(t,e){return Fu(_a(t=zu(t,la)),ua(e)?e:{next:e})}function Yh(t,e){return function(t,e){const n=new Q;return t.asyncQueue.enqueueAndForget(async()=>Fc(await Du(t),e,n)),n.promise}(_a(t),e)}function Xh(t,e,n){var r=n.docs.get(e._key),s=new Bh(t);return new uh(t,s,e._key,r,new ch(n.hasPendingWrites,n.fromCache),e.converter)}class Zh extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=Fa(t)}get(t){const n=$h(t,this._firestore),r=new Oh(this._firestore);return this._transaction.lookup([n._key]).then(t=>{if(!t||1!==t.length)return L();const e=t[0];if(e.isFoundDocument())return new ih(this._firestore,r,e.key,e,n.converter);if(e.isNoDocument())return new ih(this._firestore,r,n._key,null,n.converter);throw L()})}set(t,e,n){t=$h(t,this._firestore),e=kh(t.converter,e,n),n=Ba(this._dataReader,"Transaction.set",t._key,e,null!==t.converter,n);return this._transaction.set(t._key,n),this}update(t,e,n,...r){t=$h(t,this._firestore),e="string"==typeof(e=getModularInstance(e))||e instanceof va?Wa(this._dataReader,"Transaction.update",t._key,e,n,r):Qa(this._dataReader,"Transaction.update",t._key,e);return this._transaction.update(t._key,e),this}delete(t){t=$h(t,this._firestore);return this._transaction.delete(t._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=$h(t,this._firestore),n=new Bh(this._firestore);return super.get(t).then(t=>new uh(this._firestore,n,e._key,t._document,new ch(!1,!1),e.converter))}}function tl(e,n){return Bu(_a(e=zu(e,la)),t=>n(new Zh(e,t)))}function el(){return new La("deleteField")}function nl(){return new qa("serverTimestamp")}function sl(...t){return new Ka("arrayUnion",t)}function il(...t){return new Ga("arrayRemove",t)}function rl(t){return new ja("increment",t)}function ol(e){return _a(e=zu(e,la)),new Mh(e,t=>Yh(e,t))}function cl(t,e){_a(t=zu(t,la));const n="string"==typeof e?function(t){try{return JSON.parse(t)}catch(t){throw new j(G.INVALID_ARGUMENT,"Failed to parse JSON:"+t.message)}}(e):e,r=[];if(Array.isArray(n.indexes))for(const t of n.indexes){const e=ul(t,"collectionGroup"),n=[];if(Array.isArray(t.fields))for(const e of t.fields){const t=eh("setIndexConfiguration",ul(e,"fieldPath"));"CONTAINS"===e.arrayConfig?n.push(new Xt(t,2)):"ASCENDING"===e.order?n.push(new Xt(t,0)):"DESCENDING"===e.order&&n.push(new Xt(t,1))}r.push(new Yt(Yt.UNKNOWN_ID,e,n,Zt.empty()))}return Promise.resolve()}function ul(t,e){if("string"!=typeof t[e])throw new j(G.INVALID_ARGUMENT,"Missing string value for: "+e);return t[e]}!function(){var t;t=SDK_VERSION,N=t,_registerComponent(new Component("firestore",(t,{options:e})=>{const n=t.getProvider("app").getImmediate(),r=new la(n,new J(t.getProvider("auth-internal")),new tt(t.getProvider("app-check-internal")));return e=Object.assign({useFetchStreams:!0},e),r._setSettings(e),r},"PUBLIC")),registerVersion(D,"3.4.5",void 0),registerVersion(D,"3.4.5","esm2017")}();export{xh as AbstractUserDataWriter,Sa as Bytes,ha as CACHE_SIZE_UNLIMITED,ea as CollectionReference,Zu as DocumentReference,uh as DocumentSnapshot,va as FieldPath,Da as FieldValue,la as Firestore,j as FirestoreError,Ca as GeoPoint,aa as LoadBundleTask,ta as Query,_h as QueryConstraint,ah as QueryDocumentSnapshot,hh as QuerySnapshot,ch as SnapshotMetadata,ut as Timestamp,Zh as Transaction,Mh as WriteBatch,Vt as _DatabaseId,Nt as _DocumentKey,et as _EmptyAppCheckTokenProvider,z as _EmptyAuthCredentialsProvider,mt as _FieldPath,zu as _cast,q as _debugAssert,yt as _isBase64Available,F as _logWarn,cl as _setIndexConfiguration,Gu as _validateIsNotUsedTogether,zh as addDoc,il as arrayRemove,sl as arrayUnion,pa as clearIndexedDbPersistence,na as collection,sa as collectionGroup,Xu as connectFirestoreEmulator,Wh as deleteDoc,el as deleteField,Ta as disableNetwork,ia as doc,Va as documentId,ma as enableIndexedDbPersistence,ga as enableMultiTabIndexedDbPersistence,Ea as enableNetwork,Vh as endAt,vh as endBefore,_a as ensureFirestoreConfigured,Yh as executeWrite,Fh as getDoc,Lh as getDocFromCache,Uh as getDocFromServer,qh as getDocs,Kh as getDocsFromCache,Gh as getDocsFromServer,da as getFirestore,rl as increment,fa as initializeFirestore,Eh as limit,Th as limitToLast,Ra as loadBundle,Pa as namedQuery,Hh as onSnapshot,Jh as onSnapshotsInSync,ph as orderBy,wh as query,oa as queryEqual,ra as refEqual,tl as runTransaction,nl as serverTimestamp,jh as setDoc,O as setLogLevel,fh as snapshotEqual,Ph as startAfter,Rh as startAt,Aa as terminate,Qh as updateDoc,Ia as waitForPendingWrites,gh as where,ol as writeBatch};